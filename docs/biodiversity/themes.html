

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Map Viewer - themes</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="./static/fonts/custom-icons.css">
    <style>
        body, html {
            margin: 0;
            padding: 0;
            height: 100%;
            overflow: hidden;
            font-family: Arial, sans-serif;
        }

        /* Toggle Info Button */
        .toggle-info-btn {
          background: white;
          border: 1px solid #e2e8f0;
          border-radius: 8px;
          padding: 10px 16px;
          margin-left: 10px;
          cursor: pointer;
          display: flex;
          align-items: center;
          gap: 8px;
          font-size: 0.95em;
          color: #2d3748;
          transition: all 0.2s ease;
        }
        .toggle-info-btn:hover {
          border-color: #4CAF50;
          background-color: #f8fafc;
          color: #4CAF50;
        }
        .toggle-info-btn i {
          font-size: 1.1em;
        }
        
        /* Two column section with transition */
        .three-column-section {
          transition: all 0.3s ease;
          position: relative;
          z-index: 1;
          height: auto;
          overflow: visible;
        }
        
        .three-column-section.hidden {
          height: 0;
          opacity: 0;
          visibility: hidden;
          margin: 0;
          padding: 0;
          transform: none;
        }
        
        /* Map container adjustments */
        .map-container {
          transition: all 0.3s ease;
          position: relative;
          z-index: 2;
        }
        
        .three-column-section:not(.hidden) + .map-container {
          margin-top: 20px;
        }
        /* ===== Dropdown Styles ===== */
        .dropdown {
            position: relative;
            display: flex;
            flex-direction: column;
            margin-right: 15px;
            min-width: 200px;
        }

        .dropdown p {
            margin: 0 0 5px 0;
            white-space: nowrap;
            font-size: 12px;
            color: #4a5568;
            font-weight: 500;
        }

        /* Dropdown Toggle Button */
        .dropdown-toggle {
            background-color: #ffffff;
            color: #2c3e50;
            padding: 10px 16px;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            cursor: pointer;
            min-width: 220px;
            text-align: left;
            font-size: 15px;
            font-weight: 500;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.2s ease;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            user-select: none;
        }
        /* Dropdown Menu */
        .dropdown-menu {
            display: none;
            position: absolute;
            top: 100%;
            left: 0;
            background-color: white;
            min-width: 240px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.12);
            border-radius: 8px;
            z-index: 1000;
            max-height: 400px;
            overflow-y: auto;
            margin-top: 4px;
            border: 1px solid #e9ecef;
            opacity: 0;
            transform: translateY(10px);
            transition: opacity 0.15s ease, transform 0.15s ease;
            pointer-events: none;
        }

        .dropdown.active .dropdown-menu {
            display: block;
            opacity: 1;
            transform: translateY(0);
            pointer-events: auto;
        }

        /* Dropdown Menu Items */
        .dropdown-menu a {
            color: #2c3e50;
            padding: 10px 16px;
            text-decoration: none;
            display: block;
            border-bottom: 1px solid #f1f3f5;
            transition: all 0.15s ease;
            font-size: 14px;
        }

        .dropdown-menu a:hover,
        .dropdown-menu a:focus {
            background-color: #f8f9fa;
            color: #4CAF50;
        }

        .dropdown-menu a.active {
            background-color: #e8f5e9;
            color: #2e7d32;
            font-weight: 500;
            border-left: 3px solid #4CAF50;
        }

        /* Dropdown Submenu */
        .dropdown-submenu > .dropdown-submenu-content {
            display: none;
            position: absolute;
            left: 100%;
            top: 0;
            min-width: 200px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.12);
            z-index: 1001;
        }

        .dropdown-submenu:hover > .dropdown-submenu-content {
            display: block;
        }

        .dropdown-item i {
            width: 20px;
            margin-right: 10px;
            color: #4CAF50;
            text-align: center;
        }

        .dropdown-item i.fa-chevron-right {
            margin-left: auto;
            font-size: 12px;
            color: #a0aec0;
        }
        /* Toggle Switch Component */
        .toggle-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-left: auto;
            gap: 4px;
            margin-right: 20px;
            box-sizing: border-box;
        }

        .toggle-wrapper {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .toggle-label {
            font-size: 14px;
            font-weight: 500;
            color: #64748b;
            transition: all 0.2s ease;
            line-height: 1;
        }

        .toggle-label.active {
            color: #166534;
        }

        .time-series-note {
            color: #6b7280;
            font-size: 12px;
            margin: 0 0 8px 0;
            text-align: center;
            font-style: italic;
            opacity: 0.8;
            order: -1;
            width: 100%;
        }

        /* Modern Toggle Switch */
        .toggle-switch {
            --toggle-width: 48px;
            --toggle-height: 24px;
            --toggle-handle-size: 20px;
            --toggle-padding: 2px;
            --toggle-transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);

            position: relative;
            display: inline-block;
            width: var(--toggle-width);
            height: var(--toggle-height);
            margin: 0;
            vertical-align: middle;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
            position: absolute;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #e2e8f0;
            transition: var(--toggle-transition);
            border-radius: 34px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: var(--toggle-handle-size);
            width: var(--toggle-handle-size);
            left: var(--toggle-padding);
            bottom: var(--toggle-padding);
            background-color: white;
            transition: var(--toggle-transition);
            border-radius: 50%;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }
        .toggle-switch input:checked + .toggle-slider {
            background-color: #4CAF50;
        }
        .toggle-switch input:checked + .toggle-slider:before {
            transform: translateX(calc(var(--toggle-width) - var(--toggle-handle-size) - (2 * var(--toggle-padding))));
        }
        .toggle-switch input:focus + .toggle-slider {
            box-shadow: 0 0 0 3px rgba(76, 175, 80, 0.2);
        }

        .toolbar-top {
            display: flex;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 20px;
            padding: 15px 20px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.05);
            background-color: #ffffff;
            border-radius: 20px;
        }

        /* ===== Info Box Components ===== */

        /* Two Column Section Styling */
        .three-column-section {
            display: flex;
            align-items: stretch;
            margin-bottom: 20px;
            gap: 15px;
            border-radius: 20px;
            min-height: 0;
            height: auto;
        }
        .column-left, .column-middle, .column-right {
            flex: 1;
            min-width: 0;
            min-height: 100%;
            display: flex;
            flex-direction: column;
            background: white;
            border-radius: 20px;
            padding: 15px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.05);
            box-sizing: border-box;
        }
        body, html {
            margin: 0;
            padding: 0;
            height: 100%;
            overflow: hidden;
            font-family: Arial, sans-serif;
        }

        /* Container Styles */
        .indicator-info,
        .theme-info,
        .subtheme-info {
            display: flex;
            gap: 10px;
            align-items: center;
            width: 100%;
            padding: 0;
            margin: 0;
            min-height: 2.5em;
            position: relative;
            padding-top: 15px;
        }
        
        .info-box-title {
            position: absolute;
            top: -5px;
            left: 0px;
            font-size: 11px;
            font-weight: 600;
            color: #6b7280;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .indicator-meta-head {
          margin-top: 10px; /* needed to override the h2 styles */
          font-size: 11px;
          font-weight: 600;
          color: #6b7280;
          text-transform: uppercase;
          letter-spacing: 0.5px;
        }

        .indicator-meta-body {
          margin-top: 10px; /* needed to override the h2 styles */
          font-size: 11px;
          color: #6b7280;
          text-transform: uppercase;
          letter-spacing: 0.5px;
        }

        /* Icon Base Styles */
        .indicator-icon,
        .theme-icon,
        .subtheme-icon {
            font-size: 3.5em;
            color: #4CAF50;
            margin: 5px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            opacity: 0.9;
            flex-shrink: 0;
            line-height: 1;
        }

        /* Nested Icons */
        .indicator-icon i,
        .theme-icon i {
            font-size: 1em;
            line-height: inherit;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Hover Effects */
        .indicator-info:hover .indicator-icon,
        .theme-info:hover .theme-icon {
            opacity: 1;
            transform: translateY(-1px);
        }

        /* Text Content */
        .text-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            padding: 0;
            min-width: 0;
        }

        /* Title Styles */
        .indicator-title,
        .theme-title,
        .subtheme-title {
            margin: 0; /* needed to override the h2 styles */
            color: #1a365d;
            font-size: 1.5em;
            font-weight: 600;
            line-height: 1.3;
        }
        /* Description Styles */
        .indicator-description,
        .theme-description,
        .subtheme-description {
            margin: 0;
            color: #4a5568;
            line-height: 1.6;
            font-size: 0.9em;
            max-width: 100%;
        }
        .map-container {
            position: relative;
            width: 100%;
            height: 100%;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        
        .loading-spinner {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.9);
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 100;
            border-radius: 8px;
        }
        
        .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid #4CAF50;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .map-placeholder {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            margin-top: 150px;
            color: #4a5568;
            width: 100%;
            height: 100%;
        }

        .placeholder-content {
            max-width: 500px;
            margin: 0 auto;
        }

        .placeholder-content i {
            font-size: 3em;
            color: #4CAF50;
            margin-bottom: 1.5rem;
        }

        .placeholder-content h3 {
            color: #2d3748;
            margin-bottom: 1rem;
            font-size: 1.5rem;
            font-weight: 600;
        }

        .placeholder-content p {
            color: #718096;
            line-height: 1.6;
            margin: 0;
        }
        .map-iframe {
            width: 100%;
            height: 100%;
            border: none;
            display: none;
        }
        .map-iframe.active {
            display: block;
        }
        body, html {
            margin: 0;
            padding: 0;
            height: 100%;
            overflow: hidden;
            font-family: Arial, sans-serif;
        }

        /* Dropdown Styling */
        .dropdown-toggle {
            background-color: #ffffff;
            color: #2c3e50;
            padding: 10px 16px;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            cursor: pointer;
            min-width: 220px;
            text-align: left;
            font-size: 15px;
            font-weight: 500;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.2s ease;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            user-select: none;
        }
        .dropdown-toggle:focus {
            outline: none;
            border-color: #4CAF50;
            box-shadow: 0 0 0 2px rgba(76, 175, 80, 0.2);
        }
        .dropdown-toggle i {
            margin-left: 12px;
            font-size: 12px;
            transition: transform 0.2s ease;
        }
        .dropdown.active .dropdown-toggle i {
            transform: rotate(180deg);
        }
        .dropdown-menu {
            display: none;
            position: absolute;
            background-color: white;
            min-width: 240px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.12);
            border-radius: 8px;
            z-index: 1000;
            max-height: 400px;
            overflow-y: auto;
            margin-top: 4px;
            border: 1px solid #e9ecef;
        }
        .dropdown.active .dropdown-menu {
            display: block;
        }

        /* iFrame Styling */
        .map-iframe {
            width: 100%;
            height: 100%;
            border: none;
            display: none;
        }
        .map-iframe.active {
            display: block;
        }


        /* Remove duplicate dropdown styles */
        .dropdown-toggle {
            background-color: #ffffff;
            color: #2c3e50;
            padding: 10px 16px;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            cursor: pointer;
            width: 100%;
            text-align: left;
            font-size: 15px;
            font-weight: 500;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.2s ease;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            user-select: none;
            box-sizing: border-box;
        }
        .dropdown-toggle:hover {
            border-color: #4CAF50;
            background-color: #f8fafc;
        }
        .dropdown-toggle:focus {
            outline: none;
            border-color: #4CAF50;
            box-shadow: 0 0 0 2px rgba(76, 175, 80, 0.2);
        }
        .dropdown-toggle i {
            margin-left: 12px;
            font-size: 12px;
            transition: transform 0.2s ease;
        }
        .dropdown.active .dropdown-toggle i {
            transform: rotate(180deg);
        }
        .dropdown-menu {
            display: none;
            position: absolute;
            background-color: white;
            min-width: 240px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.12);
            border-radius: 8px;
            z-index: 1000;
            max-height: 400px;
            overflow-y: auto;
            margin-top: 4px;
            border: 1px solid #e9ecef;
            opacity: 0;
            transform: translateY(-10px);
            transition: opacity 0.15s ease-out, transform 0.15s ease-out;
            pointer-events: none;
            left: 0;
            top: 100%;
        }

        .dropdown.active .dropdown-menu {
            display: block;
            opacity: 1;
            transform: translateY(0);
            pointer-events: auto;
        }
        /* Remove fadeIn keyframes as we're using CSS transitions now */
        .dropdown-menu a {
            color: #2c3e50;
            padding: 10px 16px;
            text-decoration: none;
            display: block;
            border-bottom: 1px solid #f1f3f5;
            transition: all 0.15s ease;
            font-size: 14px;
        }
        .map-iframe {
            width: 100%;
            height: 100%;
            border: none;
            display: none;
        }
        .map-iframe.active {
            display: block;
        }
        .dropdown-submenu > .dropdown-submenu-content {
            display: none;
            position: absolute;
            left: 100%;
            top: 0;
            min-width: 240px;
            max-height: 70vh;
            overflow-y: auto;
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 0.375rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            z-index: 1001;
        }
        .dropdown-submenu:hover > .dropdown-submenu-content {
            display: block
        .dropdown-item i {
            width: 20px;
            margin-right: 10px;
            color: #4CAF50;
            text-align: center;
        }


        .dropdown-item i.fa-chevron-right {
            margin-left: auto;
            font-size: 12px;
            color: #a0aec0;
        }
        body {
            margin: 0;
            padding: 0;
            overflow-x: hidden;
        }
        .dropdown {
            display: flex;
            flex-direction: row;
            align-items: center;
            margin-right: 10px;
            position: relative;
            min-width: 220px;
        }
        .dropdown p {
            margin: 0 10px 0 0;
            white-space: nowrap;
            font-size: 14px;
            color: #4a5568;
        }
        .dropdown-toggle {
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 10px 16px;
            width: 100%;
            text-align: left;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.95em;
            color: #2d3748;
            transition: all 0.2s ease;
            user-select: none;
        }
        .dropdown-toggle:focus {
            outline: none;
            border-color: #4CAF50;
            box-shadow: 0 0 0 2px rgba(76, 175, 80, 0.2);
        }
        .dropdown-toggle:hover {
            border-color: #4CAF50;
            background-color: #f8fafc;
        }
        .dropdown-menu {
            position: absolute;
            top: calc(100% + 5px);
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            z-index: 1000;
            max-height: 300px;
            overflow-y: auto;
            opacity: 0;
            visibility: hidden;
            transform: translateY(-10px);
            transition: all 0.2s ease;
            pointer-events: none;
        }
        .dropdown.active .dropdown-menu {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
            pointer-events: auto;
        }
        .dropdown-menu a {
            display: flex;
            align-items: center;
            padding: 10px 16px;
            color: #4a5568;
            text-decoration: none;
            transition: all 0.2s ease;
            position: relative;
        }

        /* Map iframe styles to prevent layout shift */
        .map-iframe {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border: none;
            opacity: 0;
            transition: opacity 0.3s ease;
            pointer-events: none;
        }

        .map-iframe.active {
            opacity: 1;
            pointer-events: auto;
        }
    </style>
<base href="./">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>
    <div class="app-container">
      <!-- Top Toolbar with Dropdowns -->
      <div class="toolbar-top">
        <!-- Theme Dropdown -->
        <div class="dropdown" id="themeDropdown">
          <p><strong>Step 1:</strong> Choose a Theme: </p>
          <button class="dropdown-toggle" aria-haspopup="true" aria-expanded="false">
            <span>Select Theme</span>
            <i class="fas fa-chevron-down" style="font-size: 12px; margin-left: 8px; transition: transform 0.2s ease;"></i>
          </button>
          <div class="dropdown-menu" id="themeMenu" role="menu">
            <!-- Will be populated by JavaScript -->
          </div>
        </div>

        <!-- Subtheme Dropdown (initially hidden) -->
        <div class="dropdown" id="subthemeDropdown" style="display: none;">
          <p><strong>Step 2:</strong> Choose a Sub-theme: </p>
          <button class="dropdown-toggle" aria-haspopup="true" aria-expanded="false">
            <span>Select Sub-theme</span>
            <i class="fas fa-chevron-down" style="font-size: 12px; margin-left: 8px; transition: transform 0.2s ease;"></i>
          </button>
          <div class="dropdown-menu" id="subthemeMenu" role="menu">
            <!-- Will be populated by JavaScript -->
          </div>
        </div>

        <!-- Indicator Dropdown (initially hidden) -->
        <div class="dropdown" id="indicatorDropdown" style="display: none;">
          <p><strong>Step 3:</strong> Choose an Indicator: </p>
          <button class="dropdown-toggle" aria-haspopup="true" aria-expanded="false">
            <span>Select Indicator</span>
            <i class="fas fa-chevron-down" style="font-size: 12px; margin-left: 8px; transition: transform 0.2s ease;"></i>
          </button>
          <div class="dropdown-menu" id="indicatorMenu" role="menu">
            <!-- Will be populated by JavaScript -->
          </div>
        </div>

        <div class="toggle-container">
          <p class="time-series-note">Note: Not all indicators have time-series data.</p>
          <div class="toggle-wrapper">
            <span id="exploreLabel" class="toggle-label active">Explore</span>
            <label class="toggle-switch">
              <input type="checkbox" id="viewToggle">
              <span class="toggle-slider"></span>
            </label>
            <span id="analyzeLabel" class="toggle-label">Analyze</span>
          </div>
        </div>
        
        <button id="toggleInfoBox" class="toggle-info-btn" title="Toggle Info Box">
          <i class="fas fa-info-circle"></i> Toggle Info
        </button>
      </div>

        <div class="three-column-section">
            <div class="column-left">
              <div class="theme-info">
                <div class="info-box-title">Theme Information</div>
                <div class="theme-icon">
                  <i class="icon icon-question"></i>
                </div>
                <div class="text-content">
                  <h2 class="theme-title">Select a Theme</h2>
                  <p class="theme-description">Choose a theme from the dropdown to view its details.</p>
                </div>
              </div>
            </div>
            <div class="column-middle">
              <div class="subtheme-info">
                <div class="info-box-title">Sub-theme Information</div>
                <div class="subtheme-icon">
                  <i class="icon icon-question"></i>
                </div>
                <div class="text-content">
                  <h2 class="subtheme-title">Select a Sub-theme</h2>
                  <p class="subtheme-description">Choose a sub-theme from the dropdown to view its details.</p>
                </div>
              </div>
            </div>
            <div class="column-right">
              <div class="indicator-info">
                <div class="info-box-title">Indicator Information</div>
                <div class="indicator-icon">
                  <i class="icon icon-question"></i>
                </div>
                <div class="text-content">
                  <h2 class="indicator-title">Select an Indicator</h2>
                  <p class="indicator-description">Choose a theme and sub-theme first, then select an indicator to view its details.</p>
                </div>
              </div>
            </div>
        </div>
    </div>

      <!-- Map Section -->
        <div class="map-container">
          <div id="mapPlaceholder" class="map-placeholder">
            <div class="placeholder-content">
              <i class="fas fa-map-marked-alt" style="font-size: 3em; margin-bottom: 20px; color: #4CAF50;"></i>
              <h3>Select a Sub-theme and Indicator</h3>
              <p>Please choose a sub-theme from the dropdown menu above, then select an indicator to view the map.</p>
            </div>
          </div>
          <div id="loadingSpinner" class="loading-spinner">
            <div class="spinner"></div>
            <p style="text-align: center; color: #4CAF50; font-weight: 500; margin-top: 15px;">Loading map data...</p>
          </div>
          <iframe id="map1" class="map-iframe" src="" style="display: none;"></iframe>
          <iframe id="map2" class="map-iframe" src="" style="display: none;"></iframe>
        </div>

      <script>
        // Toggle info box functionality
        document.addEventListener('DOMContentLoaded', function() {
          const toggleBtn = document.getElementById('toggleInfoBox');
          const infoBox = document.querySelector('.three-column-section');
          
          // Load saved preference or default to visible
          const isInfoVisible = localStorage.getItem('infoBoxVisible') !== 'false';
          if (!isInfoVisible) {
            infoBox.classList.add('hidden');
            toggleBtn.classList.add('collapsed');
          }
          
          toggleBtn.addEventListener('click', function() {
            infoBox.classList.toggle('hidden');
            const isNowHidden = infoBox.classList.contains('hidden');
            localStorage.setItem('infoBoxVisible', !isNowHidden);
            
            // Toggle icon and text
            const icon = this.querySelector('i');
            if (isNowHidden) {
              icon.className = 'fas fa-chevron-down';
              this.title = 'Show Info Box';
            } else {
              icon.className = 'fas fa-info-circle';
              this.title = 'Hide Info Box';
            }
          });
        });
        
        // Define Dropdown class first
        class Dropdown {
            constructor(element) {
                this.element = element;
                this.toggle = element.querySelector('.dropdown-toggle');
                this.menu = element.querySelector('.dropdown-menu');
                this.chevron = this.toggle.querySelector('i');
                this.isOpen = false;
                this.menuItems = Array.from(this.menu.querySelectorAll('a'));
                this.focusedIndex = -1;
                
                this.initialize();
            }
            
            initialize() {
                // Add ARIA attributes
                this.toggle.setAttribute('aria-haspopup', 'true');
                this.toggle.setAttribute('aria-expanded', 'false');
                
                // Toggle dropdown on click
                this.toggle.addEventListener('click', (e) => this.toggleDropdown(e));
                
                // Close when clicking outside
                document.addEventListener('click', (e) => this.handleOutsideClick(e));
                
                // Handle keyboard navigation
                this.toggle.addEventListener('keydown', (e) => this.handleToggleKeyDown(e));
                this.menu.addEventListener('keydown', (e) => this.handleMenuKeyDown(e));
                
                // Handle menu item interactions
                this.menuItems.forEach((item, index) => {
                    item.addEventListener('click', () => this.close());
                    item.addEventListener('focus', () => this.focusedIndex = index);
                });
            }
            
            toggleDropdown(e) {
                e.stopPropagation();
                
                if (this.isOpen) {
                    this.close();
                } else {
                    this.open();
                }
            }
            
            open() {
                if (this.isOpen) return;
                
                // Close other dropdowns first
                Dropdown.closeAll(this);
                
                // Open this dropdown
                this.element.classList.add('active');
                this.toggle.setAttribute('aria-expanded', 'true');
                this.chevron.style.transform = 'rotate(180deg)';
                this.isOpen = true;
                
                // Focus first item if available
                if (this.menuItems.length > 0) {
                    this.focusedIndex = 0;
                    this.menuItems[0].focus();
                }
            }
            
            close() {
                if (!this.isOpen) return;
                
                this.element.classList.remove('active');
                this.toggle.setAttribute('aria-expanded', 'false');
                this.chevron.style.transform = '';
                this.isOpen = false;
                this.focusedIndex = -1;
                
                // Return focus to toggle
                this.toggle.focus();
            }
            
            handleOutsideClick(e) {
                if (!this.element.contains(e.target)) {
                    this.close();
                }
            }
            
            handleToggleKeyDown(e) {
                const { key } = e;
                
                if (key === 'Enter' || key === ' ' || key === 'ArrowDown' || key === 'Down') {
                    e.preventDefault();
                    this.open();
                } else if (key === 'Escape') {
                    this.close();
                } else if (key === 'ArrowUp' || key === 'Up') {
                    e.preventDefault();
                    this.open();
                    if (this.menuItems.length > 0) {
                        this.focusedIndex = this.menuItems.length - 1;
                        this.menuItems[this.focusedIndex].focus();
                    }
                }
            }
            
            handleMenuKeyDown(e) {
                const { key } = e;
                
                switch (key) {
                    case 'Escape':
                        e.preventDefault();
                        this.close();
                        break;
                        
                    case 'ArrowDown':
                    case 'Down':
                        e.preventDefault();
                        this.focusNextItem();
                        break;
                        
                    case 'ArrowUp':
                    case 'Up':
                        e.preventDefault();
                        this.focusPrevItem();
                        break;
                        
                    case 'Home':
                        e.preventDefault();
                        this.focusItem(0);
                        break;
                        
                    case 'End':
                        e.preventDefault();
                        this.focusItem(this.menuItems.length - 1);
                        break;
                        
                    case 'Tab':
                        if (!e.shiftKey && this.focusedIndex === this.menuItems.length - 1) {
                            // Close dropdown when tabbing out of the last item
                            this.close();
                        } else if (e.shiftKey && this.focusedIndex <= 0) {
                            // Close dropdown when shift+tabbing out of the first item
                            e.preventDefault();
                            this.close();
                        }
                        break;
                }
            }
            
            focusNextItem() {
                this.focusedIndex = (this.focusedIndex + 1) % this.menuItems.length;
                this.menuItems[this.focusedIndex].focus();
            }
            
            focusPrevItem() {
                this.focusedIndex = (this.focusedIndex - 1 + this.menuItems.length) % this.menuItems.length;
                this.menuItems[this.focusedIndex].focus();
            }
            
            focusItem(index) {
                if (index >= 0 && index < this.menuItems.length) {
                    this.focusedIndex = index;
                    this.menuItems[index].focus();
                }
            }
            
            static closeAll(exceptDropdown = null) {
                document.querySelectorAll('.dropdown').forEach(dropdown => {
                    const instance = dropdown._dropdownInstance;
                    if (instance && instance !== exceptDropdown) {
                        instance.close();
                    }
                });
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            // Initialize dropdowns
            document.querySelectorAll('.dropdown').forEach(dropdown => {
                dropdown._dropdownInstance = new Dropdown(dropdown);
            });
            
            // Handle map toggle functionality
            const viewToggle = document.getElementById('viewToggle');
            const map1 = document.getElementById('map1');
            const map2 = document.getElementById('map2');
            const exploreLabel = document.getElementById('exploreLabel');
            const analyzeLabel = document.getElementById('analyzeLabel');

            viewToggle.addEventListener('change', function() {
                if (this.checked) {
                    // Switch to map2 (Analyze view)
                    map1.style.display = 'none';
                    map2.style.display = 'block';
                    exploreLabel.classList.remove('active');
                    analyzeLabel.classList.add('active');
                } else {
                    // Switch to map1 (Explore view)
                    map1.style.display = 'block';
                    map2.style.display = 'none';
                    exploreLabel.classList.add('active');
                    analyzeLabel.classList.remove('active');
                }
            });

            // Get all themes data from the template
            const themesData = [
                
                {
                    id: 'ecosystem\u002Dhealth',
                    name: '2.0 Ecosystem Health',
                    subthemes: [
                        
                        {
                            id: 'values',
                            name: '2.1 Values',
                            description: 'The \u003Cstrong\u003Eintrinsic health of terrestrial and freshwater habitats\u003C/strong\u003E and the \u003Cstrong\u003Ebenefits they provide through ecosystem services\u003C/strong\u003E, such as \u003Cstrong\u003Eclean air, water filtration, pollination, carbon storage, and climate regulation\u003C/strong\u003E. Ecosystem values are used to \u003Cstrong\u003Emonitor the relative impacts of landscape changes\u003C/strong\u003E associated with human activities over time, and to help \u003Cstrong\u003Eidentify and prioritize conservation efforts\u003C/strong\u003E that protect \u003Cstrong\u003Evulnerable wildlife habitat\u003C/strong\u003E for the broadest possible range of native species.',
                            indicators: [
                                
                                    
                                        {
                                            id: 'land\u002Dcover',
                                            title: '2.1.1 Land Cover',
                                            description: '\u003Cstrong\u003EVisible terrestrial components\u003C/strong\u003E of the Earth\u0027s surface, which include \u003Cstrong\u003Eforests, grasslands, wetlands, alpine areas\u003C/strong\u003E and various \u003Cstrong\u003Eland uses\u003C/strong\u003E associated with human settlement, such as \u003Cstrong\u003Eurban and agricultural areas\u003C/strong\u003E and \u003Cstrong\u003Elinear infrastructure\u003C/strong\u003E. The \u003Cstrong\u003Espatial arrangement and distribution\u003C/strong\u003E of these components serve as indicators for \u003Cstrong\u003Emonitoring landscape patterns\u003C/strong\u003E and understanding their effects on \u003Cstrong\u003Eecosystem health and integrity\u003C/strong\u003E over time.',
                                            icon: 'fa\u002Dleaf',
                                            map1_url: 'https://felt.com/embed/map/S2S\u002DConnectivityModel\u002Dv0p1\u002Dcopy\u002Dmr4RufF9AQM9B5KvTx1IczZC?loc\u003D50.1164%2C\u002D123.0674%2C8.51z\u0026legend\u003D1\u0026cooperativeGestures\u003D1\u0026link\u003D1\u0026geolocation\u003D0\u0026zoomControls\u003D1\u0026scaleBar\u003D1',
                                            map2_url: 'https://cascadia.staging.dashboard.terradapt.org/?zoom\u003D10.57924853633501\u0026lng\u003D\u002D123.16974611514613\u0026lat\u003D49.724616106137404\u0026opacity\u003D0.75\u0026layerTheme\u003D%22landcover%22\u0026layerScope\u003D%22monitor%22\u0026layerVisualisation\u003D%22pixel%22\u0026minTimestamp\u003D%221984\u002D07\u002D01T00%3A00%3A00%22\u0026maxTimestamp\u003D%222024\u002D07\u002D01T00%3A00%3A00%22\u0026selectedLayer\u003D%22landcover_class%22\u0026layerView\u003D%22status%22\u0026layerStart\u003D%221984\u002D07\u002D01T00%3A00%3A00%22\u0026layerEnd\u003D%222024\u002D07\u002D01T00%3A00%3A00%22\u0026currentTimestamp\u003D%222024\u002D07\u002D01T00%3A00%3A00%22\u0026pitch\u003D45.997005671225544\u0026bearing\u003D11.999218870754135',
                                            posts: 'land\u002Dcover',
                                            source: '\u003Ca target\u003D\u0027_blank\u0027 href\u003D\u0027https://newdev.naturesquamish.ca\u0027\u003ESource\u003C/a\u003E',
                                            unit_of_measure: 'kg/m^2',
                                            theme: 'ecosystem\u002Dhealth'  // Add theme ID to each indicator
                                        },
                                    
                                
                                    
                                        {
                                            id: 'ecosystem\u002Dservices',
                                            title: '2.1.2 Ecosystem Services',
                                            description: 'A \u003Cstrong\u003Esubjective evaluation\u003C/strong\u003E of the benefits that \u003Cstrong\u003Ecurrent and future generations\u003C/strong\u003E receive from \u003Cstrong\u003Ephysical, chemical, and biological processes\u003C/strong\u003E supporting the \u003Cstrong\u003Efunctional health and long\u002Dterm resilience\u003C/strong\u003E of a natural ecosystem. These include \u003Cstrong\u003Eprovisioning\u003C/strong\u003E (food and water), \u003Cstrong\u003Eregulating\u003C/strong\u003E (climate control and disease mitigation), \u003Cstrong\u003Esupporting\u003C/strong\u003E (nutrient cycles and pollination), and \u003Cstrong\u003Ecultural services\u003C/strong\u003E (spiritual and aesthetic value). Valuing these services involves \u003Cstrong\u003Eeconomic methods\u003C/strong\u003E to assign subjective worth to natural processes. However, most \u003Cstrong\u003EIndigenous worldviews\u003C/strong\u003E view nature as \u003Cstrong\u003Ekin with inherent rights\u003C/strong\u003E, not as a commodity valued solely for human utility.',
                                            icon: 'fa\u002Dleaf',
                                            map1_url: 'https://felt.com/embed/map/S2S\u002DConnectivityModel\u002Dv0p1\u002Dcopy\u002Dmr4RufF9AQM9B5KvTx1IczZC?loc\u003D50.1164%2C\u002D123.0674%2C8.51z\u0026legend\u003D1\u0026cooperativeGestures\u003D1\u0026link\u003D1\u0026geolocation\u003D0\u0026zoomControls\u003D1\u0026scaleBar\u003D1',
                                            map2_url: 'https://cascadia.staging.dashboard.terradapt.org/?zoom\u003D10.57924853633501\u0026lng\u003D\u002D123.16974611514613\u0026lat\u003D49.724616106137404\u0026opacity\u003D0.75\u0026layerTheme\u003D%22landcover%22\u0026layerScope\u003D%22monitor%22\u0026layerVisualisation\u003D%22pixel%22\u0026minTimestamp\u003D%221984\u002D07\u002D01T00%3A00%3A00%22\u0026maxTimestamp\u003D%222024\u002D07\u002D01T00%3A00%3A00%22\u0026selectedLayer\u003D%22landcover_class%22\u0026layerView\u003D%22status%22\u0026layerStart\u003D%221984\u002D07\u002D01T00%3A00%3A00%22\u0026layerEnd\u003D%222024\u002D07\u002D01T00%3A00%3A00%22\u0026currentTimestamp\u003D%222024\u002D07\u002D01T00%3A00%3A00%22\u0026pitch\u003D45.997005671225544\u0026bearing\u003D11.999218870754135',
                                            posts: 'ecosystem\u002Dservices',
                                            source: '\u003Ca target\u003D\u0027_blank\u0027 href\u003D\u0027https://newdev.naturesquamish.ca\u0027\u003ESource\u003C/a\u003E',
                                            unit_of_measure: 'kg/m^2',
                                            theme: 'ecosystem\u002Dhealth'  // Add theme ID to each indicator
                                        },
                                    
                                
                                    
                                        {
                                            id: 'habitat\u002Dsuitability',
                                            title: '2.1.3 Habitat Suitability',
                                            description: 'The \u003Cstrong\u003Ecapacity of terrestrial and freshwater ecosystems\u003C/strong\u003E to provide \u003Cstrong\u003Eessential life\u002Dcycle resources\u003C/strong\u003E (food, water, shelter, breeding sites) and \u003Cstrong\u003Esuitable living conditions\u003C/strong\u003E for a species to survive and reproduce. The \u003Cstrong\u003Esuitability\u003C/strong\u003E of a given wildlife habitat is determined by \u003Cstrong\u003Esite\u002Dspecific environmental variables\u003C/strong\u003E that influence the \u003Cstrong\u003Eoccurrence and distribution of wildlife species\u003C/strong\u003E. These include a wide range of \u003Cstrong\u003Ebiotic and abiotic variables\u003C/strong\u003E, including the \u003Cstrong\u003Estructure and composition of ecological communities\u003C/strong\u003E within a given biogeoclimatic zone, \u003Cstrong\u003Esoil moisture and nutrient levels\u003C/strong\u003E, \u003Cstrong\u003Etopographic position\u003C/strong\u003E, \u003Cstrong\u003Etemperature\u003C/strong\u003E, \u003Cstrong\u003Eslope aspect\u003C/strong\u003E and \u003Cstrong\u003Esolar insolation\u003C/strong\u003E.',
                                            icon: 'fa\u002Dleaf',
                                            map1_url: 'https://felt.com/embed/map/S2S\u002DConnectivityModel\u002Dv0p1\u002Dcopy\u002Dmr4RufF9AQM9B5KvTx1IczZC?loc\u003D50.1164%2C\u002D123.0674%2C8.51z\u0026legend\u003D1\u0026cooperativeGestures\u003D1\u0026link\u003D1\u0026geolocation\u003D0\u0026zoomControls\u003D1\u0026scaleBar\u003D1',
                                            map2_url: 'https://cascadia.staging.dashboard.terradapt.org/?zoom\u003D10.57924853633501\u0026lng\u003D\u002D123.16974611514613\u0026lat\u003D49.724616106137404\u0026opacity\u003D0.75\u0026layerTheme\u003D%22landcover%22\u0026layerScope\u003D%22monitor%22\u0026layerVisualisation\u003D%22pixel%22\u0026minTimestamp\u003D%221984\u002D07\u002D01T00%3A00%3A00%22\u0026maxTimestamp\u003D%222024\u002D07\u002D01T00%3A00%3A00%22\u0026selectedLayer\u003D%22landcover_class%22\u0026layerView\u003D%22status%22\u0026layerStart\u003D%221984\u002D07\u002D01T00%3A00%3A00%22\u0026layerEnd\u003D%222024\u002D07\u002D01T00%3A00%3A00%22\u0026currentTimestamp\u003D%222024\u002D07\u002D01T00%3A00%3A00%22\u0026pitch\u003D45.997005671225544\u0026bearing\u003D11.999218870754135',
                                            posts: 'habitat\u002Dsuitability',
                                            source: '\u003Ca target\u003D\u0027_blank\u0027 href\u003D\u0027https://newdev.naturesquamish.ca\u0027\u003ESource\u003C/a\u003E',
                                            unit_of_measure: 'kg/m^2',
                                            theme: 'ecosystem\u002Dhealth'  // Add theme ID to each indicator
                                        },
                                    
                                
                                    
                                        {
                                            id: 'structural\u002Dconnectivity',
                                            title: '2.1.4 Structural Connectivity',
                                            description: '\u003Cstrong\u003EThe physical arrangement and connectivity of habitat patches and natural landscape features\u003C/strong\u003E (e.g., forests, water bodies) across a landscape, regardless of species\u002Dspecific behaviour. \u003Cstrong\u003EStructural connectivity is crucial for biodiversity conservation\u003C/strong\u003E because it offers \u003Cstrong\u003Eessential physical pathways\u003C/strong\u003E that allow wildlife to \u003Cstrong\u003Emove freely\u003C/strong\u003E to access \u003Cstrong\u003Efood, shelter, and breeding sites\u003C/strong\u003E. This movement supports \u003Cstrong\u003Egenetic exchange\u003C/strong\u003E, enhances \u003Cstrong\u003Eecosystem resilience to disturbances\u003C/strong\u003E, enables species to \u003Cstrong\u003Eadjust their ranges in response to climate change\u003C/strong\u003E, and diminishes the \u003Cstrong\u003Enegative effects of habitat fragmentation\u003C/strong\u003E.',
                                            icon: 'fa\u002Dleaf',
                                            map1_url: 'https://felt.com/embed/map/S2S\u002DConnectivityModel\u002Dv0p1\u002Dcopy\u002Dmr4RufF9AQM9B5KvTx1IczZC?loc\u003D50.1164%2C\u002D123.0674%2C8.51z\u0026legend\u003D1\u0026cooperativeGestures\u003D1\u0026link\u003D1\u0026geolocation\u003D0\u0026zoomControls\u003D1\u0026scaleBar\u003D1',
                                            map2_url: 'https://cascadia.staging.dashboard.terradapt.org/?zoom\u003D10.57924853633501\u0026lng\u003D\u002D123.16974611514613\u0026lat\u003D49.724616106137404\u0026opacity\u003D0.75\u0026layerTheme\u003D%22landcover%22\u0026layerScope\u003D%22monitor%22\u0026layerVisualisation\u003D%22pixel%22\u0026minTimestamp\u003D%221984\u002D07\u002D01T00%3A00%3A00%22\u0026maxTimestamp\u003D%222024\u002D07\u002D01T00%3A00%3A00%22\u0026selectedLayer\u003D%22landcover_class%22\u0026layerView\u003D%22status%22\u0026layerStart\u003D%221984\u002D07\u002D01T00%3A00%3A00%22\u0026layerEnd\u003D%222024\u002D07\u002D01T00%3A00%3A00%22\u0026currentTimestamp\u003D%222024\u002D07\u002D01T00%3A00%3A00%22\u0026pitch\u003D45.997005671225544\u0026bearing\u003D11.999218870754135',
                                            posts: 'structural\u002Dconnectivity',
                                            source: '\u003Ca target\u003D\u0027_blank\u0027 href\u003D\u0027https://newdev.naturesquamish.ca\u0027\u003ESource\u003C/a\u003E',
                                            unit_of_measure: 'kg/m^2',
                                            theme: 'ecosystem\u002Dhealth'  // Add theme ID to each indicator
                                        }
                                    
                                
                            ]
                        },
                        
                        {
                            id: 'threats',
                            name: '2.2 Threats',
                            description: '\u003Cstrong\u003EFactors or conditions\u003C/strong\u003E that can cause harm and \u003Cstrong\u003Enegatively impact the health and resilience\u003C/strong\u003E of terrestrial and freshwater habitats. These include \u003Cstrong\u003Ehuman activities\u003C/strong\u003E that directly disturb the landscape (e.g., urbanization, infrastructure development, agricultural land use, and resource extraction), as well as \u003Cstrong\u003Enatural hazard events\u003C/strong\u003E like floods and wildfires. The \u003Cstrong\u003Ecumulative effects\u003C/strong\u003E of these processes lead to \u003Cstrong\u003Ehabitat loss and fragmentation\u003C/strong\u003E, decreasing the natural ability of ecosystems and wildlife species to \u003Cstrong\u003Ecope with and adapt to changes\u003C/strong\u003E over time.',
                            indicators: [
                                
                                    
                                        {
                                            id: 'landscape\u002Dchange',
                                            title: '2.2.1 Landscape Change',
                                            description: '\u003Cstrong\u003EContinuous and often nonlinear\u003C/strong\u003E spatial and temporal shifts in \u003Cstrong\u003Eecosystem patterns and processes\u003C/strong\u003E that are driven by \u003Cstrong\u003Enatural events\u003C/strong\u003E, as well as the \u003Cstrong\u003Ecumulative impacts of human activities and climate change\u003C/strong\u003E. The assessment of these \u003Cstrong\u003Edynamic landscape changes\u003C/strong\u003E relies on \u003Cstrong\u003Eremote sensing methods\u003C/strong\u003E of earth observation, which track \u003Cstrong\u003Eland use patterns\u003C/strong\u003E at specific locations over time. Understanding these changes is essential for \u003Cstrong\u003Eidentifying the underlying causes of biodiversity loss\u003C/strong\u003E and developing \u003Cstrong\u003Epractical solutions\u003C/strong\u003E to reduce these threats and improve \u003Cstrong\u003Eecosystem health and connectivity\u003C/strong\u003E.',
                                            icon: 'fa\u002Dleaf',
                                            map1_url: 'https://felt.com/embed/map/S2S\u002DConnectivityModel\u002Dv0p1\u002Dcopy\u002Dmr4RufF9AQM9B5KvTx1IczZC?loc\u003D50.1164%2C\u002D123.0674%2C8.51z\u0026legend\u003D1\u0026cooperativeGestures\u003D1\u0026link\u003D1\u0026geolocation\u003D0\u0026zoomControls\u003D1\u0026scaleBar\u003D1',
                                            map2_url: 'https://cascadia.staging.dashboard.terradapt.org/?zoom\u003D10.57924853633501\u0026lng\u003D\u002D123.16974611514613\u0026lat\u003D49.724616106137404\u0026opacity\u003D0.75\u0026layerTheme\u003D%22landcover%22\u0026layerScope\u003D%22monitor%22\u0026layerVisualisation\u003D%22pixel%22\u0026minTimestamp\u003D%221984\u002D07\u002D01T00%3A00%3A00%22\u0026maxTimestamp\u003D%222024\u002D07\u002D01T00%3A00%3A00%22\u0026selectedLayer\u003D%22landcover_class%22\u0026layerView\u003D%22status%22\u0026layerStart\u003D%221984\u002D07\u002D01T00%3A00%3A00%22\u0026layerEnd\u003D%222024\u002D07\u002D01T00%3A00%3A00%22\u0026currentTimestamp\u003D%222024\u002D07\u002D01T00%3A00%3A00%22\u0026pitch\u003D45.997005671225544\u0026bearing\u003D11.999218870754135',
                                            posts: 'landscape\u002Dchange',
                                            source: '\u003Ca target\u003D\u0027_blank\u0027 href\u003D\u0027https://newdev.naturesquamish.ca\u0027\u003ESource\u003C/a\u003E',
                                            unit_of_measure: 'kg/m^2',
                                            theme: 'ecosystem\u002Dhealth'  // Add theme ID to each indicator
                                        },
                                    
                                
                                    
                                        {
                                            id: 'urbanization',
                                            title: '2.2.2 Urbanization',
                                            description: 'The \u003Cstrong\u003Econversion of natural wildland habitats\u003C/strong\u003E into \u003Cstrong\u003Ebuilt environments\u003C/strong\u003E to accommodate \u003Cstrong\u003Epopulation growth and development\u003C/strong\u003E. Examples include \u003Cstrong\u003Eclearing land\u003C/strong\u003E for residential neighbourhoods and businesses, \u003Cstrong\u003Eagricultural use\u003C/strong\u003E, \u003Cstrong\u003Eresource extraction activities\u003C/strong\u003E, and associated \u003Cstrong\u003Elinear infrastructure\u003C/strong\u003E such as roads, pipelines, and utility corridors. \u003Cstrong\u003EDirect physical consequences\u003C/strong\u003E include the \u003Cstrong\u003Eloss and fragmentation of wildland habitats\u003C/strong\u003E and the \u003Cstrong\u003Edisruption of natural ecological connectivity pathways\u003C/strong\u003E. \u003Cstrong\u003EIndirect effects\u003C/strong\u003E involve \u003Cstrong\u003Ealtered hydrology\u003C/strong\u003E (e.g., stormwater runoff) and \u003Cstrong\u003Eincreased vulnerability\u003C/strong\u003E to the spread of \u003Cstrong\u003Einvasive species\u003C/strong\u003E and \u003Cstrong\u003Ebiodiversity loss\u003C/strong\u003E.',
                                            icon: 'fa\u002Dleaf',
                                            map1_url: 'https://felt.com/embed/map/S2S\u002DConnectivityModel\u002Dv0p1\u002Dcopy\u002Dmr4RufF9AQM9B5KvTx1IczZC?loc\u003D50.1164%2C\u002D123.0674%2C8.51z\u0026legend\u003D1\u0026cooperativeGestures\u003D1\u0026link\u003D1\u0026geolocation\u003D0\u0026zoomControls\u003D1\u0026scaleBar\u003D1',
                                            map2_url: 'https://cascadia.staging.dashboard.terradapt.org/?zoom\u003D10.57924853633501\u0026lng\u003D\u002D123.16974611514613\u0026lat\u003D49.724616106137404\u0026opacity\u003D0.75\u0026layerTheme\u003D%22landcover%22\u0026layerScope\u003D%22monitor%22\u0026layerVisualisation\u003D%22pixel%22\u0026minTimestamp\u003D%221984\u002D07\u002D01T00%3A00%3A00%22\u0026maxTimestamp\u003D%222024\u002D07\u002D01T00%3A00%3A00%22\u0026selectedLayer\u003D%22landcover_class%22\u0026layerView\u003D%22status%22\u0026layerStart\u003D%221984\u002D07\u002D01T00%3A00%3A00%22\u0026layerEnd\u003D%222024\u002D07\u002D01T00%3A00%3A00%22\u0026currentTimestamp\u003D%222024\u002D07\u002D01T00%3A00%3A00%22\u0026pitch\u003D45.997005671225544\u0026bearing\u003D11.999218870754135',
                                            posts: 'urbanization',
                                            source: '\u003Ca target\u003D\u0027_blank\u0027 href\u003D\u0027https://newdev.naturesquamish.ca\u0027\u003ESource\u003C/a\u003E',
                                            unit_of_measure: 'kg/m^2',
                                            theme: 'ecosystem\u002Dhealth'  // Add theme ID to each indicator
                                        },
                                    
                                
                                    
                                        {
                                            id: 'linear\u002Dinfrastructure',
                                            title: '2.2.3 Linear Infrastructure',
                                            description: 'Conversion of wildland habitat for the development of linear transportation and utility corridors.  These include networks of primary and secondary resource roads, rail lines, water and energy pipelines, electrical transmission lines, and related facilities. The construction of these infrastructure corridors requires extensive vegetation clearing, permanently transforming natural landscapes into developed areas. Primary threats include habitat fragmentation, disruption of wildlife movement patterns, increased access and vulnerability to invasive species and the pressures of human activity.',
                                            icon: 'fa\u002Dleaf',
                                            map1_url: 'https://felt.com/embed/map/S2S\u002DConnectivityModel\u002Dv0p1\u002Dcopy\u002Dmr4RufF9AQM9B5KvTx1IczZC?loc\u003D50.1164%2C\u002D123.0674%2C8.51z\u0026legend\u003D1\u0026cooperativeGestures\u003D1\u0026link\u003D1\u0026geolocation\u003D0\u0026zoomControls\u003D1\u0026scaleBar\u003D1',
                                            map2_url: 'https://cascadia.staging.dashboard.terradapt.org/?zoom\u003D10.57924853633501\u0026lng\u003D\u002D123.16974611514613\u0026lat\u003D49.724616106137404\u0026opacity\u003D0.75\u0026layerTheme\u003D%22landcover%22\u0026layerScope\u003D%22monitor%22\u0026layerVisualisation\u003D%22pixel%22\u0026minTimestamp\u003D%221984\u002D07\u002D01T00%3A00%3A00%22\u0026maxTimestamp\u003D%222024\u002D07\u002D01T00%3A00%3A00%22\u0026selectedLayer\u003D%22landcover_class%22\u0026layerView\u003D%22status%22\u0026layerStart\u003D%221984\u002D07\u002D01T00%3A00%3A00%22\u0026layerEnd\u003D%222024\u002D07\u002D01T00%3A00%3A00%22\u0026currentTimestamp\u003D%222024\u002D07\u002D01T00%3A00%3A00%22\u0026pitch\u003D45.997005671225544\u0026bearing\u003D11.999218870754135',
                                            posts: 'linear\u002Dinfrastructure',
                                            source: '\u003Ca target\u003D\u0027_blank\u0027 href\u003D\u0027https://newdev.naturesquamish.ca\u0027\u003ESource\u003C/a\u003E',
                                            unit_of_measure: 'kg/m^2',
                                            theme: 'ecosystem\u002Dhealth'  // Add theme ID to each indicator
                                        },
                                    
                                
                                    
                                        {
                                            id: 'agricultural\u002Duse',
                                            title: '2.2.4 Agricultural Use',
                                            description: 'The conversion of wildland habitat for agricultural purposes, including land clearing for irrigated and non\u002Dirrigated crops and orchards, as well as for rangeland pasture. Direct physical impacts include loss and fragmentation of wildland habitat and species displacement, soil contamination from pesticides affecting non\u002Dtarget species, alteration of surface and groundwater flow patterns, and disruption of ecological connectivity networks through boundary fencing. Indirect effects involve changed hydrology (e.g., stormwater runoff) and increased vulnerability to invasive species and associated biodiversity loss.',
                                            icon: 'fa\u002Dleaf',
                                            map1_url: 'https://felt.com/embed/map/S2S\u002DConnectivityModel\u002Dv0p1\u002Dcopy\u002Dmr4RufF9AQM9B5KvTx1IczZC?loc\u003D50.1164%2C\u002D123.0674%2C8.51z\u0026legend\u003D1\u0026cooperativeGestures\u003D1\u0026link\u003D1\u0026geolocation\u003D0\u0026zoomControls\u003D1\u0026scaleBar\u003D1',
                                            map2_url: 'https://cascadia.staging.dashboard.terradapt.org/?zoom\u003D10.57924853633501\u0026lng\u003D\u002D123.16974611514613\u0026lat\u003D49.724616106137404\u0026opacity\u003D0.75\u0026layerTheme\u003D%22landcover%22\u0026layerScope\u003D%22monitor%22\u0026layerVisualisation\u003D%22pixel%22\u0026minTimestamp\u003D%221984\u002D07\u002D01T00%3A00%3A00%22\u0026maxTimestamp\u003D%222024\u002D07\u002D01T00%3A00%3A00%22\u0026selectedLayer\u003D%22landcover_class%22\u0026layerView\u003D%22status%22\u0026layerStart\u003D%221984\u002D07\u002D01T00%3A00%3A00%22\u0026layerEnd\u003D%222024\u002D07\u002D01T00%3A00%3A00%22\u0026currentTimestamp\u003D%222024\u002D07\u002D01T00%3A00%3A00%22\u0026pitch\u003D45.997005671225544\u0026bearing\u003D11.999218870754135',
                                            posts: 'agricultural\u002Duse',
                                            source: '\u003Ca target\u003D\u0027_blank\u0027 href\u003D\u0027https://newdev.naturesquamish.ca\u0027\u003ESource\u003C/a\u003E',
                                            unit_of_measure: 'kg/m^2',
                                            theme: 'ecosystem\u002Dhealth'  // Add theme ID to each indicator
                                        },
                                    
                                
                                    
                                        {
                                            id: 'forest\u002Dharvest',
                                            title: '2.2.5 Forest Harvest',
                                            description: 'While land disturbances caused by timber harvesting will regenerate over time, there are direct and indirect consequences that can be lasting if sustainable management practices are not in place. Direct physical impacts include the loss and fragmentation of wildland habitat, species displacement, alterations in surface and groundwater flow patterns, and disruptions to ecological connectivity networks. Indirect impacts include increased susceptibility to soil compaction and erosion, modifications to natural wildlife behaviour caused by greater access for recreational activities, and the increased spread of invasive species.  ',
                                            icon: 'fa\u002Dleaf',
                                            map1_url: 'https://felt.com/embed/map/S2S\u002DConnectivityModel\u002Dv0p1\u002Dcopy\u002Dmr4RufF9AQM9B5KvTx1IczZC?loc\u003D50.1164%2C\u002D123.0674%2C8.51z\u0026legend\u003D1\u0026cooperativeGestures\u003D1\u0026link\u003D1\u0026geolocation\u003D0\u0026zoomControls\u003D1\u0026scaleBar\u003D1',
                                            map2_url: 'https://cascadia.staging.dashboard.terradapt.org/?zoom\u003D10.57924853633501\u0026lng\u003D\u002D123.16974611514613\u0026lat\u003D49.724616106137404\u0026opacity\u003D0.75\u0026layerTheme\u003D%22landcover%22\u0026layerScope\u003D%22monitor%22\u0026layerVisualisation\u003D%22pixel%22\u0026minTimestamp\u003D%221984\u002D07\u002D01T00%3A00%3A00%22\u0026maxTimestamp\u003D%222024\u002D07\u002D01T00%3A00%3A00%22\u0026selectedLayer\u003D%22landcover_class%22\u0026layerView\u003D%22status%22\u0026layerStart\u003D%221984\u002D07\u002D01T00%3A00%3A00%22\u0026layerEnd\u003D%222024\u002D07\u002D01T00%3A00%3A00%22\u0026currentTimestamp\u003D%222024\u002D07\u002D01T00%3A00%3A00%22\u0026pitch\u003D45.997005671225544\u0026bearing\u003D11.999218870754135',
                                            posts: 'forest\u002Dharvest',
                                            source: '\u003Ca target\u003D\u0027_blank\u0027 href\u003D\u0027https://newdev.naturesquamish.ca\u0027\u003ESource\u003C/a\u003E',
                                            unit_of_measure: 'kg/m^2',
                                            theme: 'ecosystem\u002Dhealth'  // Add theme ID to each indicator
                                        },
                                    
                                
                                    
                                        {
                                            id: 'forest\u002Dthinning',
                                            title: '2.2.6 Forest Thinning',
                                            description: 'Forest thinning involves the selective removal of trees to improve the health and growth of terrestrial ecosystems and to lessen the threat of wildfire and disease. Although thinning methods cause less noticeable changes to the landscape, they can still have lasting effects. Direct physical impacts include increased light and ground temperatures, the removal of critical habitat features (e.g., dead trees, dense undergrowth), and changes to water flow and related ecosystem functions. Indirect effects include reduced habitat quality for interior\u002Ddwelling species and shifts in wildlife movement patterns.',
                                            icon: 'fa\u002Dleaf',
                                            map1_url: 'https://felt.com/embed/map/S2S\u002DConnectivityModel\u002Dv0p1\u002Dcopy\u002Dmr4RufF9AQM9B5KvTx1IczZC?loc\u003D50.1164%2C\u002D123.0674%2C8.51z\u0026legend\u003D1\u0026cooperativeGestures\u003D1\u0026link\u003D1\u0026geolocation\u003D0\u0026zoomControls\u003D1\u0026scaleBar\u003D1',
                                            map2_url: 'https://cascadia.staging.dashboard.terradapt.org/?zoom\u003D10.57924853633501\u0026lng\u003D\u002D123.16974611514613\u0026lat\u003D49.724616106137404\u0026opacity\u003D0.75\u0026layerTheme\u003D%22landcover%22\u0026layerScope\u003D%22monitor%22\u0026layerVisualisation\u003D%22pixel%22\u0026minTimestamp\u003D%221984\u002D07\u002D01T00%3A00%3A00%22\u0026maxTimestamp\u003D%222024\u002D07\u002D01T00%3A00%3A00%22\u0026selectedLayer\u003D%22landcover_class%22\u0026layerView\u003D%22status%22\u0026layerStart\u003D%221984\u002D07\u002D01T00%3A00%3A00%22\u0026layerEnd\u003D%222024\u002D07\u002D01T00%3A00%3A00%22\u0026currentTimestamp\u003D%222024\u002D07\u002D01T00%3A00%3A00%22\u0026pitch\u003D45.997005671225544\u0026bearing\u003D11.999218870754135',
                                            posts: 'forest\u002Dthinning',
                                            source: '\u003Ca target\u003D\u0027_blank\u0027 href\u003D\u0027https://newdev.naturesquamish.ca\u0027\u003ESource\u003C/a\u003E',
                                            unit_of_measure: 'kg/m^2',
                                            theme: 'ecosystem\u002Dhealth'  // Add theme ID to each indicator
                                        },
                                    
                                
                                    
                                        {
                                            id: 'wildfire',
                                            title: '2.2.7 Wildfire',
                                            description: 'A wildfire conflagration is a severe fire event triggered by a combination of fuel (vegetation), weather conditions (such as high temperatures, strong winds, and drought), and topography (slopes). Wildfires can result in loss of life, destruction of natural habitats, and disruption of ecological connectivity networks. Although some ecosystems are adapted to fire, the increased frequency and intensity of fires can cause lasting changes in vegetationsuch as forests turning into shrublandsleading to a decline in the ecosystems overall health, diversity, and resilience. ',
                                            icon: 'fa\u002Dleaf',
                                            map1_url: 'https://felt.com/embed/map/S2S\u002DConnectivityModel\u002Dv0p1\u002Dcopy\u002Dmr4RufF9AQM9B5KvTx1IczZC?loc\u003D50.1164%2C\u002D123.0674%2C8.51z\u0026legend\u003D1\u0026cooperativeGestures\u003D1\u0026link\u003D1\u0026geolocation\u003D0\u0026zoomControls\u003D1\u0026scaleBar\u003D1',
                                            map2_url: 'https://cascadia.staging.dashboard.terradapt.org/?zoom\u003D10.57924853633501\u0026lng\u003D\u002D123.16974611514613\u0026lat\u003D49.724616106137404\u0026opacity\u003D0.75\u0026layerTheme\u003D%22landcover%22\u0026layerScope\u003D%22monitor%22\u0026layerVisualisation\u003D%22pixel%22\u0026minTimestamp\u003D%221984\u002D07\u002D01T00%3A00%3A00%22\u0026maxTimestamp\u003D%222024\u002D07\u002D01T00%3A00%3A00%22\u0026selectedLayer\u003D%22landcover_class%22\u0026layerView\u003D%22status%22\u0026layerStart\u003D%221984\u002D07\u002D01T00%3A00%3A00%22\u0026layerEnd\u003D%222024\u002D07\u002D01T00%3A00%3A00%22\u0026currentTimestamp\u003D%222024\u002D07\u002D01T00%3A00%3A00%22\u0026pitch\u003D45.997005671225544\u0026bearing\u003D11.999218870754135',
                                            posts: 'wildfire',
                                            source: '\u003Ca target\u003D\u0027_blank\u0027 href\u003D\u0027https://newdev.naturesquamish.ca\u0027\u003ESource\u003C/a\u003E',
                                            unit_of_measure: 'kg/m^2',
                                            theme: 'ecosystem\u002Dhealth'  // Add theme ID to each indicator
                                        },
                                    
                                
                                    
                                        {
                                            id: 'temperature',
                                            title: '2.2.8 Temperature',
                                            description: 'Temperature varies across landscapes due to topography (e.g., cooler at higher elevations) and macrohabitat types (e.g., urban areas are warmer than forests). Projected changes in mean annual temperature (RCP 8.5) affect the distribution of biogeoclimatic zones by shifting suitable habitats toward higher latitudes and elevations, thereby transforming the range and composition of existing ecological communities. While some species can cope with and adapt to these changes, others become increasingly vulnerable to climatic variations, leading to population reductions and local extinctions.',
                                            icon: 'fa\u002Dleaf',
                                            map1_url: 'https://felt.com/embed/map/S2S\u002DConnectivityModel\u002Dv0p1\u002Dcopy\u002Dmr4RufF9AQM9B5KvTx1IczZC?loc\u003D50.1164%2C\u002D123.0674%2C8.51z\u0026legend\u003D1\u0026cooperativeGestures\u003D1\u0026link\u003D1\u0026geolocation\u003D0\u0026zoomControls\u003D1\u0026scaleBar\u003D1',
                                            map2_url: 'https://cascadia.staging.dashboard.terradapt.org/?zoom\u003D10.57924853633501\u0026lng\u003D\u002D123.16974611514613\u0026lat\u003D49.724616106137404\u0026opacity\u003D0.75\u0026layerTheme\u003D%22landcover%22\u0026layerScope\u003D%22monitor%22\u0026layerVisualisation\u003D%22pixel%22\u0026minTimestamp\u003D%221984\u002D07\u002D01T00%3A00%3A00%22\u0026maxTimestamp\u003D%222024\u002D07\u002D01T00%3A00%3A00%22\u0026selectedLayer\u003D%22landcover_class%22\u0026layerView\u003D%22status%22\u0026layerStart\u003D%221984\u002D07\u002D01T00%3A00%3A00%22\u0026layerEnd\u003D%222024\u002D07\u002D01T00%3A00%3A00%22\u0026currentTimestamp\u003D%222024\u002D07\u002D01T00%3A00%3A00%22\u0026pitch\u003D45.997005671225544\u0026bearing\u003D11.999218870754135',
                                            posts: 'temperature',
                                            source: '\u003Ca target\u003D\u0027_blank\u0027 href\u003D\u0027https://newdev.naturesquamish.ca\u0027\u003ESource\u003C/a\u003E',
                                            unit_of_measure: 'kg/m^2',
                                            theme: 'ecosystem\u002Dhealth'  // Add theme ID to each indicator
                                        },
                                    
                                
                                    
                                        {
                                            id: 'precipitation',
                                            title: '2.2.9 Precipitation',
                                            description: 'Precipitation varies considerably across landscapes due to topography and atmospheric circulation patterns. Projected changes in mean annual precipitation (RCP 8.5) affect the distribution of biogeoclimatic zones by shifting suitable habitats throughout the landscape, thereby altering the range and composition of existing ecological communities. While some species can cope with and adapt to these changes, others become increasingly vulnerable to climate variations, leading to population declines and local extinctions.',
                                            icon: 'fa\u002Dleaf',
                                            map1_url: 'https://felt.com/embed/map/S2S\u002DConnectivityModel\u002Dv0p1\u002Dcopy\u002Dmr4RufF9AQM9B5KvTx1IczZC?loc\u003D50.1164%2C\u002D123.0674%2C8.51z\u0026legend\u003D1\u0026cooperativeGestures\u003D1\u0026link\u003D1\u0026geolocation\u003D0\u0026zoomControls\u003D1\u0026scaleBar\u003D1',
                                            map2_url: 'https://cascadia.staging.dashboard.terradapt.org/?zoom\u003D10.57924853633501\u0026lng\u003D\u002D123.16974611514613\u0026lat\u003D49.724616106137404\u0026opacity\u003D0.75\u0026layerTheme\u003D%22landcover%22\u0026layerScope\u003D%22monitor%22\u0026layerVisualisation\u003D%22pixel%22\u0026minTimestamp\u003D%221984\u002D07\u002D01T00%3A00%3A00%22\u0026maxTimestamp\u003D%222024\u002D07\u002D01T00%3A00%3A00%22\u0026selectedLayer\u003D%22landcover_class%22\u0026layerView\u003D%22status%22\u0026layerStart\u003D%221984\u002D07\u002D01T00%3A00%3A00%22\u0026layerEnd\u003D%222024\u002D07\u002D01T00%3A00%3A00%22\u0026currentTimestamp\u003D%222024\u002D07\u002D01T00%3A00%3A00%22\u0026pitch\u003D45.997005671225544\u0026bearing\u003D11.999218870754135',
                                            posts: 'precipitation',
                                            source: '\u003Ca target\u003D\u0027_blank\u0027 href\u003D\u0027https://newdev.naturesquamish.ca\u0027\u003ESource\u003C/a\u003E',
                                            unit_of_measure: 'kg/m^2',
                                            theme: 'ecosystem\u002Dhealth'  // Add theme ID to each indicator
                                        }
                                    
                                
                            ]
                        },
                        
                        {
                            id: 'habitat\u002Dloss\u002Dand\u002Dfragmentation',
                            name: '2.3 Habitat Loss and Fragmentation',
                            description: '\u003Cstrong\u003EHabitat loss and fragmentation\u003C/strong\u003E are two related but distinct concepts in ecology that describe changes in the natural environment caused by the \u003Cstrong\u003Ecumulative effects of landscape disturbance and climate change\u003C/strong\u003E. Habitat loss refers to the \u003Cstrong\u003Epermanent destruction, removal, or temporary degradation\u003C/strong\u003E of terrestrial and freshwater ecosystems. Habitat fragmentation, however, involves \u003Cstrong\u003Ebreaking larger continuous habitats into smaller, isolated patches\u003C/strong\u003E. Both processes \u003Cstrong\u003Edisrupt natural patterns of ecological connectivity\u003C/strong\u003E and are the \u003Cstrong\u003Emain causes of biodiversity loss\u003C/strong\u003E.',
                            indicators: [
                                
                                    
                                        {
                                            id: 'forest\u002Dcover',
                                            title: '2.3.1 Forest Cover',
                                            description: 'Loss and fragmentation of forest ecosystems, primarily due to timber harvesting, agriculture, urbanization and wildfire, are critical indicators of habitat disturbance. Removal of tree cover and understory vegetation eliminates homes, food sources, and breeding grounds for many species, leading to habitat fragmentation. The remaining patches of forest cover become isolated, thereby disrupting natural patterns of wildlife movement and the flow of ecological processes. Fragmentation also decreases the amount of suitable habitat along forest edges and increases vulnerability to the impacts of human activity and invasive species.',
                                            icon: 'fa\u002Dleaf',
                                            map1_url: 'https://felt.com/embed/map/S2S\u002DConnectivityModel\u002Dv0p1\u002Dcopy\u002Dmr4RufF9AQM9B5KvTx1IczZC?loc\u003D50.1164%2C\u002D123.0674%2C8.51z\u0026legend\u003D1\u0026cooperativeGestures\u003D1\u0026link\u003D1\u0026geolocation\u003D0\u0026zoomControls\u003D1\u0026scaleBar\u003D1',
                                            map2_url: 'https://cascadia.staging.dashboard.terradapt.org/?zoom\u003D10.57924853633501\u0026lng\u003D\u002D123.16974611514613\u0026lat\u003D49.724616106137404\u0026opacity\u003D0.75\u0026layerTheme\u003D%22landcover%22\u0026layerScope\u003D%22monitor%22\u0026layerVisualisation\u003D%22pixel%22\u0026minTimestamp\u003D%221984\u002D07\u002D01T00%3A00%3A00%22\u0026maxTimestamp\u003D%222024\u002D07\u002D01T00%3A00%3A00%22\u0026selectedLayer\u003D%22landcover_class%22\u0026layerView\u003D%22status%22\u0026layerStart\u003D%221984\u002D07\u002D01T00%3A00%3A00%22\u0026layerEnd\u003D%222024\u002D07\u002D01T00%3A00%3A00%22\u0026currentTimestamp\u003D%222024\u002D07\u002D01T00%3A00%3A00%22\u0026pitch\u003D45.997005671225544\u0026bearing\u003D11.999218870754135',
                                            posts: 'forest\u002Dcover',
                                            source: '\u003Ca target\u003D\u0027_blank\u0027 href\u003D\u0027https://newdev.naturesquamish.ca\u0027\u003ESource\u003C/a\u003E',
                                            unit_of_measure: 'kg/m^2',
                                            theme: 'ecosystem\u002Dhealth'  // Add theme ID to each indicator
                                        },
                                    
                                
                                    
                                        {
                                            id: 'wetlands\u002Dand\u002Driparian\u002Dareas',
                                            title: '2.3.2 Wetlands \u0026 Riparian Areas',
                                            description: 'Wetlands and riparian areas (vegetation zones along rivers and streams) are highly vulnerable and critical ecosystems that provide essential ecological services and support networks of ecological connectivity for plants and animals. They are hotspots of biodiversity and support the life\u002Dcycle needs for a majority of freshwater and terrestrial species. Degradation and loss of these habitats severely impact nutrient cycles, the provision of food and clean water, the regulation of natural flood cycles and the buffering of climate change impacts. Their loss destroys critical habitats for fish, amphibians, birds, and mammals, threatening species extinction.',
                                            icon: 'fa\u002Dleaf',
                                            map1_url: 'https://felt.com/embed/map/S2S\u002DConnectivityModel\u002Dv0p1\u002Dcopy\u002Dmr4RufF9AQM9B5KvTx1IczZC?loc\u003D50.1164%2C\u002D123.0674%2C8.51z\u0026legend\u003D1\u0026cooperativeGestures\u003D1\u0026link\u003D1\u0026geolocation\u003D0\u0026zoomControls\u003D1\u0026scaleBar\u003D1',
                                            map2_url: 'https://cascadia.staging.dashboard.terradapt.org/?zoom\u003D10.57924853633501\u0026lng\u003D\u002D123.16974611514613\u0026lat\u003D49.724616106137404\u0026opacity\u003D0.75\u0026layerTheme\u003D%22landcover%22\u0026layerScope\u003D%22monitor%22\u0026layerVisualisation\u003D%22pixel%22\u0026minTimestamp\u003D%221984\u002D07\u002D01T00%3A00%3A00%22\u0026maxTimestamp\u003D%222024\u002D07\u002D01T00%3A00%3A00%22\u0026selectedLayer\u003D%22landcover_class%22\u0026layerView\u003D%22status%22\u0026layerStart\u003D%221984\u002D07\u002D01T00%3A00%3A00%22\u0026layerEnd\u003D%222024\u002D07\u002D01T00%3A00%3A00%22\u0026currentTimestamp\u003D%222024\u002D07\u002D01T00%3A00%3A00%22\u0026pitch\u003D45.997005671225544\u0026bearing\u003D11.999218870754135',
                                            posts: 'wetlands\u002Dand\u002Driparian\u002Dareas',
                                            source: '\u003Ca target\u003D\u0027_blank\u0027 href\u003D\u0027https://newdev.naturesquamish.ca\u0027\u003ESource\u003C/a\u003E',
                                            unit_of_measure: 'kg/m^2',
                                            theme: 'ecosystem\u002Dhealth'  // Add theme ID to each indicator
                                        },
                                    
                                
                                    
                                        {
                                            id: 'mesic\u002Dvegetation',
                                            title: '2.3.3 Mesic Vegetation',
                                            description: '\u003Cstrong\u003EPlant communities\u003C/strong\u003E that thrive in \u003Cstrong\u003Esoils with higher moisture and nutrient content\u003C/strong\u003E in areas of \u003Cstrong\u003Egroundwater discharge\u003C/strong\u003E. These include \u003Cstrong\u003Eherbs and shrubs\u003C/strong\u003E that occur in \u003Cstrong\u003Enon\u002Dforested areas\u003C/strong\u003E at mid\u002D and lower\u002Dslope elevations and along \u003Cstrong\u003Evalley bottoms\u003C/strong\u003E. \u003Cstrong\u003EFragmentation and loss\u003C/strong\u003E of these habitats may lead to \u003Cstrong\u003Einstability\u003C/strong\u003E in the flow and provision of \u003Cstrong\u003Eecosystem functions\u003C/strong\u003E (e.g., pollination, food provisioning), which are \u003Cstrong\u003Eessential to a wide range of terrestrial species\u003C/strong\u003E. It may also weaken an ecosystem\u0027s ability to \u003Cstrong\u003Ecope with and adapt to disturbances\u003C/strong\u003E caused by \u003Cstrong\u003Ehuman activity and climate change\u003C/strong\u003E.',
                                            icon: 'fa\u002Dleaf',
                                            map1_url: 'https://felt.com/embed/map/S2S\u002DConnectivityModel\u002Dv0p1\u002Dcopy\u002Dmr4RufF9AQM9B5KvTx1IczZC?loc\u003D50.1164%2C\u002D123.0674%2C8.51z\u0026legend\u003D1\u0026cooperativeGestures\u003D1\u0026link\u003D1\u0026geolocation\u003D0\u0026zoomControls\u003D1\u0026scaleBar\u003D1',
                                            map2_url: 'https://cascadia.staging.dashboard.terradapt.org/?zoom\u003D10.57924853633501\u0026lng\u003D\u002D123.16974611514613\u0026lat\u003D49.724616106137404\u0026opacity\u003D0.75\u0026layerTheme\u003D%22landcover%22\u0026layerScope\u003D%22monitor%22\u0026layerVisualisation\u003D%22pixel%22\u0026minTimestamp\u003D%221984\u002D07\u002D01T00%3A00%3A00%22\u0026maxTimestamp\u003D%222024\u002D07\u002D01T00%3A00%3A00%22\u0026selectedLayer\u003D%22landcover_class%22\u0026layerView\u003D%22status%22\u0026layerStart\u003D%221984\u002D07\u002D01T00%3A00%3A00%22\u0026layerEnd\u003D%222024\u002D07\u002D01T00%3A00%3A00%22\u0026currentTimestamp\u003D%222024\u002D07\u002D01T00%3A00%3A00%22\u0026pitch\u003D45.997005671225544\u0026bearing\u003D11.999218870754135',
                                            posts: 'mesic\u002Dvegetation',
                                            source: '\u003Ca target\u003D\u0027_blank\u0027 href\u003D\u0027https://newdev.naturesquamish.ca\u0027\u003ESource\u003C/a\u003E',
                                            unit_of_measure: 'kg/m^2',
                                            theme: 'ecosystem\u002Dhealth'  // Add theme ID to each indicator
                                        },
                                    
                                
                                    
                                        {
                                            id: 'xeric\u002Dvegetation',
                                            title: '2.3.4 Xeric Vegetation',
                                            description: '\u003Cstrong\u003EPlant communities\u003C/strong\u003E that thrive in \u003Cstrong\u003Esoils with lower moisture and nutrient levels\u003C/strong\u003E. These include \u003Cstrong\u003Eshrublands\u003C/strong\u003E in \u003Cstrong\u003Enon\u002Dforested areas\u003C/strong\u003E exposed to \u003Cstrong\u003Emore sunlight\u003C/strong\u003E and in \u003Cstrong\u003Edrier biogeoclimatic zones\u003C/strong\u003E of the eastern Coast Mountains. These habitats support \u003Cstrong\u003Especies uniquely adapted to extreme climatic conditions\u003C/strong\u003E. \u003Cstrong\u003EFragmentation and loss\u003C/strong\u003E of these habitats may cause \u003Cstrong\u003Esevere disruption of ecosystem functions\u003C/strong\u003E, \u003Cstrong\u003Edesertification\u003C/strong\u003E, and \u003Cstrong\u003Ereduced capacity\u003C/strong\u003E to cope with and adapt to \u003Cstrong\u003Edisturbances\u003C/strong\u003E caused by \u003Cstrong\u003Ehuman activity and climate change\u003C/strong\u003E.',
                                            icon: 'fa\u002Dleaf',
                                            map1_url: 'https://felt.com/embed/map/S2S\u002DConnectivityModel\u002Dv0p1\u002Dcopy\u002Dmr4RufF9AQM9B5KvTx1IczZC?loc\u003D50.1164%2C\u002D123.0674%2C8.51z\u0026legend\u003D1\u0026cooperativeGestures\u003D1\u0026link\u003D1\u0026geolocation\u003D0\u0026zoomControls\u003D1\u0026scaleBar\u003D1',
                                            map2_url: 'https://cascadia.staging.dashboard.terradapt.org/?zoom\u003D10.57924853633501\u0026lng\u003D\u002D123.16974611514613\u0026lat\u003D49.724616106137404\u0026opacity\u003D0.75\u0026layerTheme\u003D%22landcover%22\u0026layerScope\u003D%22monitor%22\u0026layerVisualisation\u003D%22pixel%22\u0026minTimestamp\u003D%221984\u002D07\u002D01T00%3A00%3A00%22\u0026maxTimestamp\u003D%222024\u002D07\u002D01T00%3A00%3A00%22\u0026selectedLayer\u003D%22landcover_class%22\u0026layerView\u003D%22status%22\u0026layerStart\u003D%221984\u002D07\u002D01T00%3A00%3A00%22\u0026layerEnd\u003D%222024\u002D07\u002D01T00%3A00%3A00%22\u0026currentTimestamp\u003D%222024\u002D07\u002D01T00%3A00%3A00%22\u0026pitch\u003D45.997005671225544\u0026bearing\u003D11.999218870754135',
                                            posts: 'xeric\u002Dvegetation',
                                            source: '\u003Ca target\u003D\u0027_blank\u0027 href\u003D\u0027https://newdev.naturesquamish.ca\u0027\u003ESource\u003C/a\u003E',
                                            unit_of_measure: 'kg/m^2',
                                            theme: 'ecosystem\u002Dhealth'  // Add theme ID to each indicator
                                        }
                                    
                                
                            ]
                        }
                        
                    ],
                    description: 'An ecosystem\u0027s overall \u003Cstrong\u003Econdition of health\u003C/strong\u003E in relation to a natural or relatively undisturbed reference state. It is a measure of the ecosystem\u0027s capacity to \u003Cstrong\u003Emaintain biodiversity, ecological functions\u003C/strong\u003E, and to \u003Cstrong\u003Ecope with and adapt to environmental stressors\u003C/strong\u003E over time. \u003Cstrong\u003ELosses in ecosystem health\u003C/strong\u003E help identify areas in need of \u003Cstrong\u003Erestoration\u003C/strong\u003E. \u003Cstrong\u003EGains in ecosystem health\u003C/strong\u003E over time help identify areas that \u003Cstrong\u003Econtribute to biodiversity\u003C/strong\u003E and require \u003Cstrong\u003Eprotection\u003C/strong\u003E.',
                    icon: 'fa\u002Dseedling'

                },
                
                {
                    id: 'biogeoclimatic\u002Dzones',
                    name: '3.0 Biogeoclimatic Zones',
                    subthemes: [
                        
                        {
                            id: 'regional\u002Dzones',
                            name: '3.1 Regional Zones',
                            description: 'The \u003Cstrong\u003ERegional Zone component\u003C/strong\u003E of BC\u0027s Biogeoclimatic Ecosystem Classification (BEC) is a \u003Cstrong\u003Elarge geographic area\u003C/strong\u003E defined by a unique combination of \u003Cstrong\u003Eclimate and physiographic factors\u003C/strong\u003E, and the \u003Cstrong\u003Edominant plant species\u003C/strong\u003E of its old\u002Dgrowth forests (e.g., Coastal Western Hemlock Zone). It provides the \u003Cstrong\u003E\u0022big picture\u0022 framework\u003C/strong\u003E for understanding how \u003Cstrong\u003Eclimate influences ecosystem development and species distribution\u003C/strong\u003E, and allows for the development of \u003Cstrong\u003Elarge\u002Dscale conservation strategies\u003C/strong\u003E, such as identifying \u003Cstrong\u003Erepresentative ecosystems for protection\u003C/strong\u003E and modelling the \u003Cstrong\u003Epotential impacts of climate change\u003C/strong\u003E on vegetation patterns.',
                            indicators: [
                                
                                    
                                        {
                                            id: 'regional\u002Dzones',
                                            title: '3.1.1 Regional Zones',
                                            description: 'Sub\u002Dtheme used as indicator. Waiting description.',
                                            icon: 'fa\u002Dleaf',
                                            map1_url: 'https://felt.com/embed/map/S2S\u002DConnectivityModel\u002Dv0p1\u002Dcopy\u002Dmr4RufF9AQM9B5KvTx1IczZC?loc\u003D50.1164%2C\u002D123.0674%2C8.51z\u0026legend\u003D1\u0026cooperativeGestures\u003D1\u0026link\u003D1\u0026geolocation\u003D0\u0026zoomControls\u003D1\u0026scaleBar\u003D1',
                                            map2_url: 'https://cascadia.staging.dashboard.terradapt.org/?zoom\u003D10.57924853633501\u0026lng\u003D\u002D123.16974611514613\u0026lat\u003D49.724616106137404\u0026opacity\u003D0.75\u0026layerTheme\u003D%22landcover%22\u0026layerScope\u003D%22monitor%22\u0026layerVisualisation\u003D%22pixel%22\u0026minTimestamp\u003D%221984\u002D07\u002D01T00%3A00%3A00%22\u0026maxTimestamp\u003D%222024\u002D07\u002D01T00%3A00%3A00%22\u0026selectedLayer\u003D%22landcover_class%22\u0026layerView\u003D%22status%22\u0026layerStart\u003D%221984\u002D07\u002D01T00%3A00%3A00%22\u0026layerEnd\u003D%222024\u002D07\u002D01T00%3A00%3A00%22\u0026currentTimestamp\u003D%222024\u002D07\u002D01T00%3A00%3A00%22\u0026pitch\u003D45.997005671225544\u0026bearing\u003D11.999218870754135',
                                            posts: 'regional\u002Dzones',
                                            source: '\u003Ca target\u003D\u0027_blank\u0027 href\u003D\u0027https://newdev.naturesquamish.ca\u0027\u003ESource\u003C/a\u003E',
                                            unit_of_measure: 'kg/m^2',
                                            theme: 'biogeoclimatic\u002Dzones'  // Add theme ID to each indicator
                                        }
                                    
                                
                            ]
                        },
                        
                        {
                            id: 'site\u002Dlevel\u002Dvegetation',
                            name: '3.2 Site Level Vegetation',
                            description: 'The \u003Cstrong\u003ESite Level component\u003C/strong\u003E of BC\u0027s Biogeoclimatic Ecosystem Classification (BEC) is defined by \u003Cstrong\u003Eunique combinations\u003C/strong\u003E of understory vegetation, \u003Cstrong\u003Esoil characteristics\u003C/strong\u003E (e.g., moisture and nutrient content), and \u003Cstrong\u003Ephysiographic features\u003C/strong\u003E that influence the \u003Cstrong\u003Estructure and composition of ecological communities\u003C/strong\u003E during successional growth stages following episodes of landscape disturbance. Identifying and mapping the distribution of \u003Cstrong\u003Esite\u002Dlevel vegetation\u003C/strong\u003E is vital for \u003Cstrong\u003Epractical conservation planning\u003C/strong\u003E, as most \u003Cstrong\u003Eon\u002Dthe\u002Dground management decisions\u003C/strong\u003E, like tree species selection for reforestation or defining specific habitat management strategies, happen at this level.',
                            indicators: [
                                
                                    
                                        {
                                            id: 'site\u002Dlevel\u002Dvegetation',
                                            title: '3.2.1 Site Level Vegetation',
                                            description: 'Sub\u002Dtheme used as indicator. Waiting description.',
                                            icon: 'fa\u002Dleaf',
                                            map1_url: 'https://felt.com/embed/map/S2S\u002DConnectivityModel\u002Dv0p1\u002Dcopy\u002Dmr4RufF9AQM9B5KvTx1IczZC?loc\u003D50.1164%2C\u002D123.0674%2C8.51z\u0026legend\u003D1\u0026cooperativeGestures\u003D1\u0026link\u003D1\u0026geolocation\u003D0\u0026zoomControls\u003D1\u0026scaleBar\u003D1',
                                            map2_url: 'https://cascadia.staging.dashboard.terradapt.org/?zoom\u003D10.57924853633501\u0026lng\u003D\u002D123.16974611514613\u0026lat\u003D49.724616106137404\u0026opacity\u003D0.75\u0026layerTheme\u003D%22landcover%22\u0026layerScope\u003D%22monitor%22\u0026layerVisualisation\u003D%22pixel%22\u0026minTimestamp\u003D%221984\u002D07\u002D01T00%3A00%3A00%22\u0026maxTimestamp\u003D%222024\u002D07\u002D01T00%3A00%3A00%22\u0026selectedLayer\u003D%22landcover_class%22\u0026layerView\u003D%22status%22\u0026layerStart\u003D%221984\u002D07\u002D01T00%3A00%3A00%22\u0026layerEnd\u003D%222024\u002D07\u002D01T00%3A00%3A00%22\u0026currentTimestamp\u003D%222024\u002D07\u002D01T00%3A00%3A00%22\u0026pitch\u003D45.997005671225544\u0026bearing\u003D11.999218870754135',
                                            posts: 'site\u002Dlevel\u002Dvegetation',
                                            source: '\u003Ca target\u003D\u0027_blank\u0027 href\u003D\u0027https://newdev.naturesquamish.ca\u0027\u003ESource\u003C/a\u003E',
                                            unit_of_measure: 'kg/m^2',
                                            theme: 'biogeoclimatic\u002Dzones'  // Add theme ID to each indicator
                                        }
                                    
                                
                            ]
                        }
                        
                    ],
                    description: '\u003Cstrong\u003EBC\u0027s Biogeoclimatic Ecosystem Classification (BEC)\u003C/strong\u003E classifies broad forested landscapes and site\u002Dlevel vegetated areas based on similarities in \u003Cstrong\u003Eclimate, geography, and dominant plant and animal communities\u003C/strong\u003E. Each regional zone reflects \u003Cstrong\u003Elong\u002Dterm interactions\u003C/strong\u003E between climate and biology that shape the development of \u003Cstrong\u003Edistinct habitats, ecological niches, and unique species assemblages\u003C/strong\u003E. In landscape ecology, they help \u003Cstrong\u003Eorganize the landscape\u003C/strong\u003E into manageable areas for \u003Cstrong\u003Econservation planning\u003C/strong\u003E and for understanding how \u003Cstrong\u003Eclimate change may shift ecosystems\u003C/strong\u003E at both regional and global scales.',
                    icon: 'fa\u002Dseedling'

                },
                
                {
                    id: 'species\u002Doccurrences',
                    name: '4.0 Species Occurrences',
                    subthemes: [
                        
                        {
                            id: 'mammals',
                            name: '4.1 Mammals',
                            description: '\u003Cstrong\u003EVertebrate animals\u003C/strong\u003E of the class Mammalia are distinguished by having \u003Cstrong\u003Emilk\u002Dproducing mammary glands\u003C/strong\u003E to nourish their young, a \u003Cstrong\u003Elarge neocortex region\u003C/strong\u003E in the brain, \u003Cstrong\u003Ebody fur or hair\u003C/strong\u003E for insulation, and \u003Cstrong\u003Ethree middle ear bones\u003C/strong\u003E that amplify sound and greatly enhance hearing sensitivity. They are \u003Cstrong\u003Eendothermic (warm\u002Dblooded)\u003C/strong\u003E, breathe air, and are \u003Cstrong\u003Equadrupedal\u003C/strong\u003E, with most mammals using four limbs for land movement. More than \u003Cstrong\u003E80 unique species\u003C/strong\u003E are known to inhabit the southwest Coast Mountains, ranging in size from \u003Cstrong\u003Esmall ground squirrels to large\u002Dranging grizzly bears\u003C/strong\u003E.',
                            indicators: [
                                
                                    
                                        {
                                            id: 'mammals',
                                            title: '4.1.1 Mammals',
                                            description: 'Sub\u002Dtheme used as indicator. Waiting description.',
                                            icon: 'fa\u002Dleaf',
                                            map1_url: 'https://felt.com/embed/map/S2S\u002DConnectivityModel\u002Dv0p1\u002Dcopy\u002Dmr4RufF9AQM9B5KvTx1IczZC?loc\u003D50.1164%2C\u002D123.0674%2C8.51z\u0026legend\u003D1\u0026cooperativeGestures\u003D1\u0026link\u003D1\u0026geolocation\u003D0\u0026zoomControls\u003D1\u0026scaleBar\u003D1',
                                            map2_url: 'https://cascadia.staging.dashboard.terradapt.org/?zoom\u003D10.57924853633501\u0026lng\u003D\u002D123.16974611514613\u0026lat\u003D49.724616106137404\u0026opacity\u003D0.75\u0026layerTheme\u003D%22landcover%22\u0026layerScope\u003D%22monitor%22\u0026layerVisualisation\u003D%22pixel%22\u0026minTimestamp\u003D%221984\u002D07\u002D01T00%3A00%3A00%22\u0026maxTimestamp\u003D%222024\u002D07\u002D01T00%3A00%3A00%22\u0026selectedLayer\u003D%22landcover_class%22\u0026layerView\u003D%22status%22\u0026layerStart\u003D%221984\u002D07\u002D01T00%3A00%3A00%22\u0026layerEnd\u003D%222024\u002D07\u002D01T00%3A00%3A00%22\u0026currentTimestamp\u003D%222024\u002D07\u002D01T00%3A00%3A00%22\u0026pitch\u003D45.997005671225544\u0026bearing\u003D11.999218870754135',
                                            posts: 'mammals',
                                            source: '\u003Ca target\u003D\u0027_blank\u0027 href\u003D\u0027https://newdev.naturesquamish.ca\u0027\u003ESource\u003C/a\u003E',
                                            unit_of_measure: 'kg/m^2',
                                            theme: 'species\u002Doccurrences'  // Add theme ID to each indicator
                                        }
                                    
                                
                            ]
                        },
                        
                        {
                            id: 'herptiles',
                            name: '4.2 Herptiles',
                            description: '\u003Cstrong\u003EHerptiles\u003C/strong\u003E are an informal group of vertebrates that includes both \u003Cstrong\u003Eamphibians and reptiles\u003C/strong\u003E found in both \u003Cstrong\u003Eterrestrial and freshwater environments\u003C/strong\u003E. Amphibians (Class Amphibia) are commonly characterized by a \u003Cstrong\u003Elife cycle\u003C/strong\u003E that features an \u003Cstrong\u003Eaquatic larval stage with gills\u003C/strong\u003E and a \u003Cstrong\u003Eterrestrial adult stage with lungs\u003C/strong\u003E. Reptiles (Class Reptilia) are \u003Cstrong\u003Eair\u002Dbreathing, ectothermic (cold\u002Dblooded) vertebrates\u003C/strong\u003E with \u003Cstrong\u003Escaly skin\u003C/strong\u003E, most of which \u003Cstrong\u003Elay eggs on land\u003C/strong\u003E. Over \u003Cstrong\u003E25 distinct species\u003C/strong\u003E are documented in the southwest Coast Mountains, including various \u003Cstrong\u003Etoads, frogs, salamanders, turtles, lizards, and snakes\u003C/strong\u003E.',
                            indicators: [
                                
                                    
                                        {
                                            id: 'herptiles',
                                            title: '4.2.1 Herptiles',
                                            description: 'Sub\u002Dtheme used as indicator. Waiting description.',
                                            icon: 'fa\u002Dleaf',
                                            map1_url: 'https://felt.com/embed/map/S2S\u002DConnectivityModel\u002Dv0p1\u002Dcopy\u002Dmr4RufF9AQM9B5KvTx1IczZC?loc\u003D50.1164%2C\u002D123.0674%2C8.51z\u0026legend\u003D1\u0026cooperativeGestures\u003D1\u0026link\u003D1\u0026geolocation\u003D0\u0026zoomControls\u003D1\u0026scaleBar\u003D1',
                                            map2_url: 'https://cascadia.staging.dashboard.terradapt.org/?zoom\u003D10.57924853633501\u0026lng\u003D\u002D123.16974611514613\u0026lat\u003D49.724616106137404\u0026opacity\u003D0.75\u0026layerTheme\u003D%22landcover%22\u0026layerScope\u003D%22monitor%22\u0026layerVisualisation\u003D%22pixel%22\u0026minTimestamp\u003D%221984\u002D07\u002D01T00%3A00%3A00%22\u0026maxTimestamp\u003D%222024\u002D07\u002D01T00%3A00%3A00%22\u0026selectedLayer\u003D%22landcover_class%22\u0026layerView\u003D%22status%22\u0026layerStart\u003D%221984\u002D07\u002D01T00%3A00%3A00%22\u0026layerEnd\u003D%222024\u002D07\u002D01T00%3A00%3A00%22\u0026currentTimestamp\u003D%222024\u002D07\u002D01T00%3A00%3A00%22\u0026pitch\u003D45.997005671225544\u0026bearing\u003D11.999218870754135',
                                            posts: 'herptiles',
                                            source: '\u003Ca target\u003D\u0027_blank\u0027 href\u003D\u0027https://newdev.naturesquamish.ca\u0027\u003ESource\u003C/a\u003E',
                                            unit_of_measure: 'kg/m^2',
                                            theme: 'species\u002Doccurrences'  // Add theme ID to each indicator
                                        }
                                    
                                
                            ]
                        },
                        
                        {
                            id: 'vascular\u002Dplants',
                            name: '4.3 Vascular Plants',
                            description: '\u003Cstrong\u003EVascular plants (Tracheophyta)\u003C/strong\u003E have \u003Cstrong\u003Especialized vascular tissues (xylem and phloem)\u003C/strong\u003E for transporting water and nutrients, allowing them to \u003Cstrong\u003Egrow taller and more complex\u003C/strong\u003E than non\u002Dvascular plants. They possess \u003Cstrong\u003Etrue roots, stems, and leaves\u003C/strong\u003E. Types include \u003Cstrong\u003Etrees, shrubs, grasses, flowering plants (angiosperms), and ferns\u003C/strong\u003E, many of which produce seeds. Their ability to \u003Cstrong\u003Egrow larger and access resources\u003C/strong\u003E (sunlight, water, nutrients) gives them a \u003Cstrong\u003Ecompetitive advantage\u003C/strong\u003E, making them the \u003Cstrong\u003Edominant group in most terrestrial ecosystems\u003C/strong\u003E. There are \u003Cstrong\u003E60 distinct vascular plant species\u003C/strong\u003E documented in the southwest Coast Mountains.',
                            indicators: [
                                
                                    
                                        {
                                            id: 'vascular\u002Dplants',
                                            title: '4.3.1 Vascular Plants',
                                            description: 'Sub\u002Dtheme used as indicator. Waiting description.',
                                            icon: 'fa\u002Dleaf',
                                            map1_url: 'https://felt.com/embed/map/S2S\u002DConnectivityModel\u002Dv0p1\u002Dcopy\u002Dmr4RufF9AQM9B5KvTx1IczZC?loc\u003D50.1164%2C\u002D123.0674%2C8.51z\u0026legend\u003D1\u0026cooperativeGestures\u003D1\u0026link\u003D1\u0026geolocation\u003D0\u0026zoomControls\u003D1\u0026scaleBar\u003D1',
                                            map2_url: 'https://cascadia.staging.dashboard.terradapt.org/?zoom\u003D10.57924853633501\u0026lng\u003D\u002D123.16974611514613\u0026lat\u003D49.724616106137404\u0026opacity\u003D0.75\u0026layerTheme\u003D%22landcover%22\u0026layerScope\u003D%22monitor%22\u0026layerVisualisation\u003D%22pixel%22\u0026minTimestamp\u003D%221984\u002D07\u002D01T00%3A00%3A00%22\u0026maxTimestamp\u003D%222024\u002D07\u002D01T00%3A00%3A00%22\u0026selectedLayer\u003D%22landcover_class%22\u0026layerView\u003D%22status%22\u0026layerStart\u003D%221984\u002D07\u002D01T00%3A00%3A00%22\u0026layerEnd\u003D%222024\u002D07\u002D01T00%3A00%3A00%22\u0026currentTimestamp\u003D%222024\u002D07\u002D01T00%3A00%3A00%22\u0026pitch\u003D45.997005671225544\u0026bearing\u003D11.999218870754135',
                                            posts: 'vascular\u002Dplants',
                                            source: '\u003Ca target\u003D\u0027_blank\u0027 href\u003D\u0027https://newdev.naturesquamish.ca\u0027\u003ESource\u003C/a\u003E',
                                            unit_of_measure: 'kg/m^2',
                                            theme: 'species\u002Doccurrences'  // Add theme ID to each indicator
                                        }
                                    
                                
                            ]
                        },
                        
                        {
                            id: 'non\u002Dvascular\u002Dplants',
                            name: '4.4 Non\u002DVascular Plants',
                            description: '\u003Cstrong\u003ENon\u002Dvascular plants\u003C/strong\u003E, known informally as \u003Cstrong\u003Ebryophytes\u003C/strong\u003E, include various \u003Cstrong\u003Emosses, liverworts, and hornworts\u003C/strong\u003E. They \u003Cstrong\u003Elack true vascular tissue, roots, stems, and leaves\u003C/strong\u003E, and instead use \u003Cstrong\u003Ehair\u002Dlike rhizoids\u003C/strong\u003E for anchoring and accessing water and nutrients. Bryophytes grow \u003Cstrong\u003Eclose to the ground\u003C/strong\u003E, are typically found in \u003Cstrong\u003Emoist environments\u003C/strong\u003E, and \u003Cstrong\u003Ereproduce through spores\u003C/strong\u003E. They play a \u003Cstrong\u003Ecrucial role in ecological communities\u003C/strong\u003E, acting as \u003Cstrong\u003Epioneer species\u003C/strong\u003E that \u003Cstrong\u003Epromote soil formation\u003C/strong\u003E and \u003Cstrong\u003Eregulate water and nutrient cycles\u003C/strong\u003E. Over \u003Cstrong\u003E280 unique bryophyte species\u003C/strong\u003E have been documented in the southwest Coast Mountains.',
                            indicators: [
                                
                                    
                                        {
                                            id: 'non\u002Dvascular\u002Dplants',
                                            title: '4.4.1 Non\u002DVascular Plants',
                                            description: 'Sub\u002Dtheme used as indicator. Waiting description.',
                                            icon: 'fa\u002Dleaf',
                                            map1_url: 'https://felt.com/embed/map/S2S\u002DConnectivityModel\u002Dv0p1\u002Dcopy\u002Dmr4RufF9AQM9B5KvTx1IczZC?loc\u003D50.1164%2C\u002D123.0674%2C8.51z\u0026legend\u003D1\u0026cooperativeGestures\u003D1\u0026link\u003D1\u0026geolocation\u003D0\u0026zoomControls\u003D1\u0026scaleBar\u003D1',
                                            map2_url: 'https://cascadia.staging.dashboard.terradapt.org/?zoom\u003D10.57924853633501\u0026lng\u003D\u002D123.16974611514613\u0026lat\u003D49.724616106137404\u0026opacity\u003D0.75\u0026layerTheme\u003D%22landcover%22\u0026layerScope\u003D%22monitor%22\u0026layerVisualisation\u003D%22pixel%22\u0026minTimestamp\u003D%221984\u002D07\u002D01T00%3A00%3A00%22\u0026maxTimestamp\u003D%222024\u002D07\u002D01T00%3A00%3A00%22\u0026selectedLayer\u003D%22landcover_class%22\u0026layerView\u003D%22status%22\u0026layerStart\u003D%221984\u002D07\u002D01T00%3A00%3A00%22\u0026layerEnd\u003D%222024\u002D07\u002D01T00%3A00%3A00%22\u0026currentTimestamp\u003D%222024\u002D07\u002D01T00%3A00%3A00%22\u0026pitch\u003D45.997005671225544\u0026bearing\u003D11.999218870754135',
                                            posts: 'non\u002Dvascular\u002Dplants',
                                            source: '\u003Ca target\u003D\u0027_blank\u0027 href\u003D\u0027https://newdev.naturesquamish.ca\u0027\u003ESource\u003C/a\u003E',
                                            unit_of_measure: 'kg/m^2',
                                            theme: 'species\u002Doccurrences'  // Add theme ID to each indicator
                                        }
                                    
                                
                            ]
                        }
                        
                    ],
                    description: '\u003Cstrong\u003EField\u002Dbased observations\u003C/strong\u003E help identify groups of \u003Cstrong\u003Einteracting populations\u003C/strong\u003E of different species living in the same area, as well as the overall characteristics of an \u003Cstrong\u003Eecological community\u003C/strong\u003E. These include \u003Cstrong\u003Especies richness\u003C/strong\u003E (number of species), \u003Cstrong\u003Especies abundance\u003C/strong\u003E (population sizes), \u003Cstrong\u003Etrophic structure\u003C/strong\u003E (food web relationships), and \u003Cstrong\u003Especies interactions\u003C/strong\u003E such as competition and predation. Communities are vital because they form the \u003Cstrong\u003Efunctional units of ecosystems\u003C/strong\u003E and play a key role in \u003Cstrong\u003Enutrient cycling, energy flow, and maintaining ecosystem stability\u003C/strong\u003E.',
                    icon: 'fa\u002Dseedling'

                }
                
            ];

            // DOM Elements
            const themeDropdown = document.getElementById('themeDropdown');
            const subthemeDropdown = document.getElementById('subthemeDropdown');
            const indicatorDropdown = document.getElementById('indicatorDropdown');
            const themeMenu = document.getElementById('themeMenu');
            const subthemeMenu = document.getElementById('subthemeMenu');
            const indicatorMenu = document.getElementById('indicatorMenu');
            const indicatorTitle = document.querySelector('.indicator-title');
            const indicatorDescription = document.querySelector('.indicator-description');
            const indicatorIcon = document.querySelector('.indicator-icon i');
            const map1Iframe = document.getElementById('map1');
            const map2Iframe = document.getElementById('map2');

            // Current selections
            let currentTheme = null;
            let currentSubtheme = null;
            let currentIndicator = null;
            
            // Function to update URL with current state
            function updateURL() {
                const params = new URLSearchParams();
                if (currentTheme) params.set('theme', currentTheme.id);
                if (currentSubtheme) params.set('subtheme', currentSubtheme.id);
                if (currentIndicator) params.set('indicator', currentIndicator.id);
                
                const newUrl = window.location.pathname + (params.toString() ? '?' + params.toString() : '');
                window.history.pushState({}, '', newUrl);
            }
            
            // Function to find theme by ID
            function findThemeById(themeId) {
                return themesData.find(theme => theme.id === themeId);
            }
            
            // Load state from URL parameters
            function loadStateFromURL() {
                const params = new URLSearchParams(window.location.search);
                const themeId = params.get('theme');
                const subthemeId = params.get('subtheme');
                const indicatorId = params.get('indicator');
                
                if (themeId) {
                    const theme = findThemeById(themeId);
                    if (theme) {
                        // Use setTimeout to ensure dropdowns are initialized
                        setTimeout(() => {
                            selectTheme(theme);
                            
                            if (subthemeId) {
                                // Small delay to ensure theme is processed
                                setTimeout(() => {
                                    const subtheme = theme.subthemes.find(s => s.id === subthemeId);
                                    if (subtheme) {
                                        selectSubtheme(subtheme);
                                        
                                        if (indicatorId) {
                                            // Small delay to ensure subtheme is processed
                                            setTimeout(() => {
                                                const indicator = subtheme.indicators.find(i => i.id === indicatorId);
                                                if (indicator) {
                                                    selectIndicator(indicator);
                                                }
                                            }, 100);
                                        }
                                    }
                                }, 100);
                            }
                        }, 100);
                    }
                }
            }
            
            // Handle browser back/forward buttons
            window.addEventListener('popstate', () => {
                loadStateFromURL();
            });

            // Initialize dropdowns and load state from URL
            function initDropdowns() {
                // Load state from URL after a short delay to ensure DOM is ready
                setTimeout(loadStateFromURL, 100);
                // Populate themes
                themesData.forEach(theme => {
                    const item = createDropdownItem(theme.name, 'folder', () => {
                        selectTheme(theme);
                    });
                    themeMenu.appendChild(item);
                });

                // Close dropdowns when clicking outside
                document.addEventListener('click', (e) => {
                    if (!e.target.closest('.dropdown')) {
                        closeAllDropdowns();
                    }
                });

                // Toggle dropdowns on button click
                document.querySelectorAll('.dropdown-toggle').forEach(button => {
                    button.addEventListener('click', function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        const dropdown = this.closest('.dropdown');
                        const isOpen = dropdown.classList.contains('show');
                        closeAllDropdowns();
                        if (!isOpen) {
                            dropdown.classList.add('show');
                        }
                    });
                });
            }

            // Create dropdown item
            function createDropdownItem(text, icon, onClick) {
                const item = document.createElement('a');
                item.href = '#';
                item.className = 'dropdown-item';
                item.innerHTML = `
                    <span>${text}</span>
                `;
                item.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    onClick(e);
                    // Find and close the parent dropdown
                    const dropdown = e.target.closest('.dropdown');
                    if (dropdown && dropdown._dropdownInstance) {
                        dropdown._dropdownInstance.close();
                    } else {
                        // Fallback to close all dropdowns if the instance isn't available
                        closeAllDropdowns();
                    }
                });
                return item;
            }

            // Close all dropdowns
            function closeAllDropdowns() {
                if (typeof Dropdown !== 'undefined' && typeof Dropdown.closeAll === 'function') {
                    Dropdown.closeAll();
                } else {
                    // Fallback for when Dropdown class is not available yet
                    document.querySelectorAll('.dropdown').forEach(dropdown => {
                        dropdown.classList.remove('active');
                        const toggle = dropdown.querySelector('.dropdown-toggle');
                        const chevron = toggle?.querySelector('i.fa-chevron-down');
                        if (toggle) toggle.setAttribute('aria-expanded', 'false');
                        if (chevron) chevron.style.transform = '';
                    });
                }
            }

            // Update theme info box
            function updateThemeInfo(theme) {
                const themeInfo = document.querySelector('.theme-info');
                if (!theme) {
                    themeInfo.innerHTML = `
                        <div class="info-box-title">Theme Information</div>
                        <div class="theme-icon">
                            <i class="fas fa-map-marked-alt"></i>
                        </div>
                        <div class="text-content">
                            <h2 class="theme-title">Map Viewer</h2>
                            <p class="theme-description">Select a theme, subtheme, and indicator to view detailed information.</p>
                        </div>`;
                    return;
                }
                
                themeInfo.innerHTML = `
                    <div class="info-box-title">Theme Information</div>
                    <div class="theme-icon">
                        <i class="fas ${theme.icon}"></i>
                    </div>
                    <div class="text-content">
                        <h2 class="theme-title">${theme.name}</h2>
                        <p class="theme-description">${theme.description}</p>
                    </div>`;
            }

            // Theme selected
            function selectTheme(theme) {
                currentTheme = theme;
                currentSubtheme = null;
                currentIndicator = null;
                
                // Get map elements
                const map1 = document.getElementById('map1');
                const map2 = document.getElementById('map2');
                const mapPlaceholder = document.getElementById('mapPlaceholder');
                
                // Reset map display to show placeholder and hide maps
                if (mapPlaceholder && map1 && map2) {
                    mapPlaceholder.style.display = 'flex';
                    map1.style.display = 'none';
                    map2.style.display = 'none';
                    
                    // Clear map sources
                    map1.src = '';
                    map2.src = '';
                }
                
                // Update theme button
                updateButton(themeDropdown, theme.name, 'folder');
                
                // Reset theme info to default
                const themeInfo = document.querySelector('.theme-info');
                if (themeInfo) {
                    themeInfo.innerHTML = `
                        <div class="info-box-title">Theme Information</div>
                        <div class="theme-icon">
                            <i class="fas ${theme.icon || 'fa-map-marked-alt'}"></i>
                        </div>
                        <div class="text-content">
                            <h2 class="theme-title">${theme.name}</h2>
                            <p class="theme-description">${theme.description}</p>
                        </div>`;
                }
                
                // Reset subtheme dropdown
                updateButton(subthemeDropdown, 'Select Subtheme', 'folder-open');
                
                // Show subtheme dropdown
                subthemeDropdown.style.display = 'block';
                
                // Clear and populate subthemes
                subthemeMenu.innerHTML = '';
                theme.subthemes.forEach(subtheme => {
                    const item = createDropdownItem(subtheme.name, 'folder-open', () => {
                        selectSubtheme(subtheme);
                    });
                    subthemeMenu.appendChild(item);
                });
                
                // Reset and hide indicator dropdown
                updateButton(indicatorDropdown, 'Select Indicator', 'chart-bar');
                indicatorDropdown.style.display = 'none';
                
                // Reset indicator info box to default state
                const indicatorInfo = document.querySelector('.indicator-info');
                if (indicatorInfo) {
                    indicatorInfo.innerHTML = `
                        <div class="info-box-title">Indicator Information</div>
                        <div class="indicator-icon">
                            <i class="icon icon-question"></i>
                        </div>
                        <div class="text-content">
                            <h2 class="indicator-title">Select an Indicator</h2>
                            <p class="indicator-description">Choose a sub-theme first, then select an indicator to view its details.</p>
                        </div>`;
                }
                
                closeAllDropdowns();
            }

            // Subtheme selected
            function selectSubtheme(subtheme) {
                // Reset current indicator
                currentIndicator = null;
                
                // Get map elements
                const map1 = document.getElementById('map1');
                const map2 = document.getElementById('map2');
                const mapPlaceholder = document.getElementById('mapPlaceholder');
                
                // Reset map display to show placeholder and hide maps
                mapPlaceholder.style.display = 'flex';
                map1.style.display = 'none';
                map2.style.display = 'none';
                
                // Clear map sources
                map1.src = '';
                map2.src = '';
                
                // Update current subtheme
                currentSubtheme = subtheme;
                
                // Update subtheme button
                updateButton(subthemeDropdown, subtheme.name, 'folder-open');
                
                // Reset and update indicator button
                updateButton(indicatorDropdown, 'Select Indicator', 'chart-bar');
                
                // Update subtheme info box
                const subthemeInfo = document.querySelector('.subtheme-info');
                if (subthemeInfo) {
                    subthemeInfo.innerHTML = `
                        <div class="info-box-title">Sub-theme Information</div>
                        <div class="subtheme-icon">
                            <i class="fas fa-folder-open"></i>
                        </div>
                        <div class="text-content">
                            <h2 class="subtheme-title">${subtheme.name}</h2>
                            <p class="subtheme-description">${subtheme.description || 'No description available.'}</p>
                        </div>`;
                }
                
                // Reset indicator info box to default state
                const indicatorInfo = document.querySelector('.indicator-info');
                if (indicatorInfo) {
                    indicatorInfo.innerHTML = `
                        <div class="info-box-title">Indicator Information</div>
                        <div class="indicator-icon">
                            <i class="icon icon-question"></i>
                        </div>
                        <div class="text-content">
                            <h2 class="indicator-title">Select an Indicator</h2>
                            <p class="indicator-description">Choose an indicator from the dropdown above to view its details and map.</p>
                        </div>`;
                }
                
                // Show indicator dropdown
                indicatorDropdown.style.display = 'block';
                
                // Clear and populate indicators
                indicatorMenu.innerHTML = '';
                subtheme.indicators.forEach(indicator => {
                    const item = createDropdownItem(indicator.title, indicator.icon.replace('fa-', ''), (e) => {
                        e.preventDefault();
                        e.stopPropagation();
                        selectIndicator(indicator);
                    });
                    indicatorMenu.appendChild(item);
                });
                
                // Close all dropdowns using the Dropdown class if available
                if (window.Dropdown) {
                    Dropdown.closeAll();
                } else {
                    closeAllDropdowns();
                }
                
                // Ensure theme info is still showing the parent theme
                if (currentTheme) {
                    updateThemeInfo(currentTheme);
                }
            }

            // Find theme by ID
            function findThemeById(themeId) {
                return themesData.find(theme => theme.id === themeId);
            }

            // Indicator selected
            function selectIndicator(indicator) {
                currentIndicator = indicator;
                
                // Update indicator button
                updateButton(indicatorDropdown, indicator.title, indicator.icon.replace('fa-', ''));
                
                // Close the dropdown directly using the element's instance
                const dropdownElement = document.querySelector('.dropdown.active');
                if (dropdownElement && dropdownElement._dropdownInstance) {
                    dropdownElement._dropdownInstance.close();
                } else {
                    // Fallback to class-based closing if instance not found
                    document.querySelectorAll('.dropdown').forEach(dropdown => {
                        dropdown.classList.remove('active');
                        const toggle = dropdown.querySelector('.dropdown-toggle');
                        if (toggle) {
                            toggle.setAttribute('aria-expanded', 'false');
                            const chevron = toggle.querySelector('i.fa-chevron-down');
                            if (chevron) chevron.style.transform = '';
                        }
                    });
                }
                
                // Update indicator info box
                const indicatorInfo = document.querySelector('.indicator-info');
                let unitsHtml = indicator.unit_of_measure ? `<span class="indicator-meta-head"><strong>Units:</strong></span><span class="indicator-meta-body"> ${indicator.unit_of_measure}  |  </span>` : '';
                let sourceHtml = indicator.source ? `<span class="indicator-meta-head"><strong>Source:</strong></span><span class="indicator-meta-body"> ${indicator.source}</span>` : '';
                let metaHtml = '';
                
                if (indicator.source || indicator.unit_of_measure) {
                    metaHtml = `<div class="indicator-meta-container">${unitsHtml}${sourceHtml}</div>`;
                }
                
                indicatorInfo.innerHTML = `
                    <div class="info-box-header">
                        <div class="info-box-title">Indicator Information</div>
                        <div class="indicator-icon">
                            <i class="fas ${indicator.icon} indicator-icon"></i>
                        </div>
                    </div>
                    <div class="text-content">
                        <h2 class="indicator-title">${indicator.title}</h2>
                        <p class="indicator-description">${indicator.description}</p>
                        <div class="meta-info">${metaHtml}</div>
                    </div>`;
                
                // Find and update the current theme based on the indicator's theme ID
                if (indicator.theme) {
                    const theme = findThemeById(indicator.theme);
                    if (theme) {
                        currentTheme = theme;
                        updateThemeInfo(theme);
                        // Also update the theme dropdown to show the correct theme
                        updateButton(themeDropdown, theme.name, 'folder');
                    }
                } else if (currentTheme) {
                    // Fallback to current theme if no theme ID in indicator
                    updateThemeInfo(currentTheme);
                }
                
                // Get map elements
                const map1 = document.getElementById('map1');
                const map2 = document.getElementById('map2');
                const mapPlaceholder = document.getElementById('mapPlaceholder');
                
                if (indicator && indicator.map1_url) {
                    // Get the loading spinner
                    const loadingSpinner = document.getElementById('loadingSpinner');
                    
                    // Hide the placeholder and show the loading spinner
                    mapPlaceholder.style.display = 'none';
                    loadingSpinner.style.display = 'flex';
                    
                    // Hide any previously shown map
                    map1.style.display = 'none';
                    
                    // Set up map1 with load event to hide spinner and show map
                    map1.onload = function() {
                        loadingSpinner.style.display = 'none';
                        map1.style.display = 'block';
                    };
                    
                    // Set up error handling
                    map1.onerror = function() {
                        loadingSpinner.style.display = 'none';
                        mapPlaceholder.style.display = 'flex';
                        console.error('Failed to load map');
                    };
                    
                    // Start loading the map after a small delay to ensure spinner is visible
                    setTimeout(() => {
                        map1.src = indicator.map1_url;
                    }, 50);
                    
                    // Set up map2 if URL exists
                    if (indicator.map2_url) {
                        map2.onload = function() {
                            // Additional map2 loaded logic if needed
                        };
                        map2.src = indicator.map2_url;
                        map2.style.display = 'none'; // Will be shown when toggled
                    } else {
                        map2.style.display = 'none';
                    }
                    
                    // Set active view to explore
                    if (exploreLabel) exploreLabel.classList.add('active');
                    if (analyzeLabel) analyzeLabel.classList.remove('active');
                    if (toggleSwitch) toggleSwitch.checked = false;
                    currentView = 'explore';
                } else {
                    // No map URL, show placeholder
                    mapPlaceholder.style.display = 'flex';
                    map1.style.display = 'none';
                    map2.style.display = 'none';
                }
                
                // Update URL without page reload
                window.history.pushState({}, '', indicator.url);
                
                // Close all dropdowns
                if (window.Dropdown) {
                    Dropdown.closeAll();
                } else {
                    closeAllDropdowns();
                }
            }

            // Update dropdown button content
            function updateButton(dropdown, text, icon) {
                const button = dropdown.querySelector('.dropdown-toggle');
                button.innerHTML = `
                    <span>${text}</span>
                    <i class="fas fa-chevron-down" style="font-size: 12px; margin-left: 8px; transition: transform 0.2s ease;"></i>
                `;
            }

            // Initialize the dropdowns
            initDropdowns();
        });
        document.addEventListener('DOMContentLoaded', function() {
          const resourcesButton = document.getElementById('resourcesButton');
          
          resourcesButton.addEventListener('click', function() {
            try {
              // Send a message to the parent window to navigate to the resources section
              window.parent.postMessage({
                type: 'NAVIGATE_TO_RESOURCES',
                target: 'newdev.naturesquamish.ca'  // Target origin for verification
              }, '*');
              
              // Also update the parent URL if we're not in an iframe (for testing)
              if (window === window.top) {
                const currentUrl = window.location.href.split('#')[0];
                window.location.href = currentUrl + '#resources';
              }
            } catch (e) {
              console.error('Error navigating to resources:', e);
            }
          });
          
          // Optional: Listen for a response from the parent
          window.addEventListener('message', function(event) {
            // Verify the message is from a trusted origin
            if (event.origin === 'https://newdev.naturesquamish.ca') {
              if (event.data.type === 'NAVIGATION_COMPLETE') {
                console.log('Successfully navigated to resources section');
              }
            }
          });
        });
      </script>
    </div>


    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Enhanced dropdown functionality
            class Dropdown {
                constructor(element) {
                    this.element = element;
                    this.toggle = element.querySelector('.dropdown-toggle');
                    this.menu = element.querySelector('.dropdown-menu');
                    this.chevron = this.toggle.querySelector('i');
                    this.isOpen = false;
                    this.menuItems = Array.from(this.menu.querySelectorAll('a'));
                    this.focusedIndex = -1;
                    
                    this.initialize();
                }
                
                initialize() {
                    // Add ARIA attributes
                    this.toggle.setAttribute('aria-haspopup', 'true');
                    this.toggle.setAttribute('aria-expanded', 'false');
                    
                    // Toggle dropdown on click
                    this.toggle.addEventListener('click', (e) => this.toggleDropdown(e));
                    
                    // Close when clicking outside
                    document.addEventListener('click', (e) => this.handleOutsideClick(e));
                    
                    // Handle keyboard navigation
                    this.toggle.addEventListener('keydown', (e) => this.handleToggleKeyDown(e));
                    this.menu.addEventListener('keydown', (e) => this.handleMenuKeyDown(e));
                    
                    // Handle menu item interactions
                    this.menuItems.forEach((item, index) => {
                        item.addEventListener('click', () => this.close());
                        item.addEventListener('focus', () => this.focusedIndex = index);
                    });
                }
                
                toggleDropdown(e) {
                    e.stopPropagation();
                    
                    if (this.isOpen) {
                        this.close();
                    } else {
                        this.open();
                    }
                }
                
                open() {
                    if (this.isOpen) return;
                    
                    // Close other dropdowns first
                    Dropdown.closeAll(this);
                    
                    // Open this dropdown
                    this.element.classList.add('active');
                    this.toggle.setAttribute('aria-expanded', 'true');
                    this.chevron.style.transform = 'rotate(180deg)';
                    this.isOpen = true;
                    
                    // Focus first item if available
                    if (this.menuItems.length > 0) {
                        this.focusedIndex = 0;
                        this.menuItems[0].focus();
                    }
                }
                
                close() {
                    if (!this.isOpen) return;
                    
                    this.element.classList.remove('active');
                    this.toggle.setAttribute('aria-expanded', 'false');
                    this.chevron.style.transform = '';
                    this.isOpen = false;
                    this.focusedIndex = -1;
                    
                    // Return focus to toggle
                    this.toggle.focus();
                }
                
                handleOutsideClick(e) {
                    if (!this.element.contains(e.target)) {
                        this.close();
                    }
                }
                
                handleToggleKeyDown(e) {
                    const { key } = e;
                    
                    if (key === 'Enter' || key === ' ' || key === 'ArrowDown' || key === 'Down') {
                        e.preventDefault();
                        this.open();
                    } else if (key === 'Escape') {
                        this.close();
                    } else if (key === 'ArrowUp' || key === 'Up') {
                        e.preventDefault();
                        this.open();
                        if (this.menuItems.length > 0) {
                            this.focusedIndex = this.menuItems.length - 1;
                            this.menuItems[this.focusedIndex].focus();
                        }
                    }
                }
                
                handleMenuKeyDown(e) {
                    const { key } = e;
                    
                    switch (key) {
                        case 'Escape':
                            e.preventDefault();
                            this.close();
                            break;
                            
                        case 'ArrowDown':
                        case 'Down':
                            e.preventDefault();
                            this.focusNextItem();
                            break;
                            
                        case 'ArrowUp':
                        case 'Up':
                            e.preventDefault();
                            this.focusPrevItem();
                            break;
                            
                        case 'Home':
                            e.preventDefault();
                            this.focusItem(0);
                            break;
                            
                        case 'End':
                            e.preventDefault();
                            this.focusItem(this.menuItems.length - 1);
                            break;
                            
                        case 'Tab':
                            if (!e.shiftKey && this.focusedIndex === this.menuItems.length - 1) {
                                // Close dropdown when tabbing out of the last item
                                this.close();
                            } else if (e.shiftKey && this.focusedIndex <= 0) {
                                // Close dropdown when shift+tabbing out of the first item
                                e.preventDefault();
                                this.close();
                            }
                            break;
                    }
                }
                
                focusNextItem() {
                    this.focusedIndex = (this.focusedIndex + 1) % this.menuItems.length;
                    this.menuItems[this.focusedIndex].focus();
                }
                
                focusPrevItem() {
                    this.focusedIndex = (this.focusedIndex - 1 + this.menuItems.length) % this.menuItems.length;
                    this.menuItems[this.focusedIndex].focus();
                }
                
                focusItem(index) {
                    if (index >= 0 && index < this.menuItems.length) {
                        this.focusedIndex = index;
                        this.menuItems[index].focus();
                    }
                }
                
                static closeAll(exceptDropdown = null) {
                    document.querySelectorAll('.dropdown').forEach(dropdown => {
                        const instance = dropdown._dropdownInstance;
                        if (instance && instance !== exceptDropdown) {
                            instance.close();
                        }
                    });
                }
            }
            
            // Initialize all dropdowns on the page
            document.querySelectorAll('.dropdown').forEach(dropdown => {
                dropdown._dropdownInstance = new Dropdown(dropdown);
            });
            
            // Update the map iframe source and show the map
            const map1 = document.getElementById('map1');
            const map2 = document.getElementById('map2');
            const mapPlaceholder = document.getElementById('mapPlaceholder');
            
            if (map1 && map2 && mapPlaceholder) {
                if (subTheme && indicator && indicator.map1_url) {
                    map1.src = indicator.map1_url;
                    // Show map1, hide map2
                    map1.style.display = 'block';
                    map2.style.display = 'none';
                    exploreLabel.classList.add('active');
                    analyzeLabel.classList.remove('active');
                    toggleSwitch.checked = false;
                    currentView = 'explore';
                } else {
                    // Show map2, hide map1
                    map1.style.display = 'none';
                    map2.style.display = 'block';
                    exploreLabel.classList.remove('active');
                    analyzeLabel.classList.add('active');
                    toggleSwitch.checked = true;
                    currentView = 'analyze';
                }
            }

            toggleSwitch.addEventListener('change', function() {
                if (this.checked) {
                    switchView('analyze');
                } else {
                    switchView('explore');
                }
            });

            // Also make the labels clickable
            exploreLabel.addEventListener('click', function() {
                if (currentView !== 'explore') {
                    switchView('explore');
                }
            });

            analyzeLabel.addEventListener('click', function() {
                if (currentView !== 'analyze') {
                    switchView('analyze');
                }
            });

            // Fetch WordPress posts with tag 'indicator one'
            const postsContainer = document.getElementById('postsList');
            const loadingElement = document.getElementById('loadingPosts');
            
            // Debug function to log API responses
            async function debugFetch(url) {
                try {
                    console.log('Fetching:', url);
                    const response = await fetch(url);
                    const data = await response.json();
                    console.log('Response from', url, ':', data);
                    return { response, data };
                } catch (error) {
                    console.error('Error in debugFetch:', error);
                    throw error;
                }
            }
            
            // Function to format date
            function formatDate(dateString) {
                const options = { year: 'numeric', month: 'long', day: 'numeric' };
                return new Date(dateString).toLocaleDateString(undefined, options);
            }
            
            // Function to strip HTML tags and limit excerpt length
            function stripHtml(html, maxLength = 100) {
                const tmp = document.createElement('div');
                tmp.innerHTML = html;
                let text = tmp.textContent || tmp.innerText || '';
                
                // Trim and limit length
                text = text.trim();
                if (text.length > maxLength) {
                    text = text.substring(0, maxLength).trim() + '...';
                }
                return text;
            }

            // Function to create a clean excerpt from content
            function createExcerpt(html) {
                if (!html) return '';
                // Create temporary element to parse HTML
                const tmp = document.createElement('div');
                tmp.innerHTML = html;
                // Get text content and clean it up
                let text = tmp.textContent || tmp.innerText || '';
                // Remove any 'Time to read' patterns
                text = text.replace(/Time\s*to\s*read[^\w]*/gi, '');
                // Clean up the text
                return text
                    .replace(/\s+/g, ' ')      // Replace multiple spaces
                    .trim()                     // Trim whitespace
                    .substring(0, 150)          // Limit length
                    .replace(/\s+\S*$/, '')    // Cut at word boundary
                    .replace(/[\-|:]+$/, '') // Remove trailing punctuation
                    .trim() + '...';            // Add ellipsis
            }

            // Store carousel state to prevent memory leaks
            let carouselState = {
                resizeObserver: null,
                resizeTimeout: null,
                currentIndex: 0,
                cardWidth: 0,
                cards: []
            };

            // Clean up event listeners and observers
            function cleanupCarousel() {
                if (carouselState.resizeObserver) {
                    carouselState.resizeObserver.disconnect();
                }
                window.removeEventListener('resize', handleResize);
                clearTimeout(carouselState.resizeTimeout);
            }

            // Debounced resize handler
            function handleResize() {
                clearTimeout(carouselState.resizeTimeout);
                carouselState.resizeTimeout = setTimeout(() => {
                    updateCarouselSize();
                    updateCarouselPosition();
                }, 100);
            }

            // Update carousel size and card measurements
            function updateCarouselSize() {
                const carousel = document.getElementById('carousel');
                if (!carousel || !carouselState.cards.length) return;
                
                const card = carouselState.cards[0];
                const cardStyle = window.getComputedStyle(card);
                carouselState.cardWidth = card.offsetWidth + 
                    parseInt(cardStyle.marginLeft) + 
                    parseInt(cardStyle.marginRight);
                
                updateCarouselPosition();
            }

            // Update carousel position
            function updateCarouselPosition() {
                const carousel = document.getElementById('carousel');
                if (!carousel) return;
                
                carousel.scrollTo({
                    left: carouselState.currentIndex * carouselState.cardWidth,
                    behavior: 'smooth'
                });
                updateButtons();
            }

            // Update navigation buttons
            function updateButtons() {
                const prevBtn = document.getElementById('prevBtn');
                const nextBtn = document.getElementById('nextBtn');
                if (!prevBtn || !nextBtn) return;
                
                prevBtn.style.display = carouselState.currentIndex === 0 ? 'none' : 'flex';
                nextBtn.style.display = carouselState.currentIndex >= carouselState.cards.length - 1 ? 'none' : 'flex';
            }

            // Initialize carousel
            function initCarousel() {
                cleanupCarousel();
                
                const carousel = document.getElementById('carousel');
                const prevBtn = document.getElementById('prevBtn');
                const nextBtn = document.getElementById('nextBtn');
                
                if (!carousel || !prevBtn || !nextBtn) {
                    console.warn('Carousel elements not found');
                    return;
                }
                
                carouselState.cards = Array.from(document.querySelectorAll('.post-card'));
                if (!carouselState.cards.length) return;
                
                // Initial setup
                updateCarouselSize();
                updateButtons();
                
                // Event listeners
                prevBtn.addEventListener('click', () => {
                    if (carouselState.currentIndex > 0) {
                        carouselState.currentIndex--;
                        updateCarouselPosition();
                    }
                });
                
                nextBtn.addEventListener('click', () => {
                    if (carouselState.currentIndex < carouselState.cards.length - 1) {
                        carouselState.currentIndex++;
                        updateCarouselPosition();
                    }
                });
                
                // Resize observer for better performance
                carouselState.resizeObserver = new ResizeObserver(handleResize);
                carouselState.resizeObserver.observe(document.body);
                
                // Initial position
                updateCarouselPosition();
            }

            // Fetch posts from WordPress REST API with improved error handling
            async function fetchWordPressPosts(indicator) {
                const postsContainer = document.getElementById('posts-container');
                const loadingElement = document.getElementById('loading-indicator');
                
                // Clean up previous carousel
                cleanupCarousel();
                
                // Reset state
                carouselState = {
                    resizeObserver: null,
                    resizeTimeout: null,
                    currentIndex: 0,
                    cardWidth: 0,
                    cards: []
                };
                
                // Show loading state
                if (loadingElement) loadingElement.style.display = 'block';
                if (postsContainer) {
                    postsContainer.innerHTML = '';
                    postsContainer.style.display = 'block';
                }
                
                try {
                    if (!indicator || !indicator.posts) {
                        console.log('No posts filter defined for this indicator');
                        if (postsContainer) postsContainer.innerHTML = '<p>No posts configuration found for this indicator.</p>';
                        return;
                    }

                    // Convert the posts string to a slug format
                    const tagSlug = indicator.posts.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/(^-|-$)/g, '');
                    console.log('Searching for WordPress posts with tag slug:', tagSlug);
                    
                    // Add timeout for the fetch request
                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => controller.abort(), 10000); // 10 second timeout
                    
                    // First, get the tag ID for the indicator's posts
                    const tagResponse = await fetch(
                        `https://newdev.naturesquamish.ca/wp-json/wp/v2/tags?slug=${tagSlug}`,
                        { signal: controller.signal }
                    );
                    clearTimeout(timeoutId);
                    
                    if (!tagResponse.ok) {
                        throw new Error(`HTTP error! status: ${tagResponse.status}`);
                    }
                    
                    const tags = await tagResponse.json();
                    console.log('Found matching tags:', tags);
                    
                    if (!tags || tags.length === 0) {
                        console.warn(`No matching tags found for: ${tagSlug}`);
                        if (postsContainer) postsContainer.innerHTML = `<p>No posts found for: ${indicator.posts}</p>`;
                        return;
                    }
                    
                    const tagId = tags[0].id;
                    console.log(`Found tag ID ${tagId} for "${tagSlug}"`);
                    
                    // Fetch posts with excerpts and featured image
                    const postsResponse = await fetch(
                        `https://newdev.naturesquamish.ca/wp-json/wp/v2/posts?tags=${tagId}` +
                        `&_fields=id,title,link,date,excerpt,featured_media` +
                        `&_embed=wp:featuredmedia` +
                        `&per_page=3`,
                        { signal: controller.signal }
                    );
                    
                    if (!postsResponse.ok) {
                        throw new Error(`Failed to fetch posts: ${postsResponse.statusText}`);
                    }
                    
                    const posts = await postsResponse.json();
                    console.log(`Fetched ${posts.length} posts for tag ID ${tagId}`);
                    
                    if (posts.length === 0) {
                        if (postsContainer) postsContainer.innerHTML = '<p>No updates available at the moment.</p>';
                        return;
                    }
                    
                    // Generate HTML for each post
                    const postsHtml = `
                        <div class="carousel-container" id="carousel">
                            ${posts.map(post => {
                                const featuredImage = post._embedded?.['wp:featuredmedia']?.[0]?.source_url || '';
                                // Use WordPress excerpt directly and clean it up
                                let excerpt = post.excerpt?.rendered ? stripHtml(post.excerpt.rendered) : 'No description available';
                                // Add space after 'Time to read' if it exists
                                excerpt = excerpt.replace(/(Time\s*to\s*read[^<]*)([^\s])/gi, '$1 $2');
                                
                                return `
                                    <article class="post-card">
                                        ${featuredImage ? `<div class="post-image" style="background-image: url('${featuredImage}')"></div>` : ''}
                                        <div class="post-content">
                                            <h3 class="post-title">${post.title.rendered}</h3>
                                            <div class="post-meta">Posted on ${formatDate(post.date)}</div>
                                            ${excerpt ? `<p class="post-excerpt">${excerpt}</p>` : ''}
                                            <a href="${post.link}" class="post-link" target="_blank" rel="noopener noreferrer">Read more </a>
                                        </div>
                                    </article>
                                `;
                            }).join('')}
                        </div>
                        <button id="prevBtn" class="carousel-nav prev" aria-label="Previous"></button>
                        <button id="nextBtn" class="carousel-nav next" aria-label="Next"></button>
                    `;
            
                    // Initialize carousel after posts are loaded
                    if (postsContainer) {
                        // Use requestAnimationFrame for smoother updates
                        requestAnimationFrame(() => {
                            postsContainer.innerHTML = postsHtml;
                            
                            // Initialize carousel on next frame
                            requestAnimationFrame(() => {
                                initCarousel();
                                
                                // Force a reflow to ensure styles are applied
                                void postsContainer.offsetHeight;
                                
                                // Show the container
                                postsContainer.style.opacity = '1';
                            });
                        });
                    }
                    
                    
                } catch (error) {
                    console.error('Error fetching WordPress posts:', error);
                    const errorMessage = error.name === 'AbortError' 
                        ? 'Request timed out. Please check your connection and try again.'
                        : 'Unable to load updates at this time. Please try again later.';
                    
                    if (postsContainer) {
                        postsContainer.innerHTML = `
                            <div class="error-message">
                                <p>${errorMessage}</p>
                                <button onclick="window.location.reload()" class="retry-button">
                                    <i class="fas fa-sync-alt"></i> Retry
                                </button>
                            </div>
                        `;
                    }
                } finally {
                    if (loadingElement) loadingElement.style.display = 'none';
                }
            }
            
            // Fetch posts when the page loads with the current indicator's data
            const currentIndicator = {
                posts: '',
                title: ''
            };
            fetchWordPressPosts(currentIndicator);
        });
    </script>
</body>
</html>
