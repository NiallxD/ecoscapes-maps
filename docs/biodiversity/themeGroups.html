
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Map Viewer - themeGroups</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body, html {
            margin: 0;
            padding: 0;
            height: 100%;
            overflow: hidden;
            font-family: Arial, sans-serif;
        }
        .header-bg {
            background-color: #f8f9fa;
            width: 100%;
        }
        .main-container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: #f8f9fa;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }
        .toolbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 20px;
            height: 60px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            background: white;
            z-index: 100;
        }
        .toolbar-left {
            display: flex;
            align-items: center;
            gap: 20px;
        }
        .toolbar-right {
            display: flex;
            align-items: center;
            gap: 20px;
        }
        .dropdown {
            position: relative;
            display: flex;
            flex-direction: column;
            margin-right: 15px;
            min-width: 200px;
        }
        .dropdown p {
            margin: 0 0 5px 0;
            white-space: nowrap;
            font-size: 12px;
            color: #4a5568;
            font-weight: 500;
        }
        .dropdown-toggle {
            background-color: #ffffff;
            color: #2c3e50;
            padding: 10px 16px;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            cursor: pointer;
            min-width: 220px;
            text-align: left;
            font-size: 15px;
            font-weight: 500;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.2s ease;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }
        .dropdown-toggle:hover {
            border-color: #4CAF50;
            background-color: #f8fafc;
        }
        .dropdown-toggle:focus {
            outline: none;
            border-color: #4CAF50;
            box-shadow: 0 0 0 2px rgba(76, 175, 80, 0.2);
        }
        .dropdown-toggle i {
            margin-left: 8px;
            font-size: 12px;
            transition: transform 0.2s ease;
        }
        .dropdown.active .dropdown-toggle i {
            transform: rotate(180deg);
        }
        .dropdown-menu {
            display: none;
            position: absolute;
            top: 100%;
            left: 0;
            background-color: white;
            min-width: 240px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.12);
            border-radius: 8px;
            z-index: 1000;
            max-height: 400px;
            overflow-y: auto;
            margin-top: 4px;
            border: 1px solid #e9ecef;
        }
        .dropdown.active .dropdown-menu {
            display: block;
        }
        .dropdown-menu a {
            color: #2c3e50;
            padding: 10px 16px;
            text-decoration: none;
            display: block;
            border-bottom: 1px solid #f1f3f5;
            transition: all 0.15s ease;
            font-size: 14px;
        }
        .dropdown-menu a:hover {
            background-color: #f8f9fa;
            padding-left: 20px;
            color: #4CAF50;
        }
        .dropdown-menu a.active {
            background-color: #e8f5e9;
            color: #2e7d32;
            font-weight: 500;
            border-left: 3px solid #4CAF50;
        }
        .toggle-container {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            gap: 8px;
            background: #f8fafc;
            padding: 10px 12px;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
        }
        .toggle-container > div {
            display: flex;
            align-items: center;
            gap: 12px;
            height: 24px;
        }
        .toggle-label {
            font-size: 14px;
            font-weight: 500;
            color: #64748b;
            transition: all 0.2s ease;
        }
        .toggle-label.active {
            color: #166534;
            font-weight: 600;
        }
        .toggle-switch {
            position: relative;
            display: inline-flex;
            width: 50px;
            height: 24px;
            align-items: center;
        }
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #e2e8f0;
            transition: .4s;
            border-radius: 24px;
        }
        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        input:checked + .toggle-slider {
            background-color: #4CAF50;
        }
        input:checked + .toggle-slider:before {
            transform: translateX(26px);
        }
            padding: 20px;
        }
        .top-section {
            display: flex;
            justify-content: space-between;
        }
        .toolbar-top {
            display: flex;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
            padding: 15px 20px;
            border-bottom: 1px solid #edf2f7;
            background-color: #f8fafc;
            border-radius: 20px;
        }
        
        .content-section {
            display: flex;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
            padding: 15px 20px;
            border-bottom: 1px solid #edf2f7;
            margin-bottom: 20px;
            background-color: #f8fafc;
            border-radius: 20px;
        }
        /* ===== Info Box Components ===== */
        /* Container Styles */
        .indicator-info,
        .theme-info {
            display: flex;
            gap: 15px;
            align-items: flex-start;
            width: 100%;
            padding: 0;
            margin: 0;
            min-height: 2.5em;
        }

        /* Icon Base Styles */
        .indicator-icon,
        .theme-icon {
            font-size: 2.5em; /* Slightly reduced from 50px for better scaling */
            color: #4CAF50;
            min-width: 1.5em;
            height: 1.5em;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            opacity: 0.9;
            flex-shrink: 0;
            line-height: 1;
        }

        /* Nested Icons */
        .indicator-icon i,
        .theme-icon i {
            font-size: 1em;
            line-height: inherit;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Hover Effects */
        .indicator-info:hover .indicator-icon,
        .theme-info:hover .theme-icon {
            opacity: 1;
            transform: translateY(-1px);
        }

        /* Text Content */
        .text-content {
            flex: 1;
            padding: 0;
            min-width: 0; /* Prevent flex item overflow */
        }

        /* Title Styles */
        .indicator-title,
        .theme-title {
            margin: 0 0 8px 0;
            color: #1a365d;
            font-size: 1.5em;
            font-weight: 600;
            line-height: 1.3;
        }

        /* Description Styles */
        .indicator-description,
        .theme-description {
            margin: 0;
            color: #4a5568;
            line-height: 1.6;
            font-size: 1em;
            max-width: 100%;
        }
        .map-container {
            flex: 1;
            position: relative;
            background: #f8f9fa;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 400px; /* Ensure minimum height for the container */
        }
        
        .map-placeholder {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: 2rem;
            color: #4a5568;
            width: 100%;
            height: 100%;
        }
        
        .placeholder-content {
            max-width: 500px;
            margin: 0 auto;
        }
        
        .placeholder-content i {
            font-size: 3em;
            color: #4CAF50;
            margin-bottom: 1.5rem;
        }
        
        .placeholder-content h3 {
            color: #2d3748;
            margin-bottom: 1rem;
            font-size: 1.5rem;
            font-weight: 600;
        }
        
        .placeholder-content p {
            color: #718096;
            line-height: 1.6;
            margin: 0;
        }
        .map-iframe {
            width: 100%;
            height: 100%;
            border: none;
            display: none;
        }
        .map-iframe.active {
            display: block;
        }
        body, html {
            margin: 0;
            padding: 0;
            height: 100%;
            overflow: hidden;
            font-family: Arial, sans-serif;
        }
        .header-bg {
            background-color: #f8f9fa;
            width: 100%;
        }
        .main-container {
            max-width: 900px;
            margin: 0 auto;
            background-color: #f8f9fa;
        }
        .toolbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 20px;
            height: 60px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            width: 100%;
            box-sizing: border-box;
            background: white;
        }
        .toolbar-left {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .toolbar-right {
            display: flex;
            align-items: center;
        }
        /* Remove duplicate dropdown styles */
        .dropdown-toggle {
            background-color: #ffffff;
            color: #2c3e50;
            padding: 10px 16px;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            cursor: pointer;
            min-width: 220px;
            text-align: left;
            font-size: 15px;
            font-weight: 500;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.2s ease;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            user-select: none;
        }
        .dropdown-toggle:hover {
            border-color: #4CAF50;
            background-color: #f8fafc;
        }
        .dropdown-toggle:focus {
            outline: none;
            border-color: #4CAF50;
            box-shadow: 0 0 0 2px rgba(76, 175, 80, 0.2);
        }
        .dropdown-toggle i {
            margin-left: 12px;
            font-size: 12px;
            transition: transform 0.2s ease;
        }
        .dropdown.active .dropdown-toggle i {
            transform: rotate(180deg);
        }
        .dropdown-menu {
            display: none;
            position: absolute;
            background-color: white;
            min-width: 240px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.12);
            border-radius: 8px;
            z-index: 1000;
            max-height: 400px;
            overflow-y: auto;
            margin-top: 4px;
            border: 1px solid #e9ecef;
        }
        .dropdown.active .dropdown-menu {
            display: block;
        }
        .dropdown-menu a {
            color: #2c3e50;
            padding: 10px 16px;
            text-decoration: none;
            display: block;
            border-bottom: 1px solid #f1f3f5;
            transition: all 0.15s ease;
            font-size: 14px;
        }
        .dropdown-menu a:hover {
            background-color: #f8f9fa;
            padding-left: 20px;
            color: #4CAF50;
        }
        .dropdown-menu a.active {
            background-color: #e8f5e9;
            color: #2e7d32;
            font-weight: 500;
            border-left: 3px solid #4CAF50;
        }
        .content-area {
            padding: 20px;
            border-bottom: 1px solid #edf2f7;
            width: 100%;
            box-sizing: border-box;
            background: white;
            min-height: 120px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .content-wrapper {
            display: flex;
            align-items: flex-start;
            max-width: 1200px;
            margin: 0 auto;
            gap: 30px;
        }
        .map-container {
            position: relative;
            width: 100%;
            height: calc(100vh - 200px);
        }
        .map-iframe {
            width: 100%;
            height: 100%;
            border: none;
            display: none;
        }
        .map-iframe.active {
            display: block;
        }
        .toggle-container {
            display: flex;
            align-items: center;
            margin-left: 20px;
            gap: 12px;
        }
        .toggle-label {
            font-size: 14px;
            font-weight: 500;
            color: #4a5568;
        }
        .toggle-label.active {
            color: #2c3e50;
            font-weight: 600;
        }
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 30px;
        }
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #e2e8f0;
            transition: .4s;
            border-radius: 34px;
        }
        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 22px;
            width: 22px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        input:checked + .toggle-slider {
            background-color: #4CAF50;
        }
        input:checked + .toggle-slider:before {
            transform: translateX(30px);
        }
        .two-column-section {
            display: flex;
            width: 100%;
            padding: 15px;
            gap: 15px;
            box-sizing: border-box;
        }
        .column-left, .column-right {
            flex: 1;
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.05);
        }
        .indicator-info {
            display: flex;
            gap: 15px;
            margin: 0;
        }
        .text-content {
            flex: 1;
        }
        body, html {
            margin: 0;
            padding: 0;
            height: 100%;
            overflow: hidden;
            font-family: Arial, sans-serif;
        }
        .header-bg {
            background-color: #f8f9fa;
            width: 100%;
        }
        .main-container {
            max-width: 900px;
            margin: 0 auto;
            background-color: #f8f9fa;
        }
        .toolbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 20px;
            height: 60px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            width: 100%;
            box-sizing: border-box;
            background: white;
        }
        .toolbar-left {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .toolbar-right {
            display: flex;
            align-items: center;
        }
        /* Remove duplicate dropdown styles */
        .dropdown-toggle {
            background-color: #ffffff;
            color: #2c3e50;
            padding: 10px 16px;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            cursor: pointer;
            width: 100%;
            text-align: left;
            font-size: 15px;
            font-weight: 500;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.2s ease;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            user-select: none;
            box-sizing: border-box;
        }
        .dropdown-toggle:hover {
            border-color: #4CAF50;
            background-color: #f8fafc;
        }
        .dropdown-toggle:focus {
            outline: none;
            border-color: #4CAF50;
            box-shadow: 0 0 0 2px rgba(76, 175, 80, 0.2);
        }
        .dropdown-toggle i {
            margin-left: 12px;
            font-size: 12px;
            transition: transform 0.2s ease;
        }
        .dropdown.active .dropdown-toggle i {
            transform: rotate(180deg);
        }
        .dropdown-menu {
            display: none;
            position: absolute;
            background-color: white;
            min-width: 240px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.12);
            border-radius: 8px;
            z-index: 1000;
            max-height: 400px;
            overflow-y: auto;
            margin-top: 4px;
            border: 1px solid #e9ecef;
            opacity: 0;
            transform: translateY(-10px);
            transition: opacity 0.15s ease-out, transform 0.15s ease-out;
            pointer-events: none;
            left: 0;
            top: 100%;
        }
        
        .dropdown.active .dropdown-menu {
            display: block;
            opacity: 1;
            transform: translateY(0);
            pointer-events: auto;
        }
        /* Remove fadeIn keyframes as we're using CSS transitions now */
        .dropdown-menu a {
            color: #2c3e50;
            padding: 10px 16px;
            text-decoration: none;
            display: block;
            border-bottom: 1px solid #f1f3f5;
            transition: all 0.15s ease;
            font-size: 14px;
        }
        .dropdown-menu a:hover {
            background-color: #f8f9fa;
            padding-left: 20px;
            color: #4CAF50;
        }
        .dropdown-menu a.active {
            background-color: #e8f5e9;
            color: #2e7d32;
            font-weight: 500;
            border-left: 3px solid #4CAF50;
        }
        .dropdown:hover .dropdown-menu {
            display: block;
        }
        .content-area {
            padding: 20px 20px;
            border-bottom: 1px solid #edf2f7;
            width: 100%;
            box-sizing: border-box;
            background: white;
            min-height: 120px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .content-wrapper {
            display: flex;
            align-items: flex-start;
            max-width: 1200px;
            margin: 0 0 0 -15px;
            gap: 0px;
            width: calc(100% + 15px);
            padding: 5px 0 0 0;
        }
        .icon-container {
            display: flex;
            align-items: flex-start;
            justify-content: center;
            padding-right: 5px;
            padding-left: 0;
            height: 100%;
            padding-top: 5px; /* Align with first line of text */
        }
        .text-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .title-container {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
        }
        .map-container {
            position: relative;
            width: 100%;
            height: calc(100% - 120px); /* Adjust for toolbar and content height */
        }
        .map-iframe {
            width: 100%;
            height: 100%;
            border: none;
            display: none;
        }
        .map-iframe.active {
            display: block;
        }
        .toggle-container {
            display: flex;
            align-items: center;
            margin-left: 20px;
            gap: 12px;
        }
        .toggle-label {
            font-size: 14px;
            font-weight: 500;
            color: #4a5568;
            transition: color 0.2s ease;
        }
        .toggle-label.active {
            color: #2c3e50;
            font-weight: 600;
        }
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 30px;
        }
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        .toggle-slider {
            position: absolute;
            .dropdown-menu {
            position: absolute;
            top: 100%;
            left: 0;
            z-index: 1000;
            display: none;
            float: left;
            min-width: 240px;
            max-height: 70vh;
            overflow-y: auto;
            padding: 0.5rem 0;
            margin: 0.125rem 0 0;
            font-size: 0.9rem;
            color: #2d3748;
            text-align: left;
            list-style: none;
            background-color: #fff;
            background-clip: padding-box;
            border: 1px solid #e2e8f0;
            border-radius: 0.375rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        
        /* Dropdown Submenu Styles */
        .dropdown-submenu {
            position: relative;
        }
        
        .dropdown-submenu > .dropdown-submenu-content {
            display: none;
            position: absolute;
            left: 100%;
            top: 0;
            min-width: 240px;
            max-height: 70vh;
            overflow-y: auto;
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 0.375rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            z-index: 1001;
        }
        
        .dropdown-submenu:hover > .dropdown-submenu-content {
            display: block;
        }
        
        .dropdown-item {
            display: flex;
            align-items: center;
            padding: 0.5rem 1rem;
            color: #2d3748;
            text-decoration: none;
            white-space: nowrap;
            transition: background-color 0.2s;
        }
        
        .dropdown-item:hover {
            background-color: #f7fafc;
        }
        
        .dropdown-item i {
            width: 20px;
            margin-right: 10px;
            color: #4CAF50;
            text-align: center;
        }
        
        .dropdown-item i.fa-chevron-right {
            margin-left: auto;
            font-size: 12px;
            color: #a0aec0;
        }
        
        .dropdown-item.active {
            background-color: #ebf8ff;
            color: #2b6cb0;
        }
        
        .dropdown-divider {
            height: 1px;
            margin: 0.5rem 0;
            overflow: hidden;
            background-color: #e2e8f0;
        }
        input:checked + .toggle-slider {
            background-color: #4CAF50;
        }
        input:checked + .toggle-slider:before {
            transform: translateX(30px);
        }
        input:focus + .toggle-slider {
            box-shadow: 0 0 0 2px rgba(76, 175, 80, 0.3);
        }
        .two-column-section {
            display: flex;
            width: 100%;
            /* padding: 15px 15px;
            background-color: #f8f9fa; */
            padding-bottom: 15px;
            gap: 15px;
            margin: 0;
            box-sizing: border-box;
        }
        body {
            margin: 0;
            padding: 0;
            overflow-x: hidden;
        }
        .column-left {
            flex: 2;
            background: white;
            border-radius: 10px;
            padding: 15px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.05);
            box-sizing: border-box;
        }
        .column-right {
            flex: 2;
            background: white;
            border-radius: 10px;
            padding: 15px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.05);
            box-sizing: border-box;
        }

        .resources-container {
            padding: 20px;
            transition: transform 0.2s ease;
            cursor: pointer;
        }

        .resources-container:hover {
            transform: translateY(-5px);
        }

        .resource-icon {
            font-size: 3em;
            color: #4CAF50;
            margin-bottom: 15px;
        }

        .resource-title {
            margin: 0 0 10px 0;
            color: #2d3748;
            font-size: 1.2em;
            font-weight: 600;
        }

        .resource-description {
            margin: 0;
            color: #718096;
            font-size: 0.9em;
            line-height: 1.4;
        }
        
        .resources-button {
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 8px;
            padding: 20px;
            font-size: 1em;
            font-weight: 500;
            cursor: pointer;
            width: 100%;
            text-align: center;
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 150px;
        }
        
        .resources-button:hover {
            background-color: #3e8e41;
            transform: translateY(-2px);
            box-shadow: 0 6px 8px rgba(0, 0, 0, 0.15);
        }
        
        .resources-button:active {
            transform: translateY(0);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        .toolbar-top {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            padding: 15px 20px;
            background-color: #ffffff;
            border-bottom: 1px solid #e2e8f0;
            gap: 15px;
        }
        
        .dropdown {
            display: flex;
            flex-direction: row;
            align-items: center;
            margin-right: 10px;
            position: relative;
            min-width: 220px;
        }
        
        .dropdown p {
            margin: 0 10px 0 0;
            white-space: nowrap;
            font-size: 14px;
            color: #4a5568;
        }
        .indicator-info {
            display: flex;
            flex-direction: row;
            align-items: flex-start;
            gap: 12px;
            margin-top: 12px;
        }
        .text-content {
            flex: 1;
        }
        .indicator-title {
            margin: 0 0 6px 0;
            color: #1a365d;
            font-size: 1.4em;
            font-weight: 600;
            line-height: 1.2;
        }
        .resource-description {
            margin: 0;
            color: #718096;
            font-size: 0.9em;
            line-height: 1.4;
        }
        
        .resources-button {
            background-color: #4CAF50;
            color: white;
            border: none;
        .dropdown-toggle {
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 10px 16px;
            width: 100%;
            text-align: left;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.95em;
            color: #2d3748;
            transition: all 0.2s ease;
            user-select: none;
        }
        .dropdown-toggle:focus {
            outline: none;
            border-color: #4CAF50;
            box-shadow: 0 0 0 2px rgba(76, 175, 80, 0.2);
        }
        .dropdown-toggle:hover {
            border-color: #4CAF50;
            background-color: #f8fafc;
        }
        .dropdown-menu {
            position: absolute;
            top: calc(100% + 5px);
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            z-index: 1000;
            max-height: 300px;
            overflow-y: auto;
            opacity: 0;
            visibility: hidden;
            transform: translateY(-10px);
            transition: all 0.2s ease;
            pointer-events: none;
        }
        .dropdown.active .dropdown-menu {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
            pointer-events: auto;
        }
        .dropdown-menu a {
            display: flex;
            align-items: center;
            padding: 10px 16px;
            color: #4a5568;
            text-decoration: none;
            transition: all 0.2s ease;
            position: relative;
        }
        .dropdown-menu a:hover,
        .dropdown-menu a:focus,
        .dropdown-menu a.active {
            background: #f0fdf4;
            color: #166534;
            padding-left: 20px;
            outline: none;
        }
        .dropdown-menu a:active {
            background: #dcfce7;
        }
        .toggle-container {
            display: flex;
            flex-direction: column;
            gap: 8px;
            background: #f8fafc;
            padding: 10px 12px;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
        }
        .toggle-container > div {
            display: flex;
            align-items: center;
            gap: 12px;
            height: 24px;
        }
        .toggle-label {
            font-size: 14px;
            font-weight: 500;
            color: #64748b;
            transition: all 0.2s ease;
        }
        .toggle-label.active {
            color: #166534;
            font-weight: 600;
        }
        .content-divider {
            width: 100%;
            padding: 10px 0;
            background-color: #f8f9fa;
            margin: 5px 0;
            overflow: hidden;
            position: relative;
        }
        .posts-container {
            width: 100%;
            margin: 0;
            padding: 5px 0;
            position: relative;
            overflow: hidden;
        }
        
        .post-card {
            flex: 0 0 auto;
            width: calc(100% - 30px);
            max-width: 300px;
            margin: 0 5px;
            scroll-snap-align: start;
            background: white;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .carousel-container {
            display: flex;
            flex-direction: row;
            overflow-x: auto;
            scroll-snap-type: x mandatory;
            scroll-behavior: smooth;
            -webkit-overflow-scrolling: touch;
            padding: 5px 0;
            margin: 0;
            scrollbar-width: none; /* Firefox */
            width: 100%;
            box-sizing: border-box;
            gap: 15px;
        }
        .carousel-container::-webkit-scrollbar {
            display: none; /* Hide scrollbar for Chrome, Safari and Opera */
        }
        .resources-container {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100%;
            padding: 20px;
        }

        .resources-link {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            color: #3182ce;
            text-decoration: none;
            padding: 20px;
            border-radius: 8px;
            transition: all 0.3s ease;
            max-width: 120px;
        }

        .resources-link:hover {
            background-color: #f7fafc;
            transform: translateY(-2px);
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }

        .icon-wrapper {
            background-color: #ebf8ff;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 12px;
            transition: all 0.3s ease;
        }

        .resources-link:hover .icon-wrapper {
            background-color: #bee3f8;
            transform: scale(1.05);
        }

        .resources-link i {
            color: #3182ce;
            font-size: 28px;
        }

        .resources-link span {
            font-size: 14px;
            line-height: 1.3;
            font-weight: 500;
        }

        .post-card {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            padding: 15px;
            flex: 0 0 280px;
            height: 150px;
            scroll-snap-align: start;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        .post-title {
            margin: 0 0 10px 0;
            font-size: 1.1em;
            line-height: 1.3;
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
        }
        .post-meta {
            color: #666;
            font-size: 0.85em;
            margin-bottom: 10px;
        }
        .post-excerpt {
            flex-grow: 1;
            margin: 0 0 10px 0;
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-line-clamp: 4;
            -webkit-box-orient: vertical;
        }
        .post-link {
            color: #007bff;
            text-decoration: none;
            font-size: 0.9em;
            margin-top: auto;
            display: inline-block;
        }
        .carousel-nav {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background: white;
            border: none;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2;
            color: #4CAF50;
            font-size: 16px;
            padding: 0;
        }
        .carousel-nav.prev {
            left: 10px;
        }
        .carousel-nav.next {
            right: 10px;
        }
        .carousel-nav:focus {
            outline: none;
            box-shadow: 0 0 0 2px rgba(76, 175, 80, 0.3);
        }
        .post-title {
            margin: 0 0 6px 0;
            color: #2c3e50;
            font-size: 0.95em;
            line-height: 1.2;
        }
        .post-excerpt {
            color: #4a5568;
            line-height: 1.3;
            margin: 0 0 8px 0;
            font-size: 0.85em;
        }
        .post-meta {
            font-size: 0.75em;
            color: #718096;
            margin-bottom: 6px;
        }
        .post-link {
            color: #4CAF50;
            text-decoration: none;
            font-weight: 500;
            display: inline-block;
            margin-top: 6px;
            font-size: 0.8em;
        }
        .post-link:hover {
            text-decoration: underline;
        }

        /* Carousel Container Styles */
        .carousel-container {
            display: flex;
            overflow-x: auto;
            scroll-snap-type: x mandatory;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none; /* Hide scrollbar for Firefox */
            gap: 20px;
            padding: 10px 0;
            width: 100%;
        }
        
        .carousel-container::-webkit-scrollbar {
            display: none; /* Hide scrollbar for Chrome/Safari */
        }
        
        .resource-button {
            background: none;
            border: none;
            color: #2c3e50;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            padding: 20px;
            border-radius: 8px;
            transition: all 0.2s ease;
            text-align: center;
            width: 100%;
            max-width: 300px;
        }

        .resource-button i {
            color: #4CAF50;
            margin-bottom: 8px;
        }

        .resource-button span {
            font-size: 16px;
            font-weight: 500;
            line-height: 1.4;
        }

        .resource-button:hover {
            background-color: rgba(76, 175, 80, 0.1);
            transform: translateY(-2px);
        }

        .resource-button:active {
            transform: translateY(0);
        }

        .post-card {
            flex: 0 0 auto;
            width: 300px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            overflow: hidden;
            scroll-snap-align: start;
            display: flex;
            flex-direction: column;
        }
        
        .post-image {
            width: 100%;
            height: 160px;
            background-size: cover;
            background-position: center;
        }
        
        .post-content {
            padding: 16px;
            flex: 1;
            display: flex;
            flex-direction: column;
        }
        .loading-posts {
            text-align: center;
            color: #718096;
            padding: 20px;
        }
        .toggle-slider {
            background-color: #4CAF50;
            opacity: 0.7;
        }
        input:checked + .toggle-slider:before {
            transform: translateX(30px);
        }
        input:focus + .toggle-slider {
            box-shadow: 0 0 0 2px rgba(76, 175, 80, 0.3);
        }
    </style>
<base href="./">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>
    <div class="app-container">
      <!-- Top Toolbar with Dropdowns -->
      <div class="toolbar-top">
        <!-- Theme Dropdown -->
        <div class="dropdown" id="themeDropdown">
          <p><strong>Step 1:</strong> Choose a Theme: </p>
          <button class="dropdown-toggle" aria-haspopup="true" aria-expanded="false">
            <span>Select Theme</span>
            <i class="fas fa-chevron-down" style="font-size: 12px; margin-left: 8px; transition: transform 0.2s ease;"></i>
          </button>
          <div class="dropdown-menu" id="themeMenu" role="menu">
            <!-- Will be populated by JavaScript -->
          </div>
        </div>

        <!-- Subtheme Dropdown (initially hidden) -->
        <div class="dropdown" id="subthemeDropdown" style="display: none;">
          <p><strong>Step 2:</strong> Choose a Sub-theme: </p>
          <button class="dropdown-toggle" aria-haspopup="true" aria-expanded="false">
            <span>Select Sub-theme</span>
            <i class="fas fa-chevron-down" style="font-size: 12px; margin-left: 8px; transition: transform 0.2s ease;"></i>
          </button>
          <div class="dropdown-menu" id="subthemeMenu" role="menu">
            <!-- Will be populated by JavaScript -->
          </div>
        </div>

        <!-- Indicator Dropdown (initially hidden) -->
        <div class="dropdown" id="indicatorDropdown" style="display: none;">
          <p><strong>Step 3:</strong> Choose an Indicator: </p>
          <button class="dropdown-toggle" aria-haspopup="true" aria-expanded="false">
            <span>Select Indicator</span>
            <i class="fas fa-chevron-down" style="font-size: 12px; margin-left: 8px; transition: transform 0.2s ease;"></i>
          </button>
          <div class="dropdown-menu" id="indicatorMenu" role="menu">
            <!-- Will be populated by JavaScript -->
          </div>
        </div>

        <div class="toggle-container">
            <div>
              <span id="exploreLabel" class="toggle-label active">Explore</span>
              <label class="toggle-switch">
                <input type="checkbox" id="viewToggle">
                <span class="toggle-slider"></span>
              </label>
              <span id="analyzeLabel" class="toggle-label">Analyze</span>
            </div>
        </div>
          <p><strong>Note:</strong> Not all indicators have time-series data. </p>
      </div>

        <div class="two-column-section">
            <div class="column-left">
              <div class="theme-info">
                <div class="theme-icon">
                  <i class="fas fa-layer-group indicator-icon"></i>
                </div>
                <div class="text-content">
                  <h2 class="theme-title">Select a Theme</h2>
                  <p class="theme-description">Choose a theme from the dropdown to view its details.</p>
                </div>
              </div>
            </div>
            <div class="column-right">
              <!-- Indicator Information -->
              <div class="indicator-info">
                <div class="indicator-icon">
                  <i class="fas fa-chart-bar indicator-icon"></i>
                </div>
                <div class="text-content">
                  <h2 class="indicator-title">Select an Indicator</h2>
                  <p class="indicator-description">Choose a theme and sub-theme first, then select an indicator to view its details.</p>
                </div>
              </div>
            </div>
        </div>
    </div>

      <!-- Map Section -->
    <div class="map-container">
      <div id="mapPlaceholder" class="map-placeholder">
        <div class="placeholder-content">
          <i class="fas fa-map-marked-alt" style="font-size: 3em; margin-bottom: 20px; color: #4CAF50;"></i>
          <h3>Select a Sub-theme and Indicator</h3>
          <p>Please choose a sub-theme from the dropdown menu above, then select an indicator to view the map.</p>
        </div>
      </div>
      <iframe id="map1" class="map-iframe" src="" style="display: none;"></iframe>
      <iframe id="map2" class="map-iframe" src="" style="display: none;"></iframe>
    </div>
    </div>
      
      <script>
        // Define Dropdown class first
        class Dropdown {
            constructor(element) {
                this.element = element;
                this.toggle = element.querySelector('.dropdown-toggle');
                this.menu = element.querySelector('.dropdown-menu');
                this.chevron = this.toggle.querySelector('i');
                this.isOpen = false;
                this.menuItems = Array.from(this.menu.querySelectorAll('a'));
                this.focusedIndex = -1;
                
                this.initialize();
            }
            
            initialize() {
                // Add ARIA attributes
                this.toggle.setAttribute('aria-haspopup', 'true');
                this.toggle.setAttribute('aria-expanded', 'false');
                
                // Toggle dropdown on click
                this.toggle.addEventListener('click', (e) => this.toggleDropdown(e));
                
                // Close when clicking outside
                document.addEventListener('click', (e) => this.handleOutsideClick(e));
                
                // Handle keyboard navigation
                this.toggle.addEventListener('keydown', (e) => this.handleToggleKeyDown(e));
                this.menu.addEventListener('keydown', (e) => this.handleMenuKeyDown(e));
                
                // Handle menu item interactions
                this.menuItems.forEach((item, index) => {
                    item.addEventListener('click', () => this.close());
                    item.addEventListener('focus', () => this.focusedIndex = index);
                });
            }
            
            toggleDropdown(e) {
                e.stopPropagation();
                
                if (this.isOpen) {
                    this.close();
                } else {
                    this.open();
                }
            }
            
            open() {
                if (this.isOpen) return;
                
                // Close other dropdowns first
                Dropdown.closeAll(this);
                
                // Open this dropdown
                this.element.classList.add('active');
                this.toggle.setAttribute('aria-expanded', 'true');
                this.chevron.style.transform = 'rotate(180deg)';
                this.isOpen = true;
                
                // Focus first item if available
                if (this.menuItems.length > 0) {
                    this.focusedIndex = 0;
                    this.menuItems[0].focus();
                }
            }
            
            close() {
                if (!this.isOpen) return;
                
                this.element.classList.remove('active');
                this.toggle.setAttribute('aria-expanded', 'false');
                this.chevron.style.transform = '';
                this.isOpen = false;
                this.focusedIndex = -1;
                
                // Return focus to toggle
                this.toggle.focus();
            }
            
            handleOutsideClick(e) {
                if (!this.element.contains(e.target)) {
                    this.close();
                }
            }
            
            handleToggleKeyDown(e) {
                const { key } = e;
                
                if (key === 'Enter' || key === ' ' || key === 'ArrowDown' || key === 'Down') {
                    e.preventDefault();
                    this.open();
                } else if (key === 'Escape') {
                    this.close();
                } else if (key === 'ArrowUp' || key === 'Up') {
                    e.preventDefault();
                    this.open();
                    if (this.menuItems.length > 0) {
                        this.focusedIndex = this.menuItems.length - 1;
                        this.menuItems[this.focusedIndex].focus();
                    }
                }
            }
            
            handleMenuKeyDown(e) {
                const { key } = e;
                
                switch (key) {
                    case 'Escape':
                        e.preventDefault();
                        this.close();
                        break;
                        
                    case 'ArrowDown':
                    case 'Down':
                        e.preventDefault();
                        this.focusNextItem();
                        break;
                        
                    case 'ArrowUp':
                    case 'Up':
                        e.preventDefault();
                        this.focusPrevItem();
                        break;
                        
                    case 'Home':
                        e.preventDefault();
                        this.focusItem(0);
                        break;
                        
                    case 'End':
                        e.preventDefault();
                        this.focusItem(this.menuItems.length - 1);
                        break;
                        
                    case 'Tab':
                        if (!e.shiftKey && this.focusedIndex === this.menuItems.length - 1) {
                            // Close dropdown when tabbing out of the last item
                            this.close();
                        } else if (e.shiftKey && this.focusedIndex <= 0) {
                            // Close dropdown when shift+tabbing out of the first item
                            e.preventDefault();
                            this.close();
                        }
                        break;
                }
            }
            
            focusNextItem() {
                this.focusedIndex = (this.focusedIndex + 1) % this.menuItems.length;
                this.menuItems[this.focusedIndex].focus();
            }
            
            focusPrevItem() {
                this.focusedIndex = (this.focusedIndex - 1 + this.menuItems.length) % this.menuItems.length;
                this.menuItems[this.focusedIndex].focus();
            }
            
            focusItem(index) {
                if (index >= 0 && index < this.menuItems.length) {
                    this.focusedIndex = index;
                    this.menuItems[index].focus();
                }
            }
            
            static closeAll(exceptDropdown = null) {
                document.querySelectorAll('.dropdown').forEach(dropdown => {
                    const instance = dropdown._dropdownInstance;
                    if (instance && instance !== exceptDropdown) {
                        instance.close();
                    }
                });
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            // Initialize dropdowns
            document.querySelectorAll('.dropdown').forEach(dropdown => {
                dropdown._dropdownInstance = new Dropdown(dropdown);
            });
            
            // Handle map toggle functionality
            const viewToggle = document.getElementById('viewToggle');
            const map1 = document.getElementById('map1');
            const map2 = document.getElementById('map2');
            const exploreLabel = document.getElementById('exploreLabel');
            const analyzeLabel = document.getElementById('analyzeLabel');

            viewToggle.addEventListener('change', function() {
                if (this.checked) {
                    // Switch to map2 (Analyze view)
                    map1.style.display = 'none';
                    map2.style.display = 'block';
                    exploreLabel.classList.remove('active');
                    analyzeLabel.classList.add('active');
                } else {
                    // Switch to map1 (Explore view)
                    map1.style.display = 'block';
                    map2.style.display = 'none';
                    exploreLabel.classList.add('active');
                    analyzeLabel.classList.remove('active');
                }
            });

            // Get all themes data from the template
            const themesData = [
                
                {
                    id: 'ecosystems',
                    name: '1.0 Ecosystems',
                    subthemes: [
                        
                        {
                            id: 'values',
                            name: '1.1 Values',
                            indicators: [
                                
                                    
                                        {
                                            id: 'ecosystem\u002Dhealth',
                                            title: '1.1.1 Ecosystem Health',
                                            description: 'Placeholder description.',
                                            icon: 'fa\u002Dleaf',
                                            map1_url: '',
                                            map2_url: '',
                                            posts: 'ecosystem\u002Dhealth',
                                            theme: 'ecosystems'  // Add theme ID to each indicator
                                        },
                                    
                                
                                    
                                        {
                                            id: 'ecosystem\u002Dresileince',
                                            title: '1.1.2 Ecosystem Resileince',
                                            description: 'Placeholder description.',
                                            icon: 'fa\u002Dleaf',
                                            map1_url: '',
                                            map2_url: '',
                                            posts: 'ecosystem\u002Dresileince',
                                            theme: 'ecosystems'  // Add theme ID to each indicator
                                        },
                                    
                                
                                    
                                        {
                                            id: 'habitat\u002Dsuitability',
                                            title: '1.1.2 Habitat Suitability',
                                            description: 'Placeholder description.',
                                            icon: 'fa\u002Dleaf',
                                            map1_url: '',
                                            map2_url: '',
                                            posts: 'habitat\u002Dsuitability',
                                            theme: 'ecosystems'  // Add theme ID to each indicator
                                        },
                                    
                                
                                    
                                        {
                                            id: 'habitat\u002Dconnectivity',
                                            title: '1.1.4 Habitat Connectivity',
                                            description: 'Placeholder description.',
                                            icon: 'fa\u002Dleaf',
                                            map1_url: '',
                                            map2_url: '',
                                            posts: 'habitat\u002Dconnectivity',
                                            theme: 'ecosystems'  // Add theme ID to each indicator
                                        },
                                    
                                
                                    
                                        {
                                            id: 'ecosystem\u002Dservices',
                                            title: '1.1.5 Ecosystem Services',
                                            description: 'Placeholder description.',
                                            icon: 'fa\u002Dleaf',
                                            map1_url: '',
                                            map2_url: '',
                                            posts: 'ecosystem\u002Dservices',
                                            theme: 'ecosystems'  // Add theme ID to each indicator
                                        }
                                    
                                
                            ]
                        },
                        
                        {
                            id: 'ecosystem\u002Dthreats',
                            name: '1.2 Ecosystem Threats',
                            indicators: [
                                
                                    
                                        {
                                            id: 'landscape\u002Dchange',
                                            title: '1.2.1 Landscape Change',
                                            description: 'Placeholder description.',
                                            icon: 'fa\u002Dleaf',
                                            map1_url: '',
                                            map2_url: '',
                                            posts: 'landscape\u002Dchange',
                                            theme: 'ecosystems'  // Add theme ID to each indicator
                                        },
                                    
                                
                                    
                                        {
                                            id: 'human\u002Dfootprint',
                                            title: '1.2.2 Human Footprint',
                                            description: 'Placeholder description.',
                                            icon: 'fa\u002Dleaf',
                                            map1_url: '',
                                            map2_url: '',
                                            posts: 'human\u002Dfootprint',
                                            theme: 'ecosystems'  // Add theme ID to each indicator
                                        },
                                    
                                
                                    
                                        {
                                            id: 'urbanization',
                                            title: '1.2.3 Urbanization',
                                            description: 'Placeholder description.',
                                            icon: 'fa\u002Dleaf',
                                            map1_url: '',
                                            map2_url: '',
                                            posts: 'urbanization',
                                            theme: 'ecosystems'  // Add theme ID to each indicator
                                        },
                                    
                                
                                    
                                        {
                                            id: 'agricultural\u002Duse',
                                            title: '1.2.4 Agricultural Use',
                                            description: 'Placeholder description.',
                                            icon: 'fa\u002Dleaf',
                                            map1_url: '',
                                            map2_url: '',
                                            posts: 'agricultural\u002Duse',
                                            theme: 'ecosystems'  // Add theme ID to each indicator
                                        },
                                    
                                
                                    
                                        {
                                            id: 'forest\u002Dharvest',
                                            title: '1.2.5 Forest Harvest',
                                            description: 'Placeholder description.',
                                            icon: 'fa\u002Dleaf',
                                            map1_url: '',
                                            map2_url: '',
                                            posts: 'forest\u002Dharvest',
                                            theme: 'ecosystems'  // Add theme ID to each indicator
                                        },
                                    
                                
                                    
                                        {
                                            id: 'forest\u002Dthinning',
                                            title: '1.2.6 Forest Thinning',
                                            description: 'Placeholder description.',
                                            icon: 'fa\u002Dleaf',
                                            map1_url: '',
                                            map2_url: '',
                                            posts: 'forest\u002Dthinning',
                                            theme: 'ecosystems'  // Add theme ID to each indicator
                                        },
                                    
                                
                                    
                                        {
                                            id: 'wildfire',
                                            title: '1.2.7 Wildfire',
                                            description: 'Placeholder description.',
                                            icon: 'fa\u002Dleaf',
                                            map1_url: '',
                                            map2_url: '',
                                            posts: 'wildfire',
                                            theme: 'ecosystems'  // Add theme ID to each indicator
                                        },
                                    
                                
                                    
                                        {
                                            id: 'temperature',
                                            title: '1.2.8 Temperature',
                                            description: 'Placeholder description.',
                                            icon: 'fa\u002Dleaf',
                                            map1_url: '',
                                            map2_url: '',
                                            posts: 'temperature',
                                            theme: 'ecosystems'  // Add theme ID to each indicator
                                        },
                                    
                                
                                    
                                        {
                                            id: 'precipitation',
                                            title: '1.2.9 Precipitation',
                                            description: 'Placeholder description.',
                                            icon: 'fa\u002Dleaf',
                                            map1_url: '',
                                            map2_url: '',
                                            posts: 'precipitation',
                                            theme: 'ecosystems'  // Add theme ID to each indicator
                                        }
                                    
                                
                            ]
                        },
                        
                        {
                            id: 'habitat\u002Dlosses',
                            name: '1.3 Habitat Losses',
                            indicators: [
                                
                                    
                                        {
                                            id: 'forest\u002Dcover',
                                            title: '1.3.1 Forest Cover',
                                            description: 'Placeholder description.',
                                            icon: 'fa\u002Dleaf',
                                            map1_url: '',
                                            map2_url: '',
                                            posts: 'forest\u002Dcover',
                                            theme: 'ecosystems'  // Add theme ID to each indicator
                                        },
                                    
                                
                                    
                                        {
                                            id: 'wetlands\u002Dand\u002Driparian\u002Dareas',
                                            title: '1.3.2 Wetlands \u0026 Riparian Areas',
                                            description: 'Placeholder description.',
                                            icon: 'fa\u002Dleaf',
                                            map1_url: '',
                                            map2_url: '',
                                            posts: 'wetlands\u002Dand\u002Driparian\u002Dareas',
                                            theme: 'ecosystems'  // Add theme ID to each indicator
                                        },
                                    
                                
                                    
                                        {
                                            id: 'mesic\u002Dvegetation',
                                            title: '1.3.3 Mesic Vegetation',
                                            description: 'Placeholder description.',
                                            icon: 'fa\u002Dleaf',
                                            map1_url: '',
                                            map2_url: '',
                                            posts: 'mesic\u002Dvegetation',
                                            theme: 'ecosystems'  // Add theme ID to each indicator
                                        },
                                    
                                
                                    
                                        {
                                            id: 'xeric\u002Dvegetation',
                                            title: '1.3.4 Xeric Vegetation',
                                            description: 'Placeholder description.',
                                            icon: 'fa\u002Dleaf',
                                            map1_url: '',
                                            map2_url: '',
                                            posts: 'xeric\u002Dvegetation',
                                            theme: 'ecosystems'  // Add theme ID to each indicator
                                        }
                                    
                                
                            ]
                        },
                        
                        {
                            id: 'opportunities',
                            name: '1.4 Opportunities',
                            indicators: [
                                
                                    
                                        {
                                            id: 'protected\u002Dareas',
                                            title: '1.4.1 Protected Areas',
                                            description: 'Placeholder description.',
                                            icon: 'fa\u002Dleaf',
                                            map1_url: '',
                                            map2_url: '',
                                            posts: 'protected\u002Dareas',
                                            theme: 'ecosystems'  // Add theme ID to each indicator
                                        },
                                    
                                
                                    
                                        {
                                            id: 'habitat\u002Dprotection',
                                            title: '1.4.2 Habitat Protection',
                                            description: 'Placeholder description.',
                                            icon: 'fa\u002Dleaf',
                                            map1_url: '',
                                            map2_url: '',
                                            posts: 'habitat\u002Dprotection',
                                            theme: 'ecosystems'  // Add theme ID to each indicator
                                        },
                                    
                                
                                    
                                        {
                                            id: 'habitat\u002Drestoration',
                                            title: '1.4.3 Habitat Restoration',
                                            description: 'Placeholder description.',
                                            icon: 'fa\u002Dleaf',
                                            map1_url: '',
                                            map2_url: '',
                                            posts: 'habitat\u002Drestoration',
                                            theme: 'ecosystems'  // Add theme ID to each indicator
                                        },
                                    
                                
                                    
                                        {
                                            id: 'climate\u002Drefugia',
                                            title: '1.4.4 Climate Refugia',
                                            description: 'Placeholder description.',
                                            icon: 'fa\u002Dleaf',
                                            map1_url: '',
                                            map2_url: '',
                                            posts: 'climate\u002Drefugia',
                                            theme: 'ecosystems'  // Add theme ID to each indicator
                                        },
                                    
                                
                                    
                                        {
                                            id: 'climate\u002Dpathways',
                                            title: '1.4.5 Climate Pathways',
                                            description: 'Placeholder description.',
                                            icon: 'fa\u002Dleaf',
                                            map1_url: '',
                                            map2_url: '',
                                            posts: 'climate\u002Dpathways',
                                            theme: 'ecosystems'  // Add theme ID to each indicator
                                        }
                                    
                                
                            ]
                        }
                        
                    ],
                    description: 'Description for Ecosystems.',
                    icon: 'fa\u002Dseedling'

                },
                
                {
                    id: 'ecological\u002Dcommunities',
                    name: '2.0 Ecological Communities',
                    subthemes: [
                        
                        {
                            id: 'tree\u002Dspecies',
                            name: '2.1 Tree Species',
                            indicators: [
                                
                                    
                                        {
                                            id: 'tree\u002Dspecies',
                                            title: '2.1.1 Tree Species',
                                            description: 'Placeholder description.',
                                            icon: 'fa\u002Dleaf',
                                            map1_url: '',
                                            map2_url: '',
                                            posts: 'tree\u002Dspecies',
                                            theme: 'ecological\u002Dcommunities'  // Add theme ID to each indicator
                                        }
                                    
                                
                            ]
                        },
                        
                        {
                            id: 'understory\u002Dvegetation',
                            name: '2.2 Understory Vegetation',
                            indicators: [
                                
                                    
                                        {
                                            id: 'understory\u002Dvegetation',
                                            title: '2.2.1 Understory Vegetation',
                                            description: 'Placeholder description.',
                                            icon: 'fa\u002Dleaf',
                                            map1_url: '',
                                            map2_url: '',
                                            posts: 'understory\u002Dvegetation',
                                            theme: 'ecological\u002Dcommunities'  // Add theme ID to each indicator
                                        }
                                    
                                
                            ]
                        }
                        
                    ],
                    description: 'Description for Ecological Communities.',
                    icon: 'fa\u002Dseedling'

                },
                
                {
                    id: 'individual\u002Dspecies',
                    name: '3.0 Individual Species',
                    subthemes: [
                        
                        {
                            id: 'mammals',
                            name: '3.1 Mammals',
                            indicators: [
                                
                                    
                                        {
                                            id: 'mammals',
                                            title: '3.1.1 Mammals',
                                            description: 'Placeholder description.',
                                            icon: 'fa\u002Dleaf',
                                            map1_url: '',
                                            map2_url: '',
                                            posts: 'mammals',
                                            theme: 'individual\u002Dspecies'  // Add theme ID to each indicator
                                        }
                                    
                                
                            ]
                        },
                        
                        {
                            id: 'herptiles',
                            name: '3.2 Herptiles',
                            indicators: [
                                
                                    
                                        {
                                            id: 'herptiles',
                                            title: '3.1.2 Herptiles',
                                            description: 'Placeholder description.',
                                            icon: 'fa\u002Dleaf',
                                            map1_url: '',
                                            map2_url: '',
                                            posts: 'herptiles',
                                            theme: 'individual\u002Dspecies'  // Add theme ID to each indicator
                                        }
                                    
                                
                            ]
                        },
                        
                        {
                            id: 'vascular\u002Dplants',
                            name: '3.3 Vascular Plants',
                            indicators: [
                                
                                    
                                        {
                                            id: 'vascular\u002Dplants',
                                            title: '3.1.3 Vascular Plants',
                                            description: 'Placeholder description.',
                                            icon: 'fa\u002Dleaf',
                                            map1_url: '',
                                            map2_url: '',
                                            posts: 'vascular\u002Dplants',
                                            theme: 'individual\u002Dspecies'  // Add theme ID to each indicator
                                        }
                                    
                                
                            ]
                        },
                        
                        {
                            id: 'bryophytes',
                            name: '3.4 Bryophytes',
                            indicators: [
                                
                                    
                                        {
                                            id: 'bryophytes',
                                            title: '3.1.4 Bryophytes',
                                            description: 'Placeholder description.',
                                            icon: 'fa\u002Dleaf',
                                            map1_url: '',
                                            map2_url: '',
                                            posts: 'bryophytes',
                                            theme: 'individual\u002Dspecies'  // Add theme ID to each indicator
                                        }
                                    
                                
                            ]
                        }
                        
                    ],
                    description: 'Description for Individual Species.',
                    icon: 'fa\u002Dseedling'

                }
                
            ];

            // DOM Elements
            const themeDropdown = document.getElementById('themeDropdown');
            const subthemeDropdown = document.getElementById('subthemeDropdown');
            const indicatorDropdown = document.getElementById('indicatorDropdown');
            const themeMenu = document.getElementById('themeMenu');
            const subthemeMenu = document.getElementById('subthemeMenu');
            const indicatorMenu = document.getElementById('indicatorMenu');
            const indicatorTitle = document.querySelector('.indicator-title');
            const indicatorDescription = document.querySelector('.indicator-description');
            const indicatorIcon = document.querySelector('.indicator-icon i');
            const map1Iframe = document.getElementById('map1');
            const map2Iframe = document.getElementById('map2');

            // Current selections
            let currentTheme = null;
            let currentSubtheme = null;
            let currentIndicator = null;
            
            // Function to update URL with current state
            function updateURL() {
                const params = new URLSearchParams();
                if (currentTheme) params.set('theme', currentTheme.id);
                if (currentSubtheme) params.set('subtheme', currentSubtheme.id);
                if (currentIndicator) params.set('indicator', currentIndicator.id);
                
                const newUrl = window.location.pathname + (params.toString() ? '?' + params.toString() : '');
                window.history.pushState({}, '', newUrl);
            }
            
            // Function to find theme by ID
            function findThemeById(themeId) {
                return themesData.find(theme => theme.id === themeId);
            }
            
            // Load state from URL parameters
            function loadStateFromURL() {
                const params = new URLSearchParams(window.location.search);
                const themeId = params.get('theme');
                const subthemeId = params.get('subtheme');
                const indicatorId = params.get('indicator');
                
                if (themeId) {
                    const theme = findThemeById(themeId);
                    if (theme) {
                        // Use setTimeout to ensure dropdowns are initialized
                        setTimeout(() => {
                            selectTheme(theme);
                            
                            if (subthemeId) {
                                // Small delay to ensure theme is processed
                                setTimeout(() => {
                                    const subtheme = theme.subthemes.find(s => s.id === subthemeId);
                                    if (subtheme) {
                                        selectSubtheme(subtheme);
                                        
                                        if (indicatorId) {
                                            // Small delay to ensure subtheme is processed
                                            setTimeout(() => {
                                                const indicator = subtheme.indicators.find(i => i.id === indicatorId);
                                                if (indicator) {
                                                    selectIndicator(indicator);
                                                }
                                            }, 100);
                                        }
                                    }
                                }, 100);
                            }
                        }, 100);
                    }
                }
            }
            
            // Handle browser back/forward buttons
            window.addEventListener('popstate', () => {
                loadStateFromURL();
            });

            // Initialize dropdowns and load state from URL
            function initDropdowns() {
                // Load state from URL after a short delay to ensure DOM is ready
                setTimeout(loadStateFromURL, 100);
                // Populate themes
                themesData.forEach(theme => {
                    const item = createDropdownItem(theme.name, 'folder', () => {
                        selectTheme(theme);
                    });
                    themeMenu.appendChild(item);
                });

                // Close dropdowns when clicking outside
                document.addEventListener('click', (e) => {
                    if (!e.target.closest('.dropdown')) {
                        closeAllDropdowns();
                    }
                });

                // Toggle dropdowns on button click
                document.querySelectorAll('.dropdown-toggle').forEach(button => {
                    button.addEventListener('click', function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        const dropdown = this.closest('.dropdown');
                        const isOpen = dropdown.classList.contains('show');
                        closeAllDropdowns();
                        if (!isOpen) {
                            dropdown.classList.add('show');
                        }
                    });
                });
            }

            // Create dropdown item
            function createDropdownItem(text, icon, onClick) {
                const item = document.createElement('a');
                item.href = '#';
                item.className = 'dropdown-item';
                item.innerHTML = `
                    <i class="fas fa-${icon}"></i>
                    <span>${text}</span>
                `;
                item.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    onClick(e);
                    // The Dropdown class will handle closing the dropdown
                    // when an item is clicked (see line 1711-1713)
                });
                return item;
            }

            // Close all dropdowns
            function closeAllDropdowns() {
                if (typeof Dropdown !== 'undefined' && typeof Dropdown.closeAll === 'function') {
                    Dropdown.closeAll();
                } else {
                    // Fallback for when Dropdown class is not available yet
                    document.querySelectorAll('.dropdown').forEach(dropdown => {
                        dropdown.classList.remove('active');
                        const toggle = dropdown.querySelector('.dropdown-toggle');
                        const chevron = toggle?.querySelector('i.fa-chevron-down');
                        if (toggle) toggle.setAttribute('aria-expanded', 'false');
                        if (chevron) chevron.style.transform = '';
                    });
                }
            }

            // Update theme info box
            function updateThemeInfo(theme) {
                const themeInfo = document.querySelector('.theme-info');
                if (!theme) {
                    themeInfo.innerHTML = `
                        <div class="theme-icon">
                            <i class="fas fa-map-marked-alt"></i>
                        </div>
                        <div class="text-content">
                            <h2 class="theme-title">Map Viewer</h2>
                            <p class="theme-description">Select a theme, subtheme, and indicator to view detailed information.</p>
                        </div>`;
                    return;
                }
                
                themeInfo.innerHTML = `
                    <div class="theme-icon">
                        <i class="fas ${theme.icon}"></i>
                    </div>
                    <div class="text-content">
                        <h2 class="theme-title">${theme.name}</h2>
                        <p class="theme-description">${theme.description}</p>
                    </div>`;
            }

            // Theme selected
            function selectTheme(theme) {
                currentTheme = theme;
                currentSubtheme = null;
                currentIndicator = null;
                
                // Update theme button
                updateButton(themeDropdown, theme.name, 'folder');
                
                // Update theme info box
                updateThemeInfo(theme);
                
                // Reset subtheme dropdown
                updateButton(subthemeDropdown, 'Select Subtheme', 'folder-open');
                
                // Show subtheme dropdown
                subthemeDropdown.style.display = 'block';
                
                // Clear and populate subthemes
                subthemeMenu.innerHTML = '';
                theme.subthemes.forEach(subtheme => {
                    const item = createDropdownItem(subtheme.name, 'folder-open', () => {
                        selectSubtheme(subtheme);
                    });
                    subthemeMenu.appendChild(item);
                });
                
                // Reset and hide indicator dropdown
                updateButton(indicatorDropdown, 'Select Indicator', 'chart-bar');
                indicatorDropdown.style.display = 'none';
                
                closeAllDropdowns();
            }

            // Subtheme selected
            function selectSubtheme(subtheme) {
                // Reset current indicator
                currentIndicator = null;
                
                // Get map elements
                const map1 = document.getElementById('map1');
                const map2 = document.getElementById('map2');
                const mapPlaceholder = document.getElementById('mapPlaceholder');
                
                // Reset map display to show placeholder and hide maps
                mapPlaceholder.style.display = 'flex';
                map1.style.display = 'none';
                map2.style.display = 'none';
                
                // Clear map sources
                map1.src = '';
                map2.src = '';
                
                // Update current subtheme
                currentSubtheme = subtheme;
                
                // Update subtheme button
                updateButton(subthemeDropdown, subtheme.name, 'folder-open');
                
                // Reset and update indicator button
                updateButton(indicatorDropdown, 'Select Indicator', 'chart-bar');
                
                // Reset indicator info
                indicatorTitle.textContent = 'Select an Indicator';
                indicatorDescription.textContent = 'Choose an indicator from the dropdown above to view its details and map.';
                indicatorIcon.className = 'fas fa-chart-bar';
                
                // Show indicator dropdown
                indicatorDropdown.style.display = 'block';
                
                // Clear and populate indicators
                indicatorMenu.innerHTML = '';
                subtheme.indicators.forEach(indicator => {
                    const item = createDropdownItem(indicator.title, indicator.icon.replace('fa-', ''), (e) => {
                        e.preventDefault();
                        e.stopPropagation();
                        selectIndicator(indicator);
                    });
                    indicatorMenu.appendChild(item);
                });
                
                // Close all dropdowns using the Dropdown class if available
                if (window.Dropdown) {
                    Dropdown.closeAll();
                } else {
                    closeAllDropdowns();
                }
                
                // Ensure theme info is still showing the parent theme
                if (currentTheme) {
                    updateThemeInfo(currentTheme);
                }
            }

            // Find theme by ID
            function findThemeById(themeId) {
                return themesData.find(theme => theme.id === themeId);
            }

            // Indicator selected
            function selectIndicator(indicator) {
                currentIndicator = indicator;
                
                // Update indicator button
                updateButton(indicatorDropdown, indicator.title, indicator.icon.replace('fa-', ''));
                
                // Update indicator info box
                const indicatorInfo = document.querySelector('.indicator-info');
                indicatorInfo.innerHTML = `
                    <div class="indicator-icon">
                        <i class="fas ${indicator.icon} indicator-icon"></i>
                    </div>
                    <div class="text-content">
                        <h2 class="indicator-title">${indicator.title}</h2>
                        <p class="indicator-description">${indicator.description}</p>
                    </div>`;
                
                // Find and update the current theme based on the indicator's theme ID
                if (indicator.theme) {
                    const theme = findThemeById(indicator.theme);
                    if (theme) {
                        currentTheme = theme;
                        updateThemeInfo(theme);
                        // Also update the theme dropdown to show the correct theme
                        updateButton(themeDropdown, theme.name, 'folder');
                    }
                } else if (currentTheme) {
                    // Fallback to current theme if no theme ID in indicator
                    updateThemeInfo(currentTheme);
                }
                
                // Get map elements
                const map1 = document.getElementById('map1');
                const map2 = document.getElementById('map2');
                const mapPlaceholder = document.getElementById('mapPlaceholder');
                
                if (indicator && indicator.map1_url) {
                    // Hide placeholder and show map1
                    mapPlaceholder.style.display = 'none';
                    map1.src = indicator.map1_url;
                    map1.style.display = 'block';
                    
                    // Set up map2 if URL exists
                    if (indicator.map2_url) {
                        map2.src = indicator.map2_url;
                        map2.style.display = 'none'; // Will be shown when toggled
                    } else {
                        map2.style.display = 'none';
                    }
                    
                    // Set active view to explore
                    if (exploreLabel) exploreLabel.classList.add('active');
                    if (analyzeLabel) analyzeLabel.classList.remove('active');
                    if (toggleSwitch) toggleSwitch.checked = false;
                    currentView = 'explore';
                } else {
                    // No map URL, show placeholder
                    mapPlaceholder.style.display = 'flex';
                    map1.style.display = 'none';
                    map2.style.display = 'none';
                }
                
                // Update URL without page reload
                window.history.pushState({}, '', indicator.url);
                
                // Close all dropdowns
                if (window.Dropdown) {
                    Dropdown.closeAll();
                } else {
                    closeAllDropdowns();
                }
            }

            // Update dropdown button content
            function updateButton(dropdown, text, icon) {
                const button = dropdown.querySelector('.dropdown-toggle');
                button.innerHTML = `
                    <span>${text}</span>
                    <i class="fas fa-${icon}"></i>
                    <i class="fas fa-chevron-down" style="font-size: 12px; margin-left: 8px; transition: transform 0.2s ease;"></i>
                `;
            }

            // Initialize the dropdowns
            initDropdowns();
        });
        document.addEventListener('DOMContentLoaded', function() {
          const resourcesButton = document.getElementById('resourcesButton');
          
          resourcesButton.addEventListener('click', function() {
            try {
              // Send a message to the parent window to navigate to the resources section
              window.parent.postMessage({
                type: 'NAVIGATE_TO_RESOURCES',
                target: 'newdev.naturesquamish.ca'  // Target origin for verification
              }, '*');
              
              // Also update the parent URL if we're not in an iframe (for testing)
              if (window === window.top) {
                const currentUrl = window.location.href.split('#')[0];
                window.location.href = currentUrl + '#resources';
              }
            } catch (e) {
              console.error('Error navigating to resources:', e);
            }
          });
          
          // Optional: Listen for a response from the parent
          window.addEventListener('message', function(event) {
            // Verify the message is from a trusted origin
            if (event.origin === 'https://newdev.naturesquamish.ca') {
              if (event.data.type === 'NAVIGATION_COMPLETE') {
                console.log('Successfully navigated to resources section');
              }
            }
          });
        });
      </script>
    </div>
    <div class="map-container">
        <iframe id="map1" class="map-iframe active" src=""></iframe>
        <iframe id="map2" class="map-iframe" src=""></iframe>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Enhanced dropdown functionality
            class Dropdown {
                constructor(element) {
                    this.element = element;
                    this.toggle = element.querySelector('.dropdown-toggle');
                    this.menu = element.querySelector('.dropdown-menu');
                    this.chevron = this.toggle.querySelector('i');
                    this.isOpen = false;
                    this.menuItems = Array.from(this.menu.querySelectorAll('a'));
                    this.focusedIndex = -1;
                    
                    this.initialize();
                }
                
                initialize() {
                    // Add ARIA attributes
                    this.toggle.setAttribute('aria-haspopup', 'true');
                    this.toggle.setAttribute('aria-expanded', 'false');
                    
                    // Toggle dropdown on click
                    this.toggle.addEventListener('click', (e) => this.toggleDropdown(e));
                    
                    // Close when clicking outside
                    document.addEventListener('click', (e) => this.handleOutsideClick(e));
                    
                    // Handle keyboard navigation
                    this.toggle.addEventListener('keydown', (e) => this.handleToggleKeyDown(e));
                    this.menu.addEventListener('keydown', (e) => this.handleMenuKeyDown(e));
                    
                    // Handle menu item interactions
                    this.menuItems.forEach((item, index) => {
                        item.addEventListener('click', () => this.close());
                        item.addEventListener('focus', () => this.focusedIndex = index);
                    });
                }
                
                toggleDropdown(e) {
                    e.stopPropagation();
                    
                    if (this.isOpen) {
                        this.close();
                    } else {
                        this.open();
                    }
                }
                
                open() {
                    if (this.isOpen) return;
                    
                    // Close other dropdowns first
                    Dropdown.closeAll(this);
                    
                    // Open this dropdown
                    this.element.classList.add('active');
                    this.toggle.setAttribute('aria-expanded', 'true');
                    this.chevron.style.transform = 'rotate(180deg)';
                    this.isOpen = true;
                    
                    // Focus first item if available
                    if (this.menuItems.length > 0) {
                        this.focusedIndex = 0;
                        this.menuItems[0].focus();
                    }
                }
                
                close() {
                    if (!this.isOpen) return;
                    
                    this.element.classList.remove('active');
                    this.toggle.setAttribute('aria-expanded', 'false');
                    this.chevron.style.transform = '';
                    this.isOpen = false;
                    this.focusedIndex = -1;
                    
                    // Return focus to toggle
                    this.toggle.focus();
                }
                
                handleOutsideClick(e) {
                    if (!this.element.contains(e.target)) {
                        this.close();
                    }
                }
                
                handleToggleKeyDown(e) {
                    const { key } = e;
                    
                    if (key === 'Enter' || key === ' ' || key === 'ArrowDown' || key === 'Down') {
                        e.preventDefault();
                        this.open();
                    } else if (key === 'Escape') {
                        this.close();
                    } else if (key === 'ArrowUp' || key === 'Up') {
                        e.preventDefault();
                        this.open();
                        if (this.menuItems.length > 0) {
                            this.focusedIndex = this.menuItems.length - 1;
                            this.menuItems[this.focusedIndex].focus();
                        }
                    }
                }
                
                handleMenuKeyDown(e) {
                    const { key } = e;
                    
                    switch (key) {
                        case 'Escape':
                            e.preventDefault();
                            this.close();
                            break;
                            
                        case 'ArrowDown':
                        case 'Down':
                            e.preventDefault();
                            this.focusNextItem();
                            break;
                            
                        case 'ArrowUp':
                        case 'Up':
                            e.preventDefault();
                            this.focusPrevItem();
                            break;
                            
                        case 'Home':
                            e.preventDefault();
                            this.focusItem(0);
                            break;
                            
                        case 'End':
                            e.preventDefault();
                            this.focusItem(this.menuItems.length - 1);
                            break;
                            
                        case 'Tab':
                            if (!e.shiftKey && this.focusedIndex === this.menuItems.length - 1) {
                                // Close dropdown when tabbing out of the last item
                                this.close();
                            } else if (e.shiftKey && this.focusedIndex <= 0) {
                                // Close dropdown when shift+tabbing out of the first item
                                e.preventDefault();
                                this.close();
                            }
                            break;
                    }
                }
                
                focusNextItem() {
                    this.focusedIndex = (this.focusedIndex + 1) % this.menuItems.length;
                    this.menuItems[this.focusedIndex].focus();
                }
                
                focusPrevItem() {
                    this.focusedIndex = (this.focusedIndex - 1 + this.menuItems.length) % this.menuItems.length;
                    this.menuItems[this.focusedIndex].focus();
                }
                
                focusItem(index) {
                    if (index >= 0 && index < this.menuItems.length) {
                        this.focusedIndex = index;
                        this.menuItems[index].focus();
                    }
                }
                
                static closeAll(exceptDropdown = null) {
                    document.querySelectorAll('.dropdown').forEach(dropdown => {
                        const instance = dropdown._dropdownInstance;
                        if (instance && instance !== exceptDropdown) {
                            instance.close();
                        }
                    });
                }
            }
            
            // Initialize all dropdowns on the page
            document.querySelectorAll('.dropdown').forEach(dropdown => {
                dropdown._dropdownInstance = new Dropdown(dropdown);
            });
            
            // Update the map iframe source and show the map
            const map1 = document.getElementById('map1');
            const map2 = document.getElementById('map2');
            const mapPlaceholder = document.getElementById('mapPlaceholder');
            
            if (map1 && map2 && mapPlaceholder) {
                if (subTheme && indicator && indicator.map1_url) {
                    map1.src = indicator.map1_url;
                    // Show map1, hide map2
                    map1.style.display = 'block';
                    map2.style.display = 'none';
                    exploreLabel.classList.add('active');
                    analyzeLabel.classList.remove('active');
                    toggleSwitch.checked = false;
                    currentView = 'explore';
                } else {
                    // Show map2, hide map1
                    map1.style.display = 'none';
                    map2.style.display = 'block';
                    exploreLabel.classList.remove('active');
                    analyzeLabel.classList.add('active');
                    toggleSwitch.checked = true;
                    currentView = 'analyze';
                }
            }

            toggleSwitch.addEventListener('change', function() {
                if (this.checked) {
                    switchView('analyze');
                } else {
                    switchView('explore');
                }
            });

            // Also make the labels clickable
            exploreLabel.addEventListener('click', function() {
                if (currentView !== 'explore') {
                    switchView('explore');
                }
            });

            analyzeLabel.addEventListener('click', function() {
                if (currentView !== 'analyze') {
                    switchView('analyze');
                }
            });

            // Fetch WordPress posts with tag 'indicator one'
            const postsContainer = document.getElementById('postsList');
            const loadingElement = document.getElementById('loadingPosts');
            
            // Debug function to log API responses
            async function debugFetch(url) {
                try {
                    console.log('Fetching:', url);
                    const response = await fetch(url);
                    const data = await response.json();
                    console.log('Response from', url, ':', data);
                    return { response, data };
                } catch (error) {
                    console.error('Error in debugFetch:', error);
                    throw error;
                }
            }
            
            // Function to format date
            function formatDate(dateString) {
                const options = { year: 'numeric', month: 'long', day: 'numeric' };
                return new Date(dateString).toLocaleDateString(undefined, options);
            }
            
            // Function to strip HTML tags and limit excerpt length
            function stripHtml(html, maxLength = 100) {
                const tmp = document.createElement('div');
                tmp.innerHTML = html;
                let text = tmp.textContent || tmp.innerText || '';
                
                // Trim and limit length
                text = text.trim();
                if (text.length > maxLength) {
                    text = text.substring(0, maxLength).trim() + '...';
                }
                return text;
            }

            // Function to create a clean excerpt from content
            function createExcerpt(html) {
                if (!html) return '';
                // Create temporary element to parse HTML
                const tmp = document.createElement('div');
                tmp.innerHTML = html;
                // Get text content and clean it up
                let text = tmp.textContent || tmp.innerText || '';
                // Remove any 'Time to read' patterns
                text = text.replace(/Time\s*to\s*read[^\w]*/gi, '');
                // Clean up the text
                return text
                    .replace(/\s+/g, ' ')      // Replace multiple spaces
                    .trim()                     // Trim whitespace
                    .substring(0, 150)          // Limit length
                    .replace(/\s+\S*$/, '')    // Cut at word boundary
                    .replace(/[\-|:]+$/, '') // Remove trailing punctuation
                    .trim() + '...';            // Add ellipsis
            }

            // Store carousel state to prevent memory leaks
            let carouselState = {
                resizeObserver: null,
                resizeTimeout: null,
                currentIndex: 0,
                cardWidth: 0,
                cards: []
            };

            // Clean up event listeners and observers
            function cleanupCarousel() {
                if (carouselState.resizeObserver) {
                    carouselState.resizeObserver.disconnect();
                }
                window.removeEventListener('resize', handleResize);
                clearTimeout(carouselState.resizeTimeout);
            }

            // Debounced resize handler
            function handleResize() {
                clearTimeout(carouselState.resizeTimeout);
                carouselState.resizeTimeout = setTimeout(() => {
                    updateCarouselSize();
                    updateCarouselPosition();
                }, 100);
            }

            // Update carousel size and card measurements
            function updateCarouselSize() {
                const carousel = document.getElementById('carousel');
                if (!carousel || !carouselState.cards.length) return;
                
                const card = carouselState.cards[0];
                const cardStyle = window.getComputedStyle(card);
                carouselState.cardWidth = card.offsetWidth + 
                    parseInt(cardStyle.marginLeft) + 
                    parseInt(cardStyle.marginRight);
                
                updateCarouselPosition();
            }

            // Update carousel position
            function updateCarouselPosition() {
                const carousel = document.getElementById('carousel');
                if (!carousel) return;
                
                carousel.scrollTo({
                    left: carouselState.currentIndex * carouselState.cardWidth,
                    behavior: 'smooth'
                });
                updateButtons();
            }

            // Update navigation buttons
            function updateButtons() {
                const prevBtn = document.getElementById('prevBtn');
                const nextBtn = document.getElementById('nextBtn');
                if (!prevBtn || !nextBtn) return;
                
                prevBtn.style.display = carouselState.currentIndex === 0 ? 'none' : 'flex';
                nextBtn.style.display = carouselState.currentIndex >= carouselState.cards.length - 1 ? 'none' : 'flex';
            }

            // Initialize carousel
            function initCarousel() {
                cleanupCarousel();
                
                const carousel = document.getElementById('carousel');
                const prevBtn = document.getElementById('prevBtn');
                const nextBtn = document.getElementById('nextBtn');
                
                if (!carousel || !prevBtn || !nextBtn) {
                    console.warn('Carousel elements not found');
                    return;
                }
                
                carouselState.cards = Array.from(document.querySelectorAll('.post-card'));
                if (!carouselState.cards.length) return;
                
                // Initial setup
                updateCarouselSize();
                updateButtons();
                
                // Event listeners
                prevBtn.addEventListener('click', () => {
                    if (carouselState.currentIndex > 0) {
                        carouselState.currentIndex--;
                        updateCarouselPosition();
                    }
                });
                
                nextBtn.addEventListener('click', () => {
                    if (carouselState.currentIndex < carouselState.cards.length - 1) {
                        carouselState.currentIndex++;
                        updateCarouselPosition();
                    }
                });
                
                // Resize observer for better performance
                carouselState.resizeObserver = new ResizeObserver(handleResize);
                carouselState.resizeObserver.observe(document.body);
                
                // Initial position
                updateCarouselPosition();
            }

            // Fetch posts from WordPress REST API with improved error handling
            async function fetchWordPressPosts(indicator) {
                const postsContainer = document.getElementById('posts-container');
                const loadingElement = document.getElementById('loading-indicator');
                
                // Clean up previous carousel
                cleanupCarousel();
                
                // Reset state
                carouselState = {
                    resizeObserver: null,
                    resizeTimeout: null,
                    currentIndex: 0,
                    cardWidth: 0,
                    cards: []
                };
                
                // Show loading state
                if (loadingElement) loadingElement.style.display = 'block';
                if (postsContainer) {
                    postsContainer.innerHTML = '';
                    postsContainer.style.display = 'block';
                }
                
                try {
                    if (!indicator || !indicator.posts) {
                        console.log('No posts filter defined for this indicator');
                        if (postsContainer) postsContainer.innerHTML = '<p>No posts configuration found for this indicator.</p>';
                        return;
                    }

                    // Convert the posts string to a slug format
                    const tagSlug = indicator.posts.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/(^-|-$)/g, '');
                    console.log('Searching for WordPress posts with tag slug:', tagSlug);
                    
                    // Add timeout for the fetch request
                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => controller.abort(), 10000); // 10 second timeout
                    
                    // First, get the tag ID for the indicator's posts
                    const tagResponse = await fetch(
                        `https://newdev.naturesquamish.ca/wp-json/wp/v2/tags?slug=${tagSlug}`,
                        { signal: controller.signal }
                    );
                    clearTimeout(timeoutId);
                    
                    if (!tagResponse.ok) {
                        throw new Error(`HTTP error! status: ${tagResponse.status}`);
                    }
                    
                    const tags = await tagResponse.json();
                    console.log('Found matching tags:', tags);
                    
                    if (!tags || tags.length === 0) {
                        console.warn(`No matching tags found for: ${tagSlug}`);
                        if (postsContainer) postsContainer.innerHTML = `<p>No posts found for: ${indicator.posts}</p>`;
                        return;
                    }
                    
                    const tagId = tags[0].id;
                    console.log(`Found tag ID ${tagId} for "${tagSlug}"`);
                    
                    // Fetch posts with excerpts and featured image
                    const postsResponse = await fetch(
                        `https://newdev.naturesquamish.ca/wp-json/wp/v2/posts?tags=${tagId}` +
                        `&_fields=id,title,link,date,excerpt,featured_media` +
                        `&_embed=wp:featuredmedia` +
                        `&per_page=3`,
                        { signal: controller.signal }
                    );
                    
                    if (!postsResponse.ok) {
                        throw new Error(`Failed to fetch posts: ${postsResponse.statusText}`);
                    }
                    
                    const posts = await postsResponse.json();
                    console.log(`Fetched ${posts.length} posts for tag ID ${tagId}`);
                    
                    if (posts.length === 0) {
                        if (postsContainer) postsContainer.innerHTML = '<p>No updates available at the moment.</p>';
                        return;
                    }
                    
                    // Generate HTML for each post
                    const postsHtml = `
                        <div class="carousel-container" id="carousel">
                            ${posts.map(post => {
                                const featuredImage = post._embedded?.['wp:featuredmedia']?.[0]?.source_url || '';
                                // Use WordPress excerpt directly and clean it up
                                let excerpt = post.excerpt?.rendered ? stripHtml(post.excerpt.rendered) : 'No description available';
                                // Add space after 'Time to read' if it exists
                                excerpt = excerpt.replace(/(Time\s*to\s*read[^<]*)([^\s])/gi, '$1 $2');
                                
                                return `
                                    <article class="post-card">
                                        ${featuredImage ? `<div class="post-image" style="background-image: url('${featuredImage}')"></div>` : ''}
                                        <div class="post-content">
                                            <h3 class="post-title">${post.title.rendered}</h3>
                                            <div class="post-meta">Posted on ${formatDate(post.date)}</div>
                                            ${excerpt ? `<p class="post-excerpt">${excerpt}</p>` : ''}
                                            <a href="${post.link}" class="post-link" target="_blank" rel="noopener noreferrer">Read more </a>
                                        </div>
                                    </article>
                                `;
                            }).join('')}
                        </div>
                        <button id="prevBtn" class="carousel-nav prev" aria-label="Previous"></button>
                        <button id="nextBtn" class="carousel-nav next" aria-label="Next"></button>
                    `;
            
                    // Initialize carousel after posts are loaded
                    if (postsContainer) {
                        // Use requestAnimationFrame for smoother updates
                        requestAnimationFrame(() => {
                            postsContainer.innerHTML = postsHtml;
                            
                            // Initialize carousel on next frame
                            requestAnimationFrame(() => {
                                initCarousel();
                                
                                // Force a reflow to ensure styles are applied
                                void postsContainer.offsetHeight;
                                
                                // Show the container
                                postsContainer.style.opacity = '1';
                            });
                        });
                    }
                    
                    
                } catch (error) {
                    console.error('Error fetching WordPress posts:', error);
                    const errorMessage = error.name === 'AbortError' 
                        ? 'Request timed out. Please check your connection and try again.'
                        : 'Unable to load updates at this time. Please try again later.';
                    
                    if (postsContainer) {
                        postsContainer.innerHTML = `
                            <div class="error-message">
                                <p>${errorMessage}</p>
                                <button onclick="window.location.reload()" class="retry-button">
                                    <i class="fas fa-sync-alt"></i> Retry
                                </button>
                            </div>
                        `;
                    }
                } finally {
                    if (loadingElement) loadingElement.style.display = 'none';
                }
            }
            
            // Fetch posts when the page loads with the current indicator's data
            const currentIndicator = {
                posts: '',
                title: ''
            };
            fetchWordPressPosts(currentIndicator);
        });
    </script>
</body>
</html>
